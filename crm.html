<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”æ‘©æˆ°æƒ…å®¤ (CRM V11.0)</title>
    <style>
        :root {
            --bg-color: #121820; --panel-bg: #1e2732; --gold: #d4af37;
            --bronze: #8c7853; --cyan: #4fd1c5; --danger: #ff4d4d;
            --text-main: #e0e0e0; --text-sub: #a0a0a0;
        }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: "Microsoft JhengHei", serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* é ‚éƒ¨å°èˆªå€ */
        .header { width: 100%; max-width: 1400px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--gold); padding-bottom: 15px; }
        .title { font-size: 1.8em; color: var(--gold); font-weight: bold; letter-spacing: 3px; display: flex; align-items: center; gap: 10px; }
        .back-btn { background: transparent; border: 1px solid var(--cyan); color: var(--cyan); padding: 8px 20px; border-radius: 4px; cursor: pointer; font-size: 1em; transition: all 0.3s; text-decoration: none; display: flex; align-items: center; gap: 5px; }
        .back-btn:hover { background: rgba(79, 209, 197, 0.1); transform: translateX(-5px); }

        /* æœå°‹èˆ‡éæ¿¾å€ */
        .filter-bar { width: 100%; max-width: 1400px; background: var(--panel-bg); padding: 20px; border-radius: 8px; border: 1px solid #444; display: flex; gap: 15px; margin-bottom: 20px; box-sizing: border-box; align-items: flex-end; }
        .search-group { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .search-group label { color: var(--cyan); font-size: 0.9em; font-weight: bold; }
        .search-input { background: #121820; border: 1px solid #555; color: white; padding: 10px; border-radius: 4px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        .action-btn { background: linear-gradient(135deg, var(--bronze), var(--gold)); border: none; color: #1a2634; padding: 10px 25px; border-radius: 4px; font-weight: bold; cursor: pointer; height: 42px; display: flex; align-items: center; gap: 5px; }
        .action-btn:hover { filter: brightness(1.15); }

        /* è³‡æ–™åˆ—è¡¨å€ (Table) */
        .table-container { width: 100%; max-width: 1400px; background: var(--panel-bg); border-radius: 8px; border: 1px solid #444; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        thead { background: #252f3a; color: var(--cyan); font-weight: bold; }
        th { padding: 15px; border-bottom: 2px solid var(--gold); white-space: nowrap; }
        td { padding: 15px; border-bottom: 1px solid #333; color: #ddd; vertical-align: middle; }
        tr:hover { background: rgba(212, 175, 55, 0.05); }
        
        /* æ¬„ä½æ¨£å¼ */
        .col-date { color: #888; font-size: 0.9em; font-family: monospace; }
        .col-name { font-size: 1.1em; font-weight: bold; color: #fff; }
        .col-chart { font-size: 0.9em; color: #bbb; display: flex; align-items: center; gap: 5px; }
        .gender-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        .gender-m { background: rgba(79, 209, 197, 0.2); color: var(--cyan); border: 1px solid var(--cyan); }
        .gender-f { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; border: 1px solid #ff6b6b; }
        .col-phone { font-family: monospace; color: var(--gold); letter-spacing: 1px; }
        .col-note { max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #888; font-style: italic; }
        
        /* æ¨™ç±¤ */
        .tag-pill { display: inline-block; background: #333; border: 1px solid #555; color: #aaa; padding: 2px 8px; border-radius: 10px; font-size: 0.75em; margin-right: 4px; }
        .tag-vip { border-color: var(--gold); color: var(--gold); background: rgba(212, 175, 55, 0.1); }

        /* æ“ä½œæŒ‰éˆ• */
        .op-btn { border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: bold; transition: all 0.2s; margin-right: 5px; }
        .btn-load { background: var(--cyan); color: #1a2634; }
        .btn-load:hover { box-shadow: 0 0 10px var(--cyan); }
        .btn-edit { background: #4a5568; color: #fff; }
        .btn-edit:hover { background: #718096; }
        .btn-del { background: transparent; border: 1px solid var(--danger); color: var(--danger); }
        .btn-del:hover { background: var(--danger); color: white; }

        /* è®€å–å‹•ç•« */
        #loading { text-align: center; padding: 40px; color: #888; display: none; }
        .spinner { display: inline-block; width: 30px; height: 30px; border: 3px solid #333; border-top: 3px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ç·¨è¼¯è¦–çª— */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { background: var(--panel-bg); border: 1px solid var(--gold); padding: 30px; border-radius: 8px; width: 500px; max-width: 90%; }
        .form-group { margin-bottom: 15px; }
        textarea { width: 100%; background: #121820; border: 1px solid #555; color: white; padding: 10px; border-radius: 4px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

    </style>
</head>
<body>

<div class="header">
    <div class="title">
        <span>ğŸ“œ</span> é”æ‘©æˆ°æƒ…å®¤ <span style="font-size:0.5em; color:#666; margin-top:10px; margin-left:10px;">CRM V11.0</span>
    </div>
    <a href="/" class="back-btn">â‡¦ è¿”å›æ¨æ¼”ç›¤</a>
</div>

<div class="filter-bar">
    <div class="search-group">
        <label>ğŸ” é—œéµå­—æœå°‹</label>
        <input type="text" id="searchInput" class="search-input" placeholder="è¼¸å…¥å§“åã€é›»è©±æˆ–å‚™è¨»..." onkeypress="if(event.key==='Enter') loadData()">
    </div>
    <button class="action-btn" onclick="loadData()">æœå°‹å®¢æˆ¶</button>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th width="10%">è«®è©¢æ—¥æœŸ</th>
                <th width="12%">å®¢æˆ¶å§“å</th>
                <th width="15%">æœ¬å‘½åƒæ•¸</th>
                <th width="12%">è¯çµ¡é›»è©±</th>
                <th width="25%">æˆ°ç•¥ç­†è¨˜ & æ¨™ç±¤</th>
                <th width="20%">æˆ°è¡“è¡Œå‹•</th>
            </tr>
        </thead>
        <tbody id="crmTableBody">
            </tbody>
    </table>
    <div id="loading"><div class="spinner"></div><br>æ­£åœ¨è®€å–å·å®—...</div>
    <div id="emptyMsg" style="text-align:center; padding:40px; color:#666; display:none;">
        ğŸ“­ æŸ¥ç„¡è³‡æ–™ï¼Œè«‹å…ˆè‡³é¦–é å»ºç«‹å®¢æˆ¶æª”æ¡ˆã€‚
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--gold); border-bottom:1px solid #444; padding-bottom:10px; margin-top:0;">âœï¸ ç·¨è¼¯å®¢æˆ¶è³‡æ–™</h3>
        <input type="hidden" id="editId">
        <div class="form-group">
            <label>å®¢æˆ¶å§“å</label>
            <input type="text" id="editName" class="search-input">
        </div>
        <div class="form-group">
            <label>è¯çµ¡é›»è©±</label>
            <input type="text" id="editPhone" class="search-input">
        </div>
        <div class="form-group">
            <label>å‚™è¨»ç­†è¨˜</label>
            <textarea id="editNote" rows="4"></textarea>
        </div>
        <div class="modal-footer">
            <button class="op-btn btn-del" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="action-btn" onclick="saveEdit()">ç¢ºèªæ›´æ–°</button>
        </div>
    </div>
</div>

<script>
    // åˆå§‹åŒ–
    window.onload = function() {
        loadData();
    };

    async function loadData() {
        const keyword = document.getElementById('searchInput').value;
        const tbody = document.getElementById('crmTableBody');
        const loading = document.getElementById('loading');
        const emptyMsg = document.getElementById('emptyMsg');

        tbody.innerHTML = '';
        loading.style.display = 'block';
        emptyMsg.style.display = 'none';

        try {
            // å‘¼å« V10.3.3 çš„å¾Œç«¯ API
            const res = await fetch(`/api/search_records?keyword=${encodeURIComponent(keyword)}`);
            const data = await res.json();
            
            loading.style.display = 'none';
            if (!data || data.length === 0) {
                emptyMsg.style.display = 'block';
                return;
            }

            // æ¸²æŸ“åˆ—è¡¨ (List Mode)
            data.forEach(item => {
                const tr = document.createElement('tr');
                
                // 1. æ—¥æœŸ
                const dateStr = item.created_at || '-';
                
                // 2. æœ¬å‘½åƒæ•¸ (æ€§åˆ¥/ç”Ÿè¾°)
                const genderBadge = item.gender === 1 
                    ? `<span class="gender-badge gender-m">ä¹¾é€ (ç”·)</span>` 
                    : `<span class="gender-badge gender-f">å¤é€ (å¥³)</span>`;
                const birthInfo = `${item.solar_date} [${item.hour}æ™‚]`;

                // 3. æ¨™ç±¤è™•ç†
                let tagsHtml = '';
                if(item.tags && item.tags.length > 0) {
                    item.tags.forEach(t => {
                        const isVip = t.toLowerCase().includes('vip');
                        tagsHtml += `<span class="tag-pill ${isVip?'tag-vip':''}">${t}</span>`;
                    });
                }

                tr.innerHTML = `
                    <td class="col-date">${dateStr}</td>
                    <td class="col-name">${item.client_name || 'è²´è³“'}</td>
                    <td class="col-chart">
                        ${genderBadge} <br>
                        ${birthInfo}
                    </td>
                    <td class="col-phone">${item.phone || '-'}</td>
                    <td class="col-note">
                        <div style="margin-bottom:5px;">${tagsHtml}</div>
                        ${item.note || '<span style="opacity:0.3">ç„¡ç­†è¨˜</span>'}
                    </td>
                    <td>
                        <button class="op-btn btn-load" onclick='restoreRecord(${JSON.stringify(item)})'>ğŸ“‚ å¾©ç›¤æ¨æ¼”</button>
                        <button class="op-btn btn-edit" onclick='openEdit(${JSON.stringify(item)})'>âœï¸</button>
                        <button class="op-btn btn-del" onclick="deleteRecord('${item.id}')">ğŸ—‘ï¸</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

        } catch (e) {
            console.error(e);
            loading.innerText = "âŒ è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯é€£ç·š";
        }
    }

    // [æ ¸å¿ƒæˆ°ç•¥åŠŸèƒ½] ä¸€éµå¾©ç›¤
    function restoreRecord(item) {
        // å°‡è³‡æ–™å­˜å…¥ LocalStorageï¼Œé€™å°±åƒæ˜¯æŠŠæª”æ¡ˆæ”¾é€²ã€Œå…¬äº‹åŒ…ã€
        localStorage.setItem('damo_restore_data', JSON.stringify(item));
        // è·³è½‰å›é¦–é ï¼Œé¦–é çš„ window.onload æœƒæ‰“é–‹å…¬äº‹åŒ…ä¸¦è‡ªå‹•å¡«è¡¨
        window.location.href = '/';
    }

    // åˆªé™¤åŠŸèƒ½
    async function deleteRecord(id) {
        if(!confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤æ­¤å®¢æˆ¶è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) return;
        try {
            await fetch(`/api/delete_record/${id}`, { method: 'DELETE' });
            loadData(); // é‡æ–°æ•´ç†
        } catch(e) { alert("åˆªé™¤å¤±æ•—"); }
    }

    // ç·¨è¼¯åŠŸèƒ½
    function openEdit(item) {
        document.getElementById('editId').value = item.id;
        document.getElementById('editName').value = item.client_name || '';
        document.getElementById('editPhone').value = item.phone || '';
        document.getElementById('editNote').value = item.note || '';
        document.getElementById('editModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    async function saveEdit() {
        const id = document.getElementById('editId').value;
        const data = {
            client_name: document.getElementById('editName').value,
            phone: document.getElementById('editPhone').value,
            note: document.getElementById('editNote').value
        };
        try {
            await fetch(`/api/update_record/${id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            closeModal();
            loadData();
        } catch(e) { alert("æ›´æ–°å¤±æ•—"); }
    }
    
    // é»æ“Šè¦–çª—å¤–éƒ¨é—œé–‰
    window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target == modal) modal.style.display = "none";
    }
</script>

</body>
</html>
