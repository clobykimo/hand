<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”æ‘©å®¢æˆ¶æˆ°æƒ…å®¤ (ç”Ÿæ…‹ç³»ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --bg: #121820; --panel: #1e2732; --gold: #d4af37; --cyan: #4fd1c5; --danger: #ff4d4d; --text: #e0e0e0; }
        body { background-color: var(--bg); color: var(--text); font-family: "Microsoft JhengHei", serif; margin: 0; padding: 20px; display: flex; gap: 20px; }
        
        .main-content { flex: 1; }
        .sidebar { width: 300px; background: var(--panel); border-radius: 8px; border: 1px solid #444; padding: 20px; height: 90vh; position: sticky; top: 20px; display:none; }
        @media (min-width: 1200px) { .sidebar { display: block; } }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid var(--gold); padding-bottom: 15px; }
        h1 { margin: 0; color: var(--gold); letter-spacing: 2px; font-size: 1.8em; }
        .btn { background: #333; color: #ddd; border: 1px solid #555; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: linear-gradient(135deg, #8c7853, var(--gold)); color: #1a2634; border: none; }
        .btn-danger { color: var(--danger); border-color: var(--danger); }
        
        .search-area { display: flex; gap: 10px; margin-bottom: 25px; background: var(--panel); padding: 15px; border-radius: 8px; border: 1px solid #444; }
        input, select { padding: 10px; background: #111; border: 1px solid #555; color: white; border-radius: 4px; outline: none; }
        input[type="text"] { flex: 1; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .card { background: var(--panel); border: 1px solid #444; border-radius: 8px; padding: 20px; transition: all 0.3s ease; cursor: pointer; }
        .card:hover { transform: translateY(-5px); border-color: var(--gold); }
        .card-head { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .name { font-size: 1.2em; font-weight: bold; color: var(--gold); }
        .note { color: #ccc; font-size: 0.9em; height: 3em; overflow: hidden; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        .modal-box { background: #1e2732; width: 90%; max-width: 900px; height: 90vh; border-radius: 8px; border: 1px solid var(--gold); display: flex; flex-direction: column; }
        .modal-head { padding: 15px 20px; border-bottom: 1px solid #444; background: #151b24; display:flex; justify-content:space-between; align-items:center; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        
        .alert-banner { background: rgba(255, 77, 77, 0.2); border: 1px solid var(--danger); color: #ffcccc; padding: 10px; margin-bottom: 15px; border-radius: 4px; display: none; }
        .consent-status { padding: 10px; background: #111; border-radius: 4px; display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        .status-badge { padding: 4px 10px; border-radius: 10px; font-size: 0.8em; font-weight: bold; }
        .status-signed { background: var(--cyan); color: #000; }
        .status-unsigned { background: #555; color: #ccc; }
        #qrcode { background: white; padding: 10px; width: fit-content; margin: 10px auto; display: none; }

        .tabs { display: flex; border-bottom: 1px solid #444; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; color: #888; border-bottom: 3px solid transparent; font-weight: bold; }
        .tab.active { color: var(--gold); border-color: var(--gold); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .rel-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .rel-table th { text-align: left; color: #888; border-bottom: 1px solid #444; padding: 5px; }
        .rel-table td { padding: 8px 5px; border-bottom: 1px solid #333; color: #eee; }
        .add-rel-form { display: grid; grid-template-columns: 1fr 1fr 1fr 0.5fr 0.5fr auto; gap: 5px; background: #111; padding: 10px; border-radius: 4px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="main-content">
    <div class="header">
        <h1>ğŸ“‚ é”æ‘©å®¢æˆ¶æˆ°æƒ…å®¤ <span style="font-size:0.5em; color:#666;">(V7.1 æœ€çµ‚ç‰ˆ)</span></h1>
        <a href="/" class="btn">â¬… è¿”å›æ’ç›¤</a>
    </div>
    <div class="search-area">
        <input type="text" id="searchInput" placeholder="æœå°‹..." onkeypress="if(event.key==='Enter') searchData()">
        <button class="btn btn-primary" onclick="searchData()">ğŸ” æœå°‹</button>
    </div>
    <div id="dataGrid" class="grid"></div>
</div>

<div class="sidebar">
    <div style="color:var(--cyan); font-weight:bold; border-bottom:1px solid #444; padding-bottom:10px; margin-bottom:10px;">ğŸ“… å¾…è¾¦äº‹é …</div>
    <ul style="list-style:none; padding:0; color:#aaa; font-size:0.9em;">
        <li style="margin-bottom:10px;">ğŸ‚ [ç”Ÿæ—¥] é™³å¤§ç™¼ (æ˜å¤©)</li>
        <li>ğŸ“ [æ•´ç†] æ˜¨æ—¥è«®è©¢ç­†è¨˜</li>
    </ul>
</div>

<div id="detailModal" class="modal">
    <div class="modal-box">
        <div class="modal-head">
            <h2 class="name" id="mName">å®¢æˆ¶å§“å</h2>
            <button class="btn" style="border:none; font-size:1.5em;" onclick="closeModal()">Ã—</button>
        </div>
        
        <div class="modal-body">
            <div id="riskBanner" class="alert-banner">âš ï¸ <strong>å®¶æ—é è­¦ï¼š</strong> <span id="riskText"></span></div>

            <div class="consent-status">
                <div><span>æ•¸ä½åŒæ„æ›¸ï¼š</span><span id="consentBadge" class="status-badge status-unsigned">æœªç°½ç½²</span></div>
                <button class="btn btn-primary" style="font-size:0.8em;" onclick="generateConsent()">ç”¢ç”Ÿç°½ç½²é€£çµ</button>
            </div>
            <div id="qrcode"></div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('basic')">ğŸ“Š ç´€éŒ„</div>
                <div class="tab" onclick="switchTab('relation')">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶æ—è„ˆçµ¡</div>
                <div class="tab" onclick="switchTab('media')">ğŸ™ï¸ å¤šåª’é«”</div>
            </div>

            <div id="tab-basic" class="tab-content active">
                <textarea id="mNote" style="width:100%; height:150px; background:#111; color:#ddd; border:1px solid #444; padding:10px;"></textarea>
                <div style="text-align:right; margin-top:5px;"><button class="btn btn-primary" onclick="updateNote()">ğŸ’¾ æ›´æ–°å­˜æª”</button></div>
            </div>

            <div id="tab-relation" class="tab-content">
                <table class="rel-table">
                    <thead><tr><th>é—œä¿‚</th><th>å§“å</th><th>ç”Ÿæ—¥</th><th>æ€§åˆ¥</th><th>æ™‚è¾°</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="relList"></tbody>
                </table>
                <div class="add-rel-form">
                    <input type="text" id="relRelation" placeholder="é—œä¿‚">
                    <input type="text" id="relName" placeholder="å§“å">
                    <input type="date" id="relDate">
                    <select id="relGender"><option value="1">ç”·</option><option value="0">å¥³</option></select>
                    <select id="relHour"><option value="å­">å­</option><option value="ä¸‘">ä¸‘</option><option value="å¯…">å¯…</option><option value="å¯">å¯</option><option value="è¾°">è¾°</option><option value="å·³">å·³</option><option value="åˆ">åˆ</option><option value="æœª">æœª</option><option value="ç”³">ç”³</option><option value="é…‰">é…‰</option><option value="æˆŒ">æˆŒ</option><option value="äº¥">äº¥</option></select>
                    <button class="btn btn-primary" onclick="addRelation()">+</button>
                </div>
            </div>

            <div id="tab-media" class="tab-content">
                <div style="text-align:center; padding:20px; color:#666;">(è«‹ä½¿ç”¨ V6.2 ç‰ˆçš„å®Œæ•´åŠŸèƒ½)</div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentData = [];
    let selectedItem = null;

    async function searchData() {
        const keyword = document.getElementById('searchInput').value;
        const res = await fetch(`/api/search_records?keyword=${encodeURIComponent(keyword)}`);
        currentData = await res.json();
        const grid = document.getElementById('dataGrid');
        grid.innerHTML = currentData.map((item, i) => `
            <div class="card" onclick="openDetail(${i})">
                <div class="card-head"><span class="name">${item.client_name}</span><span class="date">${item.created_at.split(' ')[0]}</span></div>
                <div class="note">${item.note||'ç„¡'}</div>
            </div>`).join('');
    }

    async function openDetail(index) {
        selectedItem = currentData[index];
        document.getElementById('mName').innerText = selectedItem.client_name;
        document.getElementById('mNote').value = selectedItem.note || '';
        
        const badge = document.getElementById('consentBadge');
        if(selectedItem.consent_signed) { badge.innerText="å·²ç°½ç½²"; badge.className="status-badge status-signed"; }
        else { badge.innerText="æœªç°½ç½²"; badge.className="status-badge status-unsigned"; }
        document.getElementById('qrcode').style.display = "none";

        renderRelations();
        await scanRisks();
        switchTab('basic');
        document.getElementById('detailModal').style.display = 'flex';
    }

    function renderRelations() {
        const list = document.getElementById('relList');
        const rels = selectedItem.relations || [];
        list.innerHTML = rels.map((r, i) => `
            <tr><td>${r.relation}</td><td>${r.name}</td><td>${r.solar_date}</td><td>${r.gender==1?'ç”·':'å¥³'}</td><td>${r.hour}</td>
            <td><button class="btn btn-danger" style="padding:2px 6px; font-size:0.7em;" onclick="removeRel(${i})">Ã—</button></td></tr>`).join('');
    }

    function addRelation() {
        if(!selectedItem.relations) selectedItem.relations = [];
        selectedItem.relations.push({
            relation: document.getElementById('relRelation').value,
            name: document.getElementById('relName').value,
            solar_date: document.getElementById('relDate').value,
            gender: parseInt(document.getElementById('relGender').value),
            hour: document.getElementById('relHour').value
        });
        renderRelations();
        updateNote(true);
    }

    function removeRel(i) {
        selectedItem.relations.splice(i, 1);
        renderRelations();
        updateNote(false);
    }

    // [æ ¸å¿ƒä¿®å¾©] ä½¿ç”¨ update_record é¿å…é‡è¤‡
    async function updateNote(autoScan=false) {
        selectedItem.note = document.getElementById('mNote').value;
        try {
            await fetch(`/api/update_record/${selectedItem.id}`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(selectedItem)});
            if(autoScan) await scanRisks();
            else alert("è³‡æ–™å·²æ›´æ–°");
        } catch(e) { console.error(e); }
    }

    async function scanRisks() {
        if(!selectedItem.relations || selectedItem.relations.length === 0) return;
        const banner = document.getElementById('riskBanner');
        try {
            const res = await fetch('/api/scan_family_risks', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(selectedItem)});
            const result = await res.json();
            if(result.alerts && result.alerts.length > 0) {
                document.getElementById('riskText').innerText = result.alerts.map(a => `${a.relation}${a.name}(${a.risk})`).join('ã€');
                banner.style.display = 'block';
            } else { banner.style.display = 'none'; }
        } catch(e) { console.error(e); }
    }

    function generateConsent() {
        const qrDiv = document.getElementById('qrcode');
        qrDiv.innerHTML = ""; qrDiv.style.display = "block";
        new QRCode(qrDiv, { text: `${window.location.origin}/consent_page?id=${selectedItem.id}`, width: 128, height: 128 });
    }

    function closeModal() { document.getElementById('detailModal').style.display = 'none'; }
    function switchTab(t) {
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
        document.getElementById(`tab-${t}`).classList.add('active');
    }

    searchData();
</script>

</body>
</html>
