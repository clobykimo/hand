<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”æ‘©æˆ°æƒ…å®¤ (CRM V12.0 å®¶æ—æˆ°ç•¥ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --bg-color: #121820; --panel-bg: #1e2732; --gold: #d4af37;
            --bronze: #8c7853; --cyan: #4fd1c5; --danger: #ff4d4d;
            --text-main: #e0e0e0; --text-sub: #a0a0a0;
        }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: "Microsoft JhengHei", serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* [V11.0] é ‚éƒ¨å°èˆªèˆ‡æœå°‹ */
        .header { width: 100%; max-width: 1400px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--gold); padding-bottom: 15px; }
        .title { font-size: 1.8em; color: var(--gold); font-weight: bold; letter-spacing: 3px; display: flex; align-items: center; gap: 10px; }
        .back-btn { background: transparent; border: 1px solid var(--cyan); color: var(--cyan); padding: 8px 20px; border-radius: 4px; cursor: pointer; font-size: 1em; transition: all 0.3s; text-decoration: none; display: flex; align-items: center; gap: 5px; }
        .back-btn:hover { background: rgba(79, 209, 197, 0.1); transform: translateX(-5px); }

        .filter-bar { width: 100%; max-width: 1400px; background: var(--panel-bg); padding: 20px; border-radius: 8px; border: 1px solid #444; display: flex; gap: 15px; margin-bottom: 20px; box-sizing: border-box; align-items: flex-end; }
        .search-group { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .search-group label { color: var(--cyan); font-size: 0.9em; font-weight: bold; }
        .search-input { background: #121820; border: 1px solid #555; color: white; padding: 10px; border-radius: 4px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        .action-btn { background: linear-gradient(135deg, var(--bronze), var(--gold)); border: none; color: #1a2634; padding: 10px 25px; border-radius: 4px; font-weight: bold; cursor: pointer; height: 42px; display: flex; align-items: center; gap: 5px; justify-content: center;}
        .action-btn:hover { filter: brightness(1.15); }

        /* [V11.0] è³‡æ–™åˆ—è¡¨å€ */
        .table-container { width: 100%; max-width: 1400px; background: var(--panel-bg); border-radius: 8px; border: 1px solid #444; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        thead { background: #252f3a; color: var(--cyan); font-weight: bold; }
        th { padding: 15px; border-bottom: 2px solid var(--gold); white-space: nowrap; }
        td { padding: 15px; border-bottom: 1px solid #333; color: #ddd; vertical-align: middle; }
        tr:hover { background: rgba(212, 175, 55, 0.05); }
        
        .col-date { color: #888; font-size: 0.9em; font-family: monospace; }
        .col-name { font-size: 1.1em; font-weight: bold; color: #fff; }
        .col-chart { font-size: 0.9em; color: #bbb; }
        .gender-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        .gender-m { background: rgba(79, 209, 197, 0.2); color: var(--cyan); border: 1px solid var(--cyan); }
        .gender-f { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; border: 1px solid #ff6b6b; }
        .col-phone { font-family: monospace; color: var(--gold); letter-spacing: 1px; }
        .col-note { max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #888; font-style: italic; }
        .tag-pill { display: inline-block; background: #333; border: 1px solid #555; color: #aaa; padding: 2px 8px; border-radius: 10px; font-size: 0.75em; margin-right: 4px; }
        .tag-vip { border-color: var(--gold); color: var(--gold); background: rgba(212, 175, 55, 0.1); }

        .op-btn { border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: bold; transition: all 0.2s; margin-right: 5px; }
        .btn-load { background: var(--cyan); color: #1a2634; }
        .btn-load:hover { box-shadow: 0 0 10px var(--cyan); }
        .btn-edit { background: #4a5568; color: #fff; }
        .btn-edit:hover { background: #718096; }
        .btn-del { background: transparent; border: 1px solid var(--danger); color: var(--danger); }
        .btn-del:hover { background: var(--danger); color: white; }

        /* [V12.0] å…¨åŠŸèƒ½æª”æ¡ˆå¤¾ Modal (ç§»æ¤è‡ª V7.1) */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        .modal-content { background: var(--panel-bg); border: 1px solid var(--gold); width: 900px; max-width: 95%; height: 85vh; border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .modal-header { padding: 20px; border-bottom: 1px solid #444; background: #151b24; display: flex; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0; }
        .modal-title { margin: 0; color: var(--gold); font-size: 1.5em; letter-spacing: 2px; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        
        /* é ç±¤ç³»çµ± */
        .tabs { display: flex; border-bottom: 1px solid #444; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; color: #888; border-bottom: 3px solid transparent; font-weight: bold; transition: all 0.3s; }
        .tab:hover { color: #ccc; }
        .tab.active { color: var(--cyan); border-color: var(--cyan); background: rgba(79, 209, 197, 0.05); }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        
        /* [V12.0] é¢¨éšªé›·é” */
        .risk-banner { background: rgba(255, 77, 77, 0.15); border: 1px solid var(--danger); color: #ffcccc; padding: 15px; margin-bottom: 20px; border-radius: 4px; display: none; align-items: center; gap: 10px; }
        .risk-icon { font-size: 1.5em; }

        /* å®¶æ—åˆ—è¡¨ */
        .rel-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        .rel-table th { text-align: left; color: var(--cyan); border-bottom: 1px solid #444; padding: 8px; }
        .rel-table td { padding: 8px; border-bottom: 1px solid #333; color: #eee; }
        .add-rel-form { display: grid; grid-template-columns: 100px 100px 140px 60px 60px auto; gap: 10px; background: #111; padding: 15px; border-radius: 4px; margin-top: 15px; border: 1px dashed #444; }
        
        /* åŒæ„æ›¸å€å¡Š */
        .consent-section { display: flex; justify-content: space-between; align-items: center; background: #111; padding: 15px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #333; }
        .status-badge { padding: 4px 10px; border-radius: 10px; font-size: 0.8em; font-weight: bold; }
        .status-signed { background: var(--cyan); color: #000; }
        .status-unsigned { background: #555; color: #ccc; }
        #qrcode { background: white; padding: 10px; width: fit-content; margin: 10px auto; display: none; border-radius: 4px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        #loading { text-align: center; padding: 40px; color: #888; display: none; }
        .spinner { display: inline-block; width: 30px; height: 30px; border: 3px solid #333; border-top: 3px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="header">
    <div class="title">
        <span>ğŸ“œ</span> é”æ‘©æˆ°æƒ…å®¤ <span style="font-size:0.5em; color:#666; margin-top:10px; margin-left:10px;">CRM V12.0</span>
    </div>
    <a href="/" class="back-btn">â‡¦ è¿”å›æ¨æ¼”ç›¤</a>
</div>

<div class="filter-bar">
    <div class="search-group">
        <label>ğŸ” é—œéµå­—æœå°‹</label>
        <input type="text" id="searchInput" class="search-input" placeholder="è¼¸å…¥å§“åã€é›»è©±æˆ–å‚™è¨»..." onkeypress="if(event.key==='Enter') loadData()">
    </div>
    <button class="action-btn" onclick="loadData()">æœå°‹å®¢æˆ¶</button>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th width="10%">è«®è©¢æ—¥æœŸ</th>
                <th width="15%">å®¢æˆ¶å§“å</th>
                <th width="20%">æœ¬å‘½åƒæ•¸</th>
                <th width="15%">è¯çµ¡é›»è©±</th>
                <th width="20%">æˆ°ç•¥ç­†è¨˜</th>
                <th width="20%">æˆ°è¡“è¡Œå‹•</th>
            </tr>
        </thead>
        <tbody id="crmTableBody">
            </tbody>
    </table>
    <div id="loading"><div class="spinner"></div><br>æ­£åœ¨è®€å–å·å®—...</div>
    <div id="emptyMsg" style="text-align:center; padding:40px; color:#666; display:none;">
        ğŸ“­ æŸ¥ç„¡è³‡æ–™ï¼Œè«‹å…ˆè‡³é¦–é å»ºç«‹å®¢æˆ¶æª”æ¡ˆã€‚
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="mName">å®¢æˆ¶å§“å</h2>
            <button style="background:none; border:none; color:#888; font-size:2em; cursor:pointer;" onclick="closeModal()">Ã—</button>
        </div>
        
        <div class="modal-body">
            <div id="riskBanner" class="risk-banner">
                <span class="risk-icon">âš ï¸</span> 
                <div><strong>å®¶æ—é è­¦ï¼š</strong> <span id="riskText"></span></div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('basic')">ğŸ“ åŸºæœ¬è³‡æ–™</div>
                <div class="tab" onclick="switchTab('relation')">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶æ—ç”Ÿæ…‹</div>
                <div class="tab" onclick="switchTab('consent')">ğŸ›¡ï¸ æ³•å¾‹åŒæ„æ›¸</div>
            </div>

            <div id="tab-basic" class="tab-content active">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div><label style="color:var(--cyan); font-size:0.9em;">å§“å</label><input type="text" id="editName" class="search-input"></div>
                    <div><label style="color:var(--cyan); font-size:0.9em;">é›»è©±</label><input type="text" id="editPhone" class="search-input"></div>
                </div>
                <label style="color:var(--cyan); font-size:0.9em;">æˆ°ç•¥ç­†è¨˜</label>
                <textarea id="editNote" style="width:100%; height:150px; background:#121820; color:#ddd; border:1px solid #555; padding:10px; margin-top:5px; border-radius:4px;"></textarea>
                <div style="text-align:right; margin-top:15px;">
                    <button class="action-btn" onclick="saveData()">ğŸ’¾ æ›´æ–°æª”æ¡ˆ</button>
                </div>
            </div>

            <div id="tab-relation" class="tab-content">
                <p style="color:#888; font-size:0.9em;">å»ºç«‹å®¶æ—é€£çµï¼Œç³»çµ±å°‡è‡ªå‹•æƒææˆå“¡çš„æ½›åœ¨é¢¨éšª (å¤©å„/å¤©åˆƒ)ã€‚</p>
                <table class="rel-table">
                    <thead><tr><th>é—œä¿‚</th><th>å§“å</th><th>ç”Ÿæ—¥</th><th>æ€§åˆ¥</th><th>æ™‚è¾°</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="relList"></tbody>
                </table>
                <div class="add-rel-form">
                    <input type="text" id="relRelation" placeholder="é—œä¿‚ (å¦‚:é•·å­)" class="search-input">
                    <input type="text" id="relName" placeholder="å§“å" class="search-input">
                    <input type="date" id="relDate" class="search-input">
                    <select id="relGender" class="search-input"><option value="1">ç”·</option><option value="0">å¥³</option></select>
                    <select id="relHour" class="search-input">
                        <option value="å­">å­</option><option value="ä¸‘">ä¸‘</option><option value="å¯…">å¯…</option><option value="å¯">å¯</option><option value="è¾°">è¾°</option><option value="å·³">å·³</option>
                        <option value="åˆ">åˆ</option><option value="æœª">æœª</option><option value="ç”³">ç”³</option><option value="é…‰">é…‰</option><option value="æˆŒ">æˆŒ</option><option value="äº¥">äº¥</option>
                    </select>
                    <button class="action-btn" style="height:42px; padding:0 15px;" onclick="addRelation()">ï¼‹ æ–°å¢</button>
                </div>
            </div>

            <div id="tab-consent" class="tab-content">
                <div class="consent-section">
                    <div>
                        <div style="font-weight:bold; color:var(--text-main);">æ•¸ä½è«®è©¢åŒæ„æ›¸</div>
                        <div style="font-size:0.8em; color:#888;">ç‹€æ…‹ï¼š<span id="consentBadge" class="status-badge status-unsigned">æœªç°½ç½²</span></div>
                    </div>
                    <button class="op-btn btn-load" onclick="generateConsent()">ğŸ“² ç”¢ç”Ÿç°½ç½² QR Code</button>
                </div>
                <div id="qrcode"></div>
                <p style="color:#666; font-size:0.8em; text-align:center; margin-top:10px;">(è«‹å®¢æˆ¶ä½¿ç”¨æ‰‹æ©Ÿæƒæä¸Šæ–¹æ¢ç¢¼é€²è¡Œç°½å)</p>
            </div>
        </div>
    </div>
</div>

<script>
    let currentData = [];
    let selectedItem = null;

    window.onload = function() { loadData(); };

    async function loadData() {
        const keyword = document.getElementById('searchInput').value;
        const tbody = document.getElementById('crmTableBody');
        const loading = document.getElementById('loading');
        const emptyMsg = document.getElementById('emptyMsg');

        tbody.innerHTML = ''; loading.style.display = 'block'; emptyMsg.style.display = 'none';

        try {
            const res = await fetch(`/api/search_records?keyword=${encodeURIComponent(keyword)}`);
            const data = await res.json();
            currentData = data; // å­˜å…¥å…¨åŸŸè®Šæ•¸
            
            loading.style.display = 'none';
            if (!data || data.length === 0) { emptyMsg.style.display = 'block'; return; }

            data.forEach((item, index) => {
                const tr = document.createElement('tr');
                const dateStr = item.created_at || '-';
                const genderBadge = item.gender === 1 ? `<span class="gender-badge gender-m">ä¹¾(ç”·)</span>` : `<span class="gender-badge gender-f">å¤(å¥³)</span>`;
                const birthInfo = `${item.solar_date} [${item.hour}æ™‚]`;
                
                let tagsHtml = '';
                if(item.tags && item.tags.length > 0) {
                    item.tags.forEach(t => {
                        const isVip = t.toLowerCase().includes('vip');
                        tagsHtml += `<span class="tag-pill ${isVip?'tag-vip':''}">${t}</span>`;
                    });
                }

                tr.innerHTML = `
                    <td class="col-date">${dateStr}</td>
                    <td class="col-name">${item.client_name || 'è²´è³“'}</td>
                    <td class="col-chart">${genderBadge} ${birthInfo}</td>
                    <td class="col-phone">${item.phone || '-'}</td>
                    <td class="col-note"><div style="margin-bottom:5px;">${tagsHtml}</div>${item.note || '<span style="opacity:0.3">ç„¡ç­†è¨˜</span>'}</td>
                    <td>
                        <button class="op-btn btn-load" onclick='restoreRecord(${index})'>ğŸ“‚ å¾©ç›¤</button>
                        <button class="op-btn btn-edit" onclick='openDetail(${index})'>âœï¸ æª”æ¡ˆ</button>
                        <button class="op-btn btn-del" onclick="deleteRecord('${item.id}')">ğŸ—‘ï¸</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (e) { console.error(e); loading.innerText = "âŒ é€£ç·šå¤±æ•—"; }
    }

    // æ ¸å¿ƒæˆ°ç•¥ï¼šä¸€éµå¾©ç›¤
    function restoreRecord(index) {
        localStorage.setItem('damo_restore_data', JSON.stringify(currentData[index]));
        window.location.href = '/';
    }

    async function deleteRecord(id) {
        if(!confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤ï¼Ÿ")) return;
        try { await fetch(`/api/delete_record/${id}`, { method: 'DELETE' }); loadData(); } catch(e) { alert("åˆªé™¤å¤±æ•—"); }
    }

    // [V12.0] æ‰“é–‹å…¨åŠŸèƒ½æª”æ¡ˆå¤¾
    async function openDetail(index) {
        selectedItem = currentData[index];
        
        // å¡«å…¥åŸºæœ¬è³‡æ–™
        document.getElementById('mName').innerText = selectedItem.client_name || 'å®¢æˆ¶æª”æ¡ˆ';
        document.getElementById('editName').value = selectedItem.client_name || '';
        document.getElementById('editPhone').value = selectedItem.phone || '';
        document.getElementById('editNote').value = selectedItem.note || '';
        
        // åŒæ„æ›¸ç‹€æ…‹
        const badge = document.getElementById('consentBadge');
        if(selectedItem.consent_signed) { badge.innerText="å·²ç°½ç½²"; badge.className="status-badge status-signed"; }
        else { badge.innerText="æœªç°½ç½²"; badge.className="status-badge status-unsigned"; }
        document.getElementById('qrcode').style.display = "none";

        // æ¸²æŸ“å®¶æ—èˆ‡é¢¨éšª
        renderRelations();
        await scanRisks(); // è‡ªå‹•æƒæé¢¨éšª
        
        switchTab('basic'); // é è¨­é¡¯ç¤ºåŸºæœ¬è³‡æ–™
        document.getElementById('detailModal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('detailModal').style.display = 'none'; }

    // å­˜æª” (æ•´åˆåŸºæœ¬è³‡æ–™èˆ‡å®¶æ—)
    async function saveData(autoScan=false) {
        if(!selectedItem) return;
        
        // æ›´æ–°ç‰©ä»¶
        selectedItem.client_name = document.getElementById('editName').value;
        selectedItem.phone = document.getElementById('editPhone').value;
        selectedItem.note = document.getElementById('editNote').value;
        // relations å·²ç¶“åœ¨ addRelation/removeRel ä¸­æ›´æ–°åˆ° selectedItem

        try {
            await fetch(`/api/update_record/${selectedItem.id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(selectedItem)
            });
            if(autoScan) await scanRisks();
            else {
                alert("âœ… æª”æ¡ˆå·²æ›´æ–°");
                loadData(); // åˆ·æ–°åˆ—è¡¨
            }
        } catch(e) { alert("å­˜æª”å¤±æ•—"); }
    }

    // å®¶æ—åŠŸèƒ½æ¨¡çµ„
    function renderRelations() {
        const list = document.getElementById('relList');
        const rels = selectedItem.relations || [];
        list.innerHTML = rels.map((r, i) => `
            <tr>
                <td style="color:var(--cyan); font-weight:bold;">${r.relation}</td>
                <td>${r.name}</td>
                <td style="font-family:monospace; color:#888;">${r.solar_date}</td>
                <td>${r.gender==1?'ç”·':'å¥³'}</td>
                <td>${r.hour}</td>
                <td><button class="op-btn btn-del" style="margin:0;" onclick="removeRel(${i})">Ã—</button></td>
            </tr>`).join('');
    }

    function addRelation() {
        if(!selectedItem.relations) selectedItem.relations = [];
        const rName = document.getElementById('relName').value;
        const rDate = document.getElementById('relDate').value;
        
        if(!rName || !rDate) { alert("è«‹å¡«å¯«å§“åèˆ‡ç”Ÿæ—¥"); return; }

        selectedItem.relations.push({
            relation: document.getElementById('relRelation').value || 'è¦ªå‹',
            name: rName,
            solar_date: rDate,
            gender: parseInt(document.getElementById('relGender').value),
            hour: document.getElementById('relHour').value
        });
        
        // æ¸…ç©ºè¼¸å…¥æ¡†
        document.getElementById('relName').value = '';
        document.getElementById('relDate').value = '';
        
        renderRelations();
        saveData(true); // è‡ªå‹•å­˜æª”ä¸¦æƒæé¢¨éšª
    }

    function removeRel(i) {
        if(!confirm("ç§»é™¤æ­¤å®¶æ—æˆå“¡ï¼Ÿ")) return;
        selectedItem.relations.splice(i, 1);
        renderRelations();
        saveData(true);
    }

    // é¢¨éšªé›·é”
    async function scanRisks() {
        const banner = document.getElementById('riskBanner');
        if(!selectedItem.relations || selectedItem.relations.length === 0) {
            banner.style.display = 'none'; return;
        }
        try {
            const res = await fetch('/api/scan_family_risks', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(selectedItem)
            });
            const result = await res.json();
            if(result.alerts && result.alerts.length > 0) {
                document.getElementById('riskText').innerText = result.alerts.map(a => `${a.relation}${a.name} (${a.risk})`).join('ã€');
                banner.style.display = 'flex';
            } else {
                banner.style.display = 'none';
            }
        } catch(e) { console.error("Risk scan failed", e); }
    }

    // æ³•å¾‹åŒæ„æ›¸
    function generateConsent() {
        const qrDiv = document.getElementById('qrcode');
        qrDiv.innerHTML = ""; 
        qrDiv.style.display = "block";
        // ç”¢ç”Ÿé€£çµï¼šæŒ‡å‘ consent_page
        const url = `${window.location.origin}/consent_page?id=${selectedItem.id}`;
        new QRCode(qrDiv, { text: url, width: 150, height: 150 });
    }

    // é ç±¤åˆ‡æ›
    function switchTab(t) {
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
        // ç¢ºä¿å…ƒç´ å­˜åœ¨æ‰æ“ä½œ
        const tabBtn = document.querySelector(`.tab[onclick="switchTab('${t}')"]`);
        const tabDiv = document.getElementById(`tab-${t}`);
        if(tabBtn) tabBtn.classList.add('active');
        if(tabDiv) tabDiv.classList.add('active');
    }

    // é»æ“Šå¤–éƒ¨é—œé–‰
    window.onclick = function(event) {
        const modal = document.getElementById('detailModal');
        if (event.target == modal) modal.style.display = "none";
    }
</script>

</body>
</html>
