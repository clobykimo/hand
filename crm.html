<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”æ‘©æˆ°æƒ…å®¤ (CRM V13.0 å¸åœ‹ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --bg-color: #121820; --panel-bg: #1e2732; --gold: #d4af37;
            --bronze: #8c7853; --cyan: #4fd1c5; --danger: #ff4d4d;
            --text-main: #e0e0e0; --text-sub: #a0a0a0;
        }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: "Microsoft JhengHei", serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* é ‚éƒ¨å°èˆª */
        .header { width: 100%; max-width: 1400px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 2px solid var(--gold); padding-bottom: 15px; }
        .title { font-size: 1.8em; color: var(--gold); font-weight: bold; letter-spacing: 3px; display: flex; align-items: center; gap: 10px; }
        .back-btn { background: transparent; border: 1px solid var(--cyan); color: var(--cyan); padding: 8px 20px; border-radius: 4px; cursor: pointer; font-size: 1em; transition: all 0.3s; text-decoration: none; display: flex; align-items: center; gap: 5px; }
        .back-btn:hover { background: rgba(79, 209, 197, 0.1); transform: translateX(-5px); }

        /* [V13.0] æˆ°ç•¥é›·é”æ¢ (é€šçŸ¥ä¸­å¿ƒ) */
        .notification-bar { width: 100%; max-width: 1400px; display: flex; gap: 15px; margin-bottom: 20px; font-size: 0.9em; }
        .notif-box { flex: 1; background: rgba(212, 175, 55, 0.05); border: 1px solid #444; border-radius: 4px; padding: 10px 15px; display: flex; align-items: center; gap: 10px; color: #888; transition: all 0.3s; }
        .notif-box:hover { border-color: var(--gold); background: rgba(212, 175, 55, 0.1); }
        .notif-icon { font-size: 1.2em; }
        .notif-content { color: #ddd; font-weight: bold; }
        .nb-birthday { border-left: 3px solid var(--cyan); }
        .nb-risk { border-left: 3px solid var(--danger); }

        /* æœå°‹éæ¿¾ */
        .filter-bar { width: 100%; max-width: 1400px; background: var(--panel-bg); padding: 20px; border-radius: 8px; border: 1px solid #444; display: flex; gap: 15px; margin-bottom: 20px; box-sizing: border-box; align-items: flex-end; }
        .search-group { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .search-group label { color: var(--cyan); font-size: 0.9em; font-weight: bold; }
        .search-input { background: #121820; border: 1px solid #555; color: white; padding: 10px; border-radius: 4px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        .action-btn { background: linear-gradient(135deg, var(--bronze), var(--gold)); border: none; color: #1a2634; padding: 10px 25px; border-radius: 4px; font-weight: bold; cursor: pointer; height: 42px; display: flex; align-items: center; gap: 5px; justify-content: center;}
        .action-btn:hover { filter: brightness(1.15); }

        /* è³‡æ–™åˆ—è¡¨ */
        .table-container { width: 100%; max-width: 1400px; background: var(--panel-bg); border-radius: 8px; border: 1px solid #444; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        thead { background: #252f3a; color: var(--cyan); font-weight: bold; }
        th { padding: 15px; border-bottom: 2px solid var(--gold); white-space: nowrap; }
        td { padding: 15px; border-bottom: 1px solid #333; color: #ddd; vertical-align: middle; }
        tr:hover { background: rgba(212, 175, 55, 0.05); }
        
        .col-date { color: #888; font-size: 0.9em; font-family: monospace; }
        .col-name { font-size: 1.1em; font-weight: bold; color: #fff; }
        .col-chart { font-size: 0.9em; color: #bbb; }
        .gender-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        .gender-m { background: rgba(79, 209, 197, 0.2); color: var(--cyan); border: 1px solid var(--cyan); }
        .gender-f { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; border: 1px solid #ff6b6b; }
        .col-phone { font-family: monospace; color: var(--gold); letter-spacing: 1px; }
        .col-note { max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #888; font-style: italic; }
        .tag-pill { display: inline-block; background: #333; border: 1px solid #555; color: #aaa; padding: 2px 8px; border-radius: 10px; font-size: 0.75em; margin-right: 4px; }
        .tag-vip { border-color: var(--gold); color: var(--gold); background: rgba(212, 175, 55, 0.1); }
        
        /* [V13.0] ç†±é»é—œæ³¨ Tag */
        .heat-row { font-size: 0.75em; color: #ff6b6b; margin-bottom: 4px; display: flex; align-items: center; gap: 5px; }
        .heat-item { background: rgba(255, 77, 77, 0.1); border: 1px solid #553333; padding: 1px 5px; border-radius: 3px; }

        .op-btn { border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: bold; transition: all 0.2s; margin-right: 5px; }
        .btn-load { background: var(--cyan); color: #1a2634; }
        .btn-load:hover { box-shadow: 0 0 10px var(--cyan); }
        .btn-edit { background: #4a5568; color: #fff; }
        .btn-edit:hover { background: #718096; }
        .btn-del { background: transparent; border: 1px solid var(--danger); color: var(--danger); }
        .btn-del:hover { background: var(--danger); color: white; }

        /* å…¨åŠŸèƒ½æª”æ¡ˆå¤¾ Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        .modal-content { background: var(--panel-bg); border: 1px solid var(--gold); width: 900px; max-width: 95%; height: 85vh; border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .modal-header { padding: 20px; border-bottom: 1px solid #444; background: #151b24; display: flex; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0; }
        .modal-title { margin: 0; color: var(--gold); font-size: 1.5em; letter-spacing: 2px; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        
        /* é ç±¤ç³»çµ± */
        .tabs { display: flex; border-bottom: 1px solid #444; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; color: #888; border-bottom: 3px solid transparent; font-weight: bold; transition: all 0.3s; }
        .tab:hover { color: #ccc; }
        .tab.active { color: var(--cyan); border-color: var(--cyan); background: rgba(79, 209, 197, 0.05); }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        
        /* é¢¨éšªé›·é” */
        .risk-banner { background: rgba(255, 77, 77, 0.15); border: 1px solid var(--danger); color: #ffcccc; padding: 15px; margin-bottom: 20px; border-radius: 4px; display: none; align-items: center; gap: 10px; }
        .risk-icon { font-size: 1.5em; }

        /* [V13.0] å¤šåª’é«”æ¨£å¼ */
        .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 10px; }
        .media-box { aspect-ratio: 1; background: #222; border: 1px dashed #555; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .media-box:hover { border-color: var(--gold); color: var(--gold); background: rgba(212, 175, 55, 0.05); }
        .audio-player { background: #151b24; padding: 12px; border-radius: 6px; border: 1px solid #444; display: flex; align-items: center; gap: 10px; color: #aaa; margin-top: 10px; }

        /* å®¶æ—åˆ—è¡¨ */
        .rel-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        .rel-table th { text-align: left; color: var(--cyan); border-bottom: 1px solid #444; padding: 8px; }
        .rel-table td { padding: 8px; border-bottom: 1px solid #333; color: #eee; }
        .add-rel-form { display: grid; grid-template-columns: 100px 100px 140px 60px 60px auto; gap: 10px; background: #111; padding: 15px; border-radius: 4px; margin-top: 15px; border: 1px dashed #444; }
        
        /* åŒæ„æ›¸å€å¡Š */
        .consent-section { display: flex; justify-content: space-between; align-items: center; background: #111; padding: 15px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #333; }
        .status-badge { padding: 4px 10px; border-radius: 10px; font-size: 0.8em; font-weight: bold; }
        .status-signed { background: var(--cyan); color: #000; }
        .status-unsigned { background: #555; color: #ccc; }
        #qrcode { background: white; padding: 10px; width: fit-content; margin: 10px auto; display: none; border-radius: 4px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        #loading { text-align: center; padding: 40px; color: #888; display: none; }
        .spinner { display: inline-block; width: 30px; height: 30px; border: 3px solid #333; border-top: 3px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="header">
    <div class="title">
        <span>ğŸ“œ</span> é”æ‘©æˆ°æƒ…å®¤ <span style="font-size:0.5em; color:#666; margin-top:10px; margin-left:10px;">CRM V13.0</span>
    </div>
    <a href="/" class="back-btn">â‡¦ è¿”å›æ¨æ¼”ç›¤</a>
</div>

<div class="notification-bar">
    <div class="notif-box nb-birthday">
        <span class="notif-icon">ğŸ‚</span>
        <div>
            <div style="font-size:0.8em;">è¿‘æœŸå£½æ˜Ÿ (30å¤©å…§)</div>
            <div class="notif-content" id="birthdayList">æƒæä¸­...</div>
        </div>
    </div>
    <div class="notif-box nb-risk">
        <span class="notif-icon">âš ï¸</span>
        <div>
            <div style="font-size:0.8em;">æ½›åœ¨é¢¨éšªé—œæ³¨</div>
            <div class="notif-content" id="riskList">å®‰å…¨</div>
        </div>
    </div>
</div>

<div class="filter-bar">
    <div class="search-group">
        <label>ğŸ” é—œéµå­—æœå°‹</label>
        <input type="text" id="searchInput" class="search-input" placeholder="è¼¸å…¥å§“åã€é›»è©±æˆ–å‚™è¨»..." onkeypress="if(event.key==='Enter') loadData()">
    </div>
    <button class="action-btn" onclick="loadData()">æœå°‹å®¢æˆ¶</button>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th width="10%">è«®è©¢æ—¥æœŸ</th>
                <th width="15%">å®¢æˆ¶å§“å</th>
                <th width="20%">æœ¬å‘½åƒæ•¸</th>
                <th width="15%">è¯çµ¡é›»è©±</th>
                <th width="20%">æˆ°ç•¥ç­†è¨˜ & ç†±é»</th>
                <th width="20%">æˆ°è¡“è¡Œå‹•</th>
            </tr>
        </thead>
        <tbody id="crmTableBody">
            </tbody>
    </table>
    <div id="loading"><div class="spinner"></div><br>æ­£åœ¨è®€å–å·å®—...</div>
    <div id="emptyMsg" style="text-align:center; padding:40px; color:#666; display:none;">
        ğŸ“­ æŸ¥ç„¡è³‡æ–™ï¼Œè«‹å…ˆè‡³é¦–é å»ºç«‹å®¢æˆ¶æª”æ¡ˆã€‚
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="mName">å®¢æˆ¶å§“å</h2>
            <button style="background:none; border:none; color:#888; font-size:2em; cursor:pointer;" onclick="closeModal()">Ã—</button>
        </div>
        
        <div class="modal-body">
            <div id="riskBanner" class="risk-banner">
                <span class="risk-icon">âš ï¸</span> 
                <div><strong>å®¶æ—é è­¦ï¼š</strong> <span id="riskText"></span></div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('basic')">ğŸ“ åŸºæœ¬è³‡æ–™</div>
                <div class="tab" onclick="switchTab('relation')">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶æ—ç”Ÿæ…‹</div>
                <div class="tab" onclick="switchTab('media')">ğŸ“¸ å¤šåª’é«”/éŒ„éŸ³</div>
                <div class="tab" onclick="switchTab('consent')">ğŸ›¡ï¸ æ³•å¾‹åŒæ„æ›¸</div>
            </div>

            <div id="tab-basic" class="tab-content active">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div><label style="color:var(--cyan); font-size:0.9em;">å§“å</label><input type="text" id="editName" class="search-input"></div>
                    <div><label style="color:var(--cyan); font-size:0.9em;">é›»è©±</label><input type="text" id="editPhone" class="search-input"></div>
                </div>
                <label style="color:var(--cyan); font-size:0.9em;">æˆ°ç•¥ç­†è¨˜</label>
                <textarea id="editNote" style="width:100%; height:150px; background:#121820; color:#ddd; border:1px solid #555; padding:10px; margin-top:5px; border-radius:4px;"></textarea>
                <div style="text-align:right; margin-top:15px;">
                    <button class="action-btn" onclick="saveData()">ğŸ’¾ æ›´æ–°æª”æ¡ˆ</button>
                </div>
            </div>

            <div id="tab-relation" class="tab-content">
                <p style="color:#888; font-size:0.9em;">å»ºç«‹å®¶æ—é€£çµï¼Œç³»çµ±å°‡è‡ªå‹•æƒææˆå“¡çš„æ½›åœ¨é¢¨éšªã€‚</p>
                <table class="rel-table">
                    <thead><tr><th>é—œä¿‚</th><th>å§“å</th><th>ç”Ÿæ—¥</th><th>æ€§åˆ¥</th><th>æ™‚è¾°</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="relList"></tbody>
                </table>
                <div class="add-rel-form">
                    <input type="text" id="relRelation" placeholder="é—œä¿‚" class="search-input">
                    <input type="text" id="relName" placeholder="å§“å" class="search-input">
                    <input type="date" id="relDate" class="search-input">
                    <select id="relGender" class="search-input"><option value="1">ç”·</option><option value="0">å¥³</option></select>
                    <select id="relHour" class="search-input">
                        <option value="å­">å­</option><option value="ä¸‘">ä¸‘</option><option value="å¯…">å¯…</option><option value="å¯">å¯</option><option value="è¾°">è¾°</option><option value="å·³">å·³</option>
                        <option value="åˆ">åˆ</option><option value="æœª">æœª</option><option value="ç”³">ç”³</option><option value="é…‰">é…‰</option><option value="æˆŒ">æˆŒ</option><option value="äº¥">äº¥</option>
                    </select>
                    <button class="action-btn" style="height:42px; padding:0 15px;" onclick="addRelation()">ï¼‹</button>
                </div>
            </div>

            <div id="tab-media" class="tab-content">
                <p style="color:#888; font-size:0.9em;">å¯ä¸Šå‚³æ‰‹é¢ç›¸ç…§ç‰‡ã€éŒ„éŸ³æª”æˆ–è²¼ä¸Šé›²ç«¯é€£çµã€‚</p>
                <div class="media-grid">
                    <div class="media-box" onclick="alert('ä¸Šå‚³æ¨¡çµ„å»ºç½®ä¸­...')"><span style="font-size:2em;">+</span><span>ä¸Šå‚³ç…§ç‰‡</span></div>
                    <div class="media-box"><span style="font-size:2em;">ğŸ™ï¸</span><span>è«®è©¢éŒ„éŸ³</span></div>
                </div>
                <div class="audio-player">
                    <span>â–¶ï¸</span> <div style="height:4px; background:#333; flex:1; border-radius:2px;"></div> <span>00:00</span>
                </div>
            </div>

            <div id="tab-consent" class="tab-content">
                <div class="consent-section">
                    <div>
                        <div style="font-weight:bold; color:var(--text-main);">æ•¸ä½è«®è©¢åŒæ„æ›¸</div>
                        <div style="font-size:0.8em; color:#888;">ç‹€æ…‹ï¼š<span id="consentBadge" class="status-badge status-unsigned">æœªç°½ç½²</span></div>
                    </div>
                    <button class="op-btn btn-load" onclick="generateConsent()">ğŸ“² ç”¢ç”Ÿ QR Code</button>
                </div>
                <div id="qrcode"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentData = [];
    let selectedItem = null;

    window.onload = function() { loadData(); };

    async function loadData() {
        const keyword = document.getElementById('searchInput').value;
        const tbody = document.getElementById('crmTableBody');
        const loading = document.getElementById('loading');
        const emptyMsg = document.getElementById('emptyMsg');

        tbody.innerHTML = ''; loading.style.display = 'block'; emptyMsg.style.display = 'none';

        try {
            const res = await fetch(`/api/search_records?keyword=${encodeURIComponent(keyword)}`);
            const data = await res.json();
            currentData = data; 
            
            loading.style.display = 'none';
            if (!data || data.length === 0) { emptyMsg.style.display = 'block'; return; }

            // [V13.0] å£½æ˜Ÿæƒæå™¨
            scanBirthdays(data);

            data.forEach((item, index) => {
                const tr = document.createElement('tr');
                const dateStr = item.created_at || '-';
                const genderBadge = item.gender === 1 ? `<span class="gender-badge gender-m">ä¹¾(ç”·)</span>` : `<span class="gender-badge gender-f">å¤(å¥³)</span>`;
                const birthInfo = `${item.solar_date} [${item.hour}æ™‚]`;
                
                // æ¨™ç±¤
                let tagsHtml = '';
                if(item.tags && item.tags.length > 0) {
                    item.tags.forEach(t => {
                        const isVip = t.toLowerCase().includes('vip');
                        tagsHtml += `<span class="tag-pill ${isVip?'tag-vip':''}">${t}</span>`;
                    });
                }

                // [V13.0] é—œæ³¨ç†±é» (å¾ ai_log.click_heatmap æŠ“å–)
                let heatHtml = '';
                if (item.ai_log && item.ai_log.click_heatmap) {
                    const sorted = Object.entries(item.ai_log.click_heatmap).sort((a,b)=>b[1]-a[1]).slice(0,3);
                    if(sorted.length > 0) heatHtml = `<div class="heat-row">ğŸ”¥ é—œæ³¨: ${sorted.map(s=>`<span class="heat-item">${s[0]}</span>`).join('')}</div>`;
                }

                tr.innerHTML = `
                    <td class="col-date">${dateStr}</td>
                    <td class="col-name">${item.client_name || 'è²´è³“'}</td>
                    <td class="col-chart">${genderBadge} ${birthInfo}</td>
                    <td class="col-phone">${item.phone || '-'}</td>
                    <td class="col-note">${heatHtml} ${tagsHtml} ${item.note || '<span style="opacity:0.3">ç„¡ç­†è¨˜</span>'}</td>
                    <td>
                        <button class="op-btn btn-load" onclick='restoreRecord(${index})'>ğŸ“‚ å¾©ç›¤</button>
                        <button class="op-btn btn-edit" onclick='openDetail(${index})'>âœï¸ æª”æ¡ˆ</button>
                        <button class="op-btn btn-del" onclick="deleteRecord('${item.id}')">ğŸ—‘ï¸</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (e) { console.error(e); loading.innerText = "âŒ é€£ç·šå¤±æ•—"; }
    }

    // [V13.0] å£½æ˜Ÿé‚è¼¯ (ç°¡æ˜“ç‰ˆï¼šåªæ¯”å°æœˆ/æ—¥)
    function scanBirthdays(data) {
        const today = new Date();
        const tMonth = today.getMonth() + 1;
        const tDay = today.getDate();
        let bList = [];

        data.forEach(d => {
            if(!d.solar_date) return;
            const parts = d.solar_date.split('-'); // YYYY-MM-DD
            if(parts.length < 3) return;
            const bMonth = parseInt(parts[1]);
            const bDay = parseInt(parts[2]);

            // åˆ¤æ–·æ˜¯å¦ç‚ºã€Œæœªä¾†30å¤©å…§ã€çš„å£½æ˜Ÿ
            // é€™è£¡ç”¨ç°¡å–®é‚è¼¯ï¼šåªè¦æœˆä»½ç›¸åŒæˆ–ä¸‹å€‹æœˆï¼Œä¸”æ—¥æœŸæ¥è¿‘
            if (bMonth === tMonth && bDay >= tDay) {
                bList.push(`${d.client_name} (${bMonth}/${bDay})`);
            } else if (bMonth === (tMonth % 12) + 1 && bDay < 15) {
                bList.push(`${d.client_name} (${bMonth}/${bDay})`);
            }
        });

        const listEl = document.getElementById('birthdayList');
        if (bList.length > 0) {
            listEl.innerHTML = bList.join('ã€');
            listEl.style.color = "var(--cyan)";
        } else {
            listEl.innerHTML = "è¿‘æœŸç„¡å£½æ˜Ÿ";
            listEl.style.color = "#666";
        }
    }

    function restoreRecord(index) {
        localStorage.setItem('damo_restore_data', JSON.stringify(currentData[index]));
        window.location.href = '/';
    }

    async function deleteRecord(id) {
        if(!confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤ï¼Ÿ")) return;
        try { await fetch(`/api/delete_record/${id}`, { method: 'DELETE' }); loadData(); } catch(e) { alert("åˆªé™¤å¤±æ•—"); }
    }

    async function openDetail(index) {
        selectedItem = currentData[index];
        document.getElementById('mName').innerText = selectedItem.client_name || 'å®¢æˆ¶æª”æ¡ˆ';
        document.getElementById('editName').value = selectedItem.client_name || '';
        document.getElementById('editPhone').value = selectedItem.phone || '';
        document.getElementById('editNote').value = selectedItem.note || '';
        
        const badge = document.getElementById('consentBadge');
        if(selectedItem.consent_signed) { badge.innerText="å·²ç°½ç½²"; badge.className="status-badge status-signed"; }
        else { badge.innerText="æœªç°½ç½²"; badge.className="status-badge status-unsigned"; }
        document.getElementById('qrcode').style.display = "none";

        renderRelations();
        await scanRisks();
        switchTab('basic');
        document.getElementById('detailModal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('detailModal').style.display = 'none'; }

    async function saveData(autoScan=false) {
        if(!selectedItem) return;
        selectedItem.client_name = document.getElementById('editName').value;
        selectedItem.phone = document.getElementById('editPhone').value;
        selectedItem.note = document.getElementById('editNote').value;
        try {
            await fetch(`/api/update_record/${selectedItem.id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(selectedItem)
            });
            if(autoScan) await scanRisks();
            else { alert("âœ… æª”æ¡ˆå·²æ›´æ–°"); loadData(); }
        } catch(e) { alert("å­˜æª”å¤±æ•—"); }
    }

    function renderRelations() {
        const list = document.getElementById('relList');
        const rels = selectedItem.relations || [];
        list.innerHTML = rels.map((r, i) => `
            <tr>
                <td style="color:var(--cyan); font-weight:bold;">${r.relation}</td>
                <td>${r.name}</td>
                <td style="font-family:monospace; color:#888;">${r.solar_date}</td>
                <td>${r.gender==1?'ç”·':'å¥³'}</td>
                <td>${r.hour}</td>
                <td><button class="op-btn btn-del" style="margin:0;" onclick="removeRel(${i})">Ã—</button></td>
            </tr>`).join('');
    }

    function addRelation() {
        if(!selectedItem.relations) selectedItem.relations = [];
        const rName = document.getElementById('relName').value;
        const rDate = document.getElementById('relDate').value;
        if(!rName || !rDate) { alert("è«‹å¡«å¯«å§“åèˆ‡ç”Ÿæ—¥"); return; }
        selectedItem.relations.push({
            relation: document.getElementById('relRelation').value || 'è¦ªå‹',
            name: rName, solar_date: rDate,
            gender: parseInt(document.getElementById('relGender').value),
            hour: document.getElementById('relHour').value
        });
        document.getElementById('relName').value = ''; document.getElementById('relDate').value = '';
        renderRelations(); saveData(true);
    }

    function removeRel(i) {
        if(!confirm("ç§»é™¤æ­¤å®¶æ—æˆå“¡ï¼Ÿ")) return;
        selectedItem.relations.splice(i, 1);
        renderRelations(); saveData(true);
    }

    async function scanRisks() {
        const banner = document.getElementById('riskBanner');
        if(!selectedItem.relations || selectedItem.relations.length === 0) { banner.style.display = 'none'; return; }
        try {
            const res = await fetch('/api/scan_family_risks', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(selectedItem)
            });
            const result = await res.json();
            if(result.alerts && result.alerts.length > 0) {
                document.getElementById('riskText').innerText = result.alerts.map(a => `${a.relation}${a.name} (${a.risk})`).join('ã€');
                banner.style.display = 'flex';
            } else { banner.style.display = 'none'; }
        } catch(e) { console.error(e); }
    }

    function generateConsent() {
        const qrDiv = document.getElementById('qrcode');
        qrDiv.innerHTML = ""; qrDiv.style.display = "block";
        const url = `${window.location.origin}/consent_page?id=${selectedItem.id}`;
        new QRCode(qrDiv, { text: url, width: 150, height: 150 });
    }

    function switchTab(t) {
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
        const tabBtn = document.querySelector(`.tab[onclick="switchTab('${t}')"]`);
        const tabDiv = document.getElementById(`tab-${t}`);
        if(tabBtn) tabBtn.classList.add('active');
        if(tabDiv) tabDiv.classList.add('active');
    }

    window.onclick = function(event) {
        const modal = document.getElementById('detailModal');
        if (event.target == modal) modal.style.display = "none";
    }
</script>

</body>
</html>
