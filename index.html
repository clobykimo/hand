<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”æ‘©ä¸€æŒç¶“ï¼å…¨æ™‚ç©ºæˆ°ç•¥ä¸­å°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --bg-color: #121820; --panel-bg: #1e2732; --gold: #d4af37;
            --bronze: #8c7853; --cyan: #4fd1c5; --danger: #ff4d4d;
            --text-main: #e0e0e0; --text-sub: #a0a0a0; --gpt-color: #10a37f;
            --p-year: #d4af37; --p-month: #4fd1c5; --p-day: #ff9f43; --p-hour: #a3a3ff; --p-luck: #2ecc71;
            --status-best: #ffd700; --status-good: #ADD8E6; --status-growth: #90EE90; --status-bad: #ff4d4d;
        }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: "Microsoft JhengHei", serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        h1 { color: var(--gold); letter-spacing: 5px; margin-bottom: 20px; text-shadow: 0 0 10px rgba(212,175,55,0.4); }
        .dashboard { display: grid; grid-template-columns: 380px 1fr; gap: 25px; width: 100%; max-width: 1400px; }
        .control-panel, .card { background: var(--panel-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--bronze); margin-bottom: 20px; }
        .control-panel { height: fit-content; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: sticky; top: 20px; }
        label { display: block; margin-bottom: 5px; color: var(--cyan); font-size: 0.9em; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 15px; background: #151b24; border: 1px solid #4a5568; color: white; border-radius: 4px; box-sizing: border-box; font-size: 1rem; }
        button.btn-main { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--bronze), var(--gold)); border: none; font-weight: bold; font-size: 1.2em; border-radius: 4px; cursor: pointer; color: #1a2634; margin-top: 15px; box-shadow: 0 4px 15px rgba(212,175,55,0.3); }
        button.btn-main:hover { filter: brightness(1.15); transform: translateY(-2px); }
        .ctrl-btn { background: #333; color: #ddd; border: 1px solid #555; padding: 4px 12px; border-radius: 4px; cursor: pointer; margin-left: 8px; }
        .ctrl-btn.active { background: var(--gold); color: #1a2634; }
        .ctrl-btn.finish { border-color: var(--cyan); color: var(--cyan); }
        .card-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; transition: opacity 0.2s; }
        .card-header:hover { opacity: 0.8; }
        .arrow-icon { transition: transform 0.3s ease; font-size: 0.8em; color: var(--cyan); }
        .arrow-icon.collapsed { transform: rotate(-90deg); }
        .card-body { overflow: hidden; transition: max-height 0.4s cubic-bezier(0, 1, 0, 1), opacity 0.4s ease-in-out, margin-top 0.4s; max-height: 2000px; opacity: 1; margin-top: 15px; }
        .card-body.collapsed { max-height: 0; opacity: 0; margin-top: 0; }
        
        /* Grid Map */
        .twelve-palaces-map { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 130px); gap: 12px; padding: 15px; margin-top: 0; background: rgba(0,0,0,0.2); border: 1px solid #444; border-radius: 8px; grid-template-areas: "si wu wei shen" "chen . . you" "mao . . xu" "yin chou zi hai"; }
        .grid-cell { position: relative; background: #2a3544; border: 1px solid #3f4a5a; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; }
        .grid-cell.active { border-color: var(--gold); background: #3a4555; }
        .grid-cell.target { box-shadow: 0 0 25px var(--cyan) !important; border-color: #fff !important; }
        .grid-cell.roulette-active { background: #fff !important; border-color: var(--gold); transform: scale(1.05); z-index: 100; }
        .grid-cell.roulette-active .cell-star { color: #000 !important; }
        .cell-zhi { position: absolute; top: 5px; left: 8px; font-size: 1em; color: #555; font-weight: bold; }
        .cell-star { font-size: 1.7em; font-weight: bold; color: #ddd; z-index: 1; }
        .cell-aspect-name { font-size: 0.95em; color: var(--cyan); font-weight: bold; border-top: 1px solid rgba(255,255,255,0.1); width: 85%; text-align: center; margin-top: 4px; }
        .cell-realm { font-size: 0.7em; color: #555; position:absolute; bottom: 3px; right: 5px; }
        .cell-relation-tag { position: absolute; top: 5px; right: 5px; font-size: 0.75em; padding: 2px 6px; border-radius: 3px; font-weight: bold; color: #1a2634; }
        .pillar-badges-container { position: absolute; top: 25px; left: 4px; display: flex; flex-direction: column; gap: 3px; }
        .pillar-badge { font-size: 0.65em; padding: 1px 5px; border-radius: 3px; color: #1a2634; font-weight: bold; opacity:0; }
        .pillar-badge.show { opacity: 1; }
        
        /* List & AI */
        .aspect-row { border-bottom: 1px solid #333; padding: 14px 8px; display: flex; align-items: center; justify-content: space-between; gap: 10px; transition: background 0.2s; }
        .aspect-row.clickable { cursor: pointer; border-left: 3px solid transparent; }
        .aspect-row.clickable:hover { background: rgba(212, 175, 55, 0.1); border-left: 3px solid var(--gold); }
        .aspect-row.active-aspect { background: rgba(79, 209, 197, 0.15); border-left: 3px solid var(--cyan); }
        .aspect-tag { padding: 4px 10px; border-radius: 4px; font-size: 0.9em; text-align: center; min-width: 50px; color: #1a2634; font-weight:bold; }
        .checkbox-wrapper { margin-bottom: 10px; display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--gold); font-weight: bold; user-select: none; }
        .checkbox-wrapper input { width: 18px; height: 18px; cursor: pointer; margin: 0; }
        .ai-controls { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .ai-shortcut-btn { flex: 1; background: #2d3748; border: 1px solid #4a5568; color: #cbd5e0; padding: 8px 5px; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .ai-shortcut-btn:hover { background: #4a5568; color: white; border-color: var(--gpt-color); transform: translateY(-2px); }
        .mini-ai-btn { background: transparent; border: 1px solid var(--gpt-color); color: var(--gpt-color); border-radius: 4px; width: 26px; height: 26px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: 8px; transition: all 0.2s; }
        .mini-ai-btn:hover { background: var(--gpt-color); color: white; transform: scale(1.1); box-shadow: 0 0 10px rgba(16, 163, 127, 0.4); }
        
        /* æˆ°ç•¥å„€è¡¨æ¿ */
        .progress-container { flex: 1; height: 6px; background: #333; border-radius: 3px; margin: 0 8px; overflow: hidden; position: relative; }
        .progress-bar { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
        .trend-icon { font-weight: bold; margin-left: 5px; font-size: 1.1em; }
        .trend-icon.up { color: #ff4d4d; animation: pulse 2s infinite; }
        .trend-icon.down { color: #4fd1c5; }
        .trend-icon.flat { color: #666; font-size: 0.8em; }
        .score-composition { font-size: 0.7em; color: #888; margin-left: 4px; font-weight: normal; }
        .score-bonus { color: #ffd700; }
        .score-penalty { color: #ff4d4d; }

        /* CRM Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center; }
        .modal-content { background-color: #1e2732; border: 1px solid var(--gold); padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 0 20px rgba(0,0,0,0.8); }
        .modal h3 { color: var(--gold); margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { color: #aaa; font-size: 0.9em; margin-bottom: 4px; display:block; }
        .tag-container { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px; }
        .tag-chip { font-size: 0.8em; padding: 2px 8px; border-radius: 10px; background: #333; cursor: pointer; border: 1px solid #555; user-select: none; color: #ddd; }
        .tag-chip.selected { background: var(--cyan); color: #000; border-color: var(--cyan); }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
        @media (max-width: 950px) { .dashboard { grid-template-columns: 1fr; } .control-panel { position: static; } }
        #loadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #333; border-top: 4px solid var(--gold); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes dropIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .show-content { opacity: 1 !important; }
        .input-group { display: none; }
        .input-group.show { display: block; }
        .four-pillars { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .pillar-box { background: #252f3a; padding: 10px; text-align: center; border: 1px solid #444; border-radius: 6px; opacity: 0.3; }
        .pillar-box.active { opacity: 1; border-color: var(--gold); }
        .center-decoration { grid-area: 2 / 2 / 4 / 4; display: flex; justify-content: center; align-items: center; opacity: 0.3; pointer-events: none; border: 2px dashed var(--bronze); border-radius: 50%; margin: 15px; }
        .ai-btn { background: var(--gpt-color); color: white; border: none; padding: 6px 20px; border-radius: 4px; cursor: pointer; margin-left: 10px; font-weight:bold; }
    </style>
</head>
<body>
<div id="loadingOverlay"><div class="spinner"></div></div>
<h1>é”æ‘©ä¸€æŒç¶“ï¼å…¨æ™‚ç©ºæˆ°ç•¥ä¸­å°</h1>
<div class="dashboard">
    <div class="control-panel">
        <h3 style="color:var(--cyan); border-bottom:1px solid #444;">1. è¨­å®šæ¡ˆä¸»æœ¬å‘½</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div><label>æ€§åˆ¥</label><select id="gender"><option value="1">ç”· (é †è¡Œ)</option><option value="0">å¥³ (é€†è¡Œ)</option></select></div>
            <div>
                <label>å‡ºç”Ÿæ™‚è¾°</label>
                <select id="hour">
                    <option value="å­">å­æ™‚ (23:00-01:00)</option><option value="ä¸‘">ä¸‘æ™‚ (01:00-03:00)</option><option value="å¯…">å¯…æ™‚ (03:00-05:00)</option>
                    <option value="å¯">å¯æ™‚ (05:00-07:00)</option><option value="è¾°">è¾°æ™‚ (07:00-09:00)</option><option value="å·³">å·³æ™‚ (09:00-11:00)</option>
                    <option value="åˆ">åˆæ™‚ (11:00-13:00)</option><option value="æœª">æœªæ™‚ (13:00-15:00)</option><option value="ç”³">ç”³æ™‚ (15:00-17:00)</option>
                    <option value="é…‰">é…‰æ™‚ (17:00-19:00)</option><option value="æˆŒ">æˆŒæ™‚ (19:00-21:00)</option><option value="äº¥">äº¥æ™‚ (21:00-23:00)</option>
                </select>
            </div>
        </div>
        <label>åœ‹æ›†å‡ºç”Ÿæ—¥æœŸ</label><input type="date" id="solarDate" value="1985-03-27">
        <h3 style="color:var(--gold); border-bottom:1px solid #444; margin-top:20px;">2. è¨­å®šæˆ°ç•¥ç›®æ¨™</h3>
        <div style="display:flex; gap:20px; margin-bottom:10px;">
            <label style="color:white; cursor:pointer;"><input type="radio" name="calendarType" value="lunar" checked onchange="updateFormUI()"> è¾²æ›†</label>
            <label style="color:white; cursor:pointer;"><input type="radio" name="calendarType" value="solar" onchange="updateFormUI()"> è¥¿å…ƒæ›†</label>
        </div>
        <label>æ¨æ¼”å±¤ç´š</label>
        <select id="targetScope" onchange="updateFormUI()">
            <option value="year">æµå¹´ (åªçœ‹å¹´)</option><option value="month">æµæœˆ (å¹´+æœˆ)</option>
            <option value="day">æµæ—¥ (å¹´+æœˆ+æ—¥)</option><option value="hour">æµæ™‚ (å¹´+æœˆ+æ—¥+æ™‚)</option>
        </select>
        
        <div id="yearInput" class="input-group show">
            <label id="lblYear">è¾²æ›†å¹´ä»½</label> 
            <input type="number" id="tYear" value="2026">
        </div>
        <div id="monthInput" class="input-group">
            <label id="lblMonth">è¾²æ›†æœˆä»½</label>
            <input type="number" id="tMonth" value="1" min="1" max="12">
        </div>
        <div id="dayInput" class="input-group">
            <label id="lblDay">è¾²æ›†æ—¥æœŸ</label>
            <input type="number" id="tDay" value="1" min="1" max="31">
        </div>
        
        <div id="hourInput" class="input-group">
            <label>æ™‚è¾°</label>
            <select id="tHour">
                <option value="å­">å­æ™‚ (23:00-01:00)</option><option value="ä¸‘">ä¸‘æ™‚ (01:00-03:00)</option><option value="å¯…">å¯…æ™‚ (03:00-05:00)</option>
                <option value="å¯">å¯æ™‚ (05:00-07:00)</option><option value="è¾°">è¾°æ™‚ (07:00-09:00)</option><option value="å·³">å·³æ™‚ (09:00-11:00)</option>
                <option value="åˆ">åˆæ™‚ (11:00-13:00)</option><option value="æœª">æœªæ™‚ (13:00-15:00)</option><option value="ç”³">ç”³æ™‚ (15:00-17:00)</option>
                <option value="é…‰">é…‰æ™‚ (17:00-19:00)</option><option value="æˆŒ">æˆŒæ™‚ (19:00-21:00)</option><option value="äº¥">äº¥æ™‚ (21:00-23:00)</option>
            </select>
        </div>
        <button class="btn-main" onclick="calculate()">å•Ÿå‹•å…¨æ™‚ç©ºæ¨æ¼”</button>

        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #444;">
            <h3 style="color:var(--cyan); font-size:1em;">ğŸ“‚ å®¢æˆ¶ç´€éŒ„ç®¡ç†</h3>
            <div style="display:flex; gap:10px;">
                <button class="ctrl-btn active" style="flex:1; padding:8px;" onclick="openSaveModal()">ğŸ’¾ å­˜æª”</button>
                <button class="ctrl-btn" style="flex:1; padding:8px;" onclick="loadHistory()">ğŸ“œ è®€å–æ­·å²</button>
            </div>
            <div id="historyList" style="margin-top:10px; max-height:200px; overflow-y:auto; font-size:0.9em; color:#aaa;"></div>
        </div>
    </div>

    <div class="info-panel" id="resultArea">
        <div class="card" style="border-left:5px solid var(--gold); overflow:hidden;">
            <h3 class="card-header" style="color:var(--gold);">
                <div style="display:flex; justify-content:space-between; width:100%">
                    <div>æˆ°ç•¥å„€è¡¨æ¿ <span id="lunarInfo" style="font-size:0.8em; color:#a0a0a0;"></span></div>
                    <div id="animControls" style="display:none; font-size:0.8em;">
                        <button class="ctrl-btn" id="pauseBtn" onclick="togglePause(); event.stopPropagation();">â¯</button>
                        <button class="ctrl-btn finish" onclick="skipToComplete(); event.stopPropagation();">â©</button>
                        <button class="ctrl-btn" onclick="replayAnimation(); event.stopPropagation();">ğŸ”„</button>
                    </div>
                </div>
            </h3>
            <div class="twelve-palaces-map">
                <div class="grid-cell" id="cell-å·³"><div class="pillar-badges-container"></div><span class="cell-zhi">å·³</span><span class="cell-star">å¤©æ–‡</span><span class="cell-realm">ä»™é“</span></div>
                <div class="grid-cell" id="cell-åˆ"><div class="pillar-badges-container"></div><span class="cell-zhi">åˆ</span><span class="cell-star">å¤©ç¦</span><span class="cell-realm">ä½›é“</span></div>
                <div class="grid-cell" id="cell-æœª"><div class="pillar-badges-container"></div><span class="cell-zhi">æœª</span><span class="cell-star">å¤©é©›</span><span class="cell-realm">é¬¼é“</span></div>
                <div class="grid-cell" id="cell-ç”³"><div class="pillar-badges-container"></div><span class="cell-zhi">ç”³</span><span class="cell-star">å¤©å­¤</span><span class="cell-realm">äººé“</span></div>
                <div class="grid-cell" id="cell-è¾°"><div class="pillar-badges-container"></div><span class="cell-zhi">è¾°</span><span class="cell-star">å¤©å¥¸</span><span class="cell-realm">ä¿®ç¾…</span></div>
                <div class="center-decoration"><span style="font-size:3em; color:var(--gold);">â˜¯</span></div>
                <div class="grid-cell" id="cell-é…‰"><div class="pillar-badges-container"></div><span class="cell-zhi">é…‰</span><span class="cell-star">å¤©åˆƒ</span><span class="cell-realm">ç•œé“</span></div>
                <div class="grid-cell" id="cell-å¯"><div class="pillar-badges-container"></div><span class="cell-zhi">å¯</span><span class="cell-star">å¤©ç ´</span><span class="cell-realm">ç•œé“</span></div>
                <div class="grid-cell" id="cell-æˆŒ"><div class="pillar-badges-container"></div><span class="cell-zhi">æˆŒ</span><span class="cell-star">å¤©è—</span><span class="cell-realm">ä¿®ç¾…</span></div>
                <div class="grid-cell" id="cell-å¯…"><div class="pillar-badges-container"></div><span class="cell-zhi">å¯…</span><span class="cell-star">å¤©æ¬Š</span><span class="cell-realm">äººé“</span></div>
                <div class="grid-cell" id="cell-ä¸‘"><div class="pillar-badges-container"></div><span class="cell-zhi">ä¸‘</span><span class="cell-star">å¤©å„</span><span class="cell-realm">é¬¼é“</span></div>
                <div class="grid-cell" id="cell-å­"><div class="pillar-badges-container"></div><span class="cell-zhi">å­</span><span class="cell-star">å¤©è²´</span><span class="cell-realm">ä½›é“</span></div>
                <div class="grid-cell" id="cell-äº¥"><div class="pillar-badges-container"></div><span class="cell-zhi">äº¥</span><span class="cell-star">å¤©å£½</span><span class="cell-realm">ä»™é“</span></div>
            </div>
        </div>

        <div class="card">
            <h3 class="card-header" onclick="toggleCard('pillarsBody')">æœ¬å‘½æ ¹åŸº <span class="arrow-icon collapsed">â–¼</span></h3>
            <div id="pillarsBody" class="card-body collapsed"><div class="four-pillars" id="pillarsArea"></div></div>
        </div>

        <div class="card" style="border-left:5px solid var(--cyan);">
            <h3 class="card-header" onclick="toggleCard('hierarchyBody')">
                æ™‚ç©ºæˆ°ç•¥å®šä½ <span id="targetDisplayInfo" style="font-size:0.7em; color:#888; font-weight:normal;"></span> 
                <span class="arrow-icon collapsed">â–¼</span>
            </h3>
            <div id="hierarchyBody" class="card-body collapsed"><div id="hierarchyArea"></div></div>
        </div>
        
        <div class="card" style="border-left: 5px solid var(--gold);">
            <h3 class="card-header" onclick="toggleCard('trendBody')">
                <span id="trendTitle">æ™‚ç©ºé‹å‹¢æ³¢å½¢åœ– <span style="font-size:0.7em; color:#888;">(é è¨­: ç¸½å‘½é‹)</span></span>
                <span class="arrow-icon">â–¼</span>
            </h3>
            <div id="trendBody" class="card-body">
                <div style="margin-bottom:10px; display:flex; justify-content:flex-end;">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="gradeCheckbox" onchange="updateTrendChart(lastActiveAspect)">
                        â˜‘ åäºŒå®®ä¸‰å“æ ¼ (å•Ÿç”¨æ˜Ÿå®¿åŠ æ¬Š)
                    </label>
                </div>
                <div style="height: 250px; width: 100%;"><canvas id="trendChart"></canvas></div>
            </div>
        </div>

        <div class="card">
            <h3 class="card-header" onclick="toggleCard('aspectsBody')">
                åäºŒé‹ç¨‹æˆ°ç•¥æŒ‡å° <span style="font-size:0.7em; color:var(--cyan);">(é»æ“Šé …ç›®åˆ‡æ›æ³¢å½¢)</span>
                <span class="arrow-icon">â–¼</span>
            </h3>
            <div id="aspectsBody" class="card-body"><div id="aspectsList"></div></div>
        </div>

        <div class="card" style="background:#161625; border-color:var(--gpt-color);">
            <h3 class="card-header" onclick="toggleCard('aiBody')" style="color:var(--gpt-color);">
                ğŸ¤– AI æˆ°ç•¥é¡§å• <button class="ai-btn" onclick="event.stopPropagation(); callAIWithMode('general');">ğŸ”® ç¶œåˆåˆ†æ</button>
                <span class="arrow-icon collapsed">â–¼</span>
            </h3>
            <div id="aiBody" class="card-body collapsed">
                <div class="ai-controls">
                    <button class="ai-shortcut-btn" onclick="callAIWithMode('weakest')">ğŸ’” æ‰¾ç—…ç¶</button>
                    <button class="ai-shortcut-btn" onclick="callAIWithMode('timing')">ğŸ“… å®šæ™‚æ©Ÿ</button>
                    <button class="ai-shortcut-btn" onclick="callAIWithMode('script')">ğŸ—£ï¸ æ±‚è©±è¡“</button>
                </div>
                <div id="aiPrompt" style="display:none;"></div>
                <div id="aiResponseArea" style="min-height:100px; padding:10px; color:#ddd;">(è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•ï¼Œå•Ÿå‹•æˆ°ç•¥åˆ†æ...)</div>
            </div>
        </div>
    </div>
</div>

<div id="saveModal" class="modal">
    <div class="modal-content">
        <h3>ğŸ’¾ å»ºç«‹å®¢æˆ¶æª”æ¡ˆ</h3>
        <div class="form-group"><label>å®¢æˆ¶å§“å</label><input type="text" id="crmName" placeholder="ä¾‹å¦‚ï¼šé™³å¤§ç™¼"></div>
        <div class="form-group"><label>è¯çµ¡é›»è©± / Line</label><input type="text" id="crmPhone" placeholder="09xx-xxx-xxx"></div>
        <div class="form-group">
            <label>å®¢æˆ¶æ¨™ç±¤</label>
            <div class="tag-container" id="tagList">
                <span class="tag-chip" onclick="toggleTag(this)">VIP</span><span class="tag-chip" onclick="toggleTag(this)">ä¼æ¥­è«®è©¢</span>
                <span class="tag-chip" onclick="toggleTag(this)">æ„Ÿæƒ…å›°æ“¾</span><span class="tag-chip" onclick="toggleTag(this)">å·²ä»˜æ¬¾</span>
                <span class="tag-chip" onclick="toggleTag(this)">éœ€è¿½è¹¤</span>
            </div>
        </div>
        <div class="form-group"><label>è«®è©¢ç­†è¨˜</label><textarea id="crmNote" rows="3" placeholder="ç´€éŒ„é‡é»..."></textarea></div>
        <div class="modal-footer">
            <button class="ctrl-btn" onclick="closeSaveModal()">å–æ¶ˆ</button>
            <button class="ctrl-btn active" onclick="confirmSave()">ç¢ºèªå„²å­˜</button>
        </div>
    </div>
</div>

<script>
    const DEFAULT_STARS = { 'å­': {name:'å¤©è²´', realm:'ä½›é“'}, 'ä¸‘': {name:'å¤©å„', realm:'é¬¼é“'}, 'å¯…': {name:'å¤©æ¬Š', realm:'äººé“'}, 'å¯': {name:'å¤©ç ´', realm:'ç•œé“'}, 'è¾°': {name:'å¤©å¥¸', realm:'ä¿®ç¾…'}, 'å·³': {name:'å¤©æ–‡', realm:'ä»™é“'}, 'åˆ': {name:'å¤©ç¦', realm:'ä½›é“'}, 'æœª': {name:'å¤©é©›', realm:'é¬¼é“'}, 'ç”³': {name:'å¤©å­¤', realm:'äººé“'}, 'é…‰': {name:'å¤©åˆƒ', realm:'ç•œé“'}, 'æˆŒ': {name:'å¤©è—', realm:'ä¿®ç¾…'}, 'äº¥': {name:'å¤©å£½', realm:'ä»™é“'} };
    const STAR_TRAITS = { 'å¤©è²´': { type: 'å‰', keyword: 'è²´äºº/é¡¯èµ«' }, 'å¤©å„': { type: 'å‡¶', keyword: 'å‹ç¢Œ/ç–¾å„' }, 'å¤©æ¬Š': { type: 'å¹³', keyword: 'æ¬ŠåŠ›/ç¤¾äº¤' }, 'å¤©ç ´': { type: 'å‡¶', keyword: 'æ¶ˆè€—/ç ´æ' }, 'å¤©å¥¸': { type: 'å¹³', keyword: 'æ©Ÿæ™º/è®Šå‹•' }, 'å¤©æ–‡': { type: 'å‰', keyword: 'æ™ºæ…§/æ–‡é‡‡' }, 'å¤©ç¦': { type: 'å‰', keyword: 'ç¦æ°£/è²¡ç¥¿' }, 'å¤©é©›': { type: 'å¹³', keyword: 'å¥”æ³¢/è®Šå‹•' }, 'å¤©å­¤': { type: 'å‡¶', keyword: 'å­¤ç¨/ç¨ç«‹' }, 'å¤©åˆƒ': { type: 'å‡¶', keyword: 'å‰›å¼·/è¡€å…‰' }, 'å¤©è—': { type: 'å¹³', keyword: 'æ‰è—/æŠ€è¡“' }, 'å¤©å£½': { type: 'å‰', keyword: 'é•·å£½/åœ“è' } };
    const ROULETTE_PATH = ['å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥', 'å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°'];
    let currentLightIndex=0, globalLastResult=null, globalIsPaused=false, globalSkipAnimation=false, trendChartInstance=null, globalTrendData=null, lastActiveAspect='ç¸½å‘½é‹', aspectClickCounts={};

    function setHTML(id, html) { const el = document.getElementById(id); if(el) el.innerHTML = html; }
    function setText(id, text) { const el = document.getElementById(id); if(el) el.innerText = text; }
    function toggleCard(bodyId) { const body = document.getElementById(bodyId); const arrow = body.previousElementSibling.querySelector('.arrow-icon'); if (body.classList.contains('collapsed')) { body.classList.remove('collapsed'); if(arrow) arrow.classList.remove('collapsed'); } else { body.classList.add('collapsed'); if(arrow) arrow.classList.add('collapsed'); } }
    function getRealmColor(realm) { if(realm.includes('ä½›')) return '#ffd700'; if(realm.includes('ä»™')) return '#4fd1c5'; if(realm.includes('ä¿®ç¾…')) return '#ff9f43'; if(realm.includes('é¬¼')) return '#a0aec0'; if(realm.includes('ç•œ')) return '#8c7853'; return '#e0e0e0'; }
    function getStatusColor(relation) { if(relation==='ç”Ÿæˆ‘'||relation==='æ¯”æ—º') return 'var(--status-best)'; if(relation==='æˆ‘ç”Ÿ') return 'var(--status-good)'; if(relation==='æˆ‘å‰‹') return 'var(--status-growth)'; if(relation==='å‰‹æˆ‘') return 'var(--status-bad)'; return '#888'; }
    function getStrategicAdvice(aspect, relation, star) {
        const starInfo = STAR_TRAITS[star] || { type: 'å¹³', keyword: 'æœªçŸ¥' };
        let context = aspect.includes('ç¸½å‘½é‹') ? 'æ•´é«”é‹å‹¢' : aspect.includes('éŒ¢è²¡') ? 'è²¡å‹™ä½ˆå±€' : 'æ‡‰å°ç­–ç•¥';
        if (relation === 'æ¯”æ—º') return `ğŸ¤ ${context}ï¼šé †å‹¢è€Œç‚ºï¼Œæ“´å¤§${starInfo.keyword}å„ªå‹¢ã€‚`;
        else if (relation === 'ç”Ÿæˆ‘') return `ğŸ ${context}ï¼šè²´äººç›¸åŠ©ï¼Œç²å¾—${starInfo.keyword}æ”¯æŒã€‚`;
        else if (relation === 'æˆ‘ç”Ÿ') return `ğŸ’¡ ${context}ï¼šå±•ç¾${starInfo.keyword}ï¼Œä»¥æ‰è¯æ›æˆæœã€‚`;
        else if (relation === 'å‰‹æˆ‘') return `ğŸ›¡ï¸ ${context}ï¼šå£“åŠ›å·¨å¤§ï¼Œé˜²${starInfo.keyword}ï¼Œå®œä¿å®ˆã€‚`;
        else if (relation === 'æˆ‘å‰‹') return `ğŸ’° ${context}ï¼šç©æ¥µæŒæ§ï¼Œé›–${starInfo.keyword}è¾›è‹¦ä½†å¯æœŸã€‚`;
        return `ğŸ” ${context}ï¼šéœè§€å…¶è®Šã€‚`;
    }

    // [V9.6 é˜²å‘†] ä¾æ“šå±¤ç´šé–å®š/è§£é–è¥¿å…ƒæ›†
    function updateFormUI() {
        const scope = document.getElementById('targetScope').value;
        const solarRadio = document.querySelector('input[name="calendarType"][value="solar"]');
        const lunarRadio = document.querySelector('input[name="calendarType"][value="lunar"]');
        
        // 1. å¼·åˆ¶é–å®šé‚è¼¯
        if (scope === 'year') {
            lunarRadio.checked = true;
            solarRadio.disabled = true;
            solarRadio.parentElement.style.opacity = '0.5';
            solarRadio.parentElement.style.cursor = 'not-allowed';
            solarRadio.parentElement.title = "æµå¹´æ¨æ¼”åƒ…æ”¯æ´è¾²æ›†å¹´ä»½ (é¿å…è·¨å¹´èª¤å·®)";
        } else {
            solarRadio.disabled = false;
            solarRadio.parentElement.style.opacity = '1';
            solarRadio.parentElement.style.cursor = 'pointer';
            solarRadio.parentElement.title = "";
        }

        // 2. æ›´æ–°æ¨™ç±¤æ–‡å­—
        const calType = document.querySelector('input[name="calendarType"]:checked').value;
        const prefix = (calType === 'solar') ? 'è¥¿å…ƒ' : 'è¾²æ›†';
        setText('lblYear', `${prefix}å¹´ä»½`);
        setText('lblMonth', `${prefix}æœˆä»½`);
        setText('lblDay', `${prefix}æ—¥æœŸ`);

        // 3. æ¬„ä½é¡¯ç¤º
        document.getElementById('monthInput').className = (scope !== 'year') ? 'input-group show' : 'input-group';
        document.getElementById('dayInput').className = (scope === 'day' || scope === 'hour') ? 'input-group show' : 'input-group';
        document.getElementById('hourInput').className = (scope === 'hour') ? 'input-group show' : 'input-group';
    }

    function initMap() {
        for(let zhi in DEFAULT_STARS) {
            const cell = document.getElementById('cell-'+zhi);
            if(cell) {
                const info = DEFAULT_STARS[zhi];
                const color = getRealmColor(info.realm);
                cell.innerHTML = `<div class="pillar-badges-container"></div><span class="cell-zhi">${zhi}</span><span class="cell-star" style="color:${color}">${info.name}</span><span class="cell-realm" style="color:${color}; opacity:0.7;">${info.realm}</span>`;
                cell.className = 'grid-cell'; cell.style.boxShadow = 'none';
            }
        }
    }

    function getTargetLabel() {
        const scope = document.getElementById('targetScope').value;
        if (scope === 'year') return document.getElementById('tYear').value;
        if (scope === 'month') return document.getElementById('tMonth').value + "æœˆ";
        if (scope === 'day') return document.getElementById('tDay').value + "æ—¥";
        if (scope === 'hour') { const hVal = document.getElementById('tHour').value; return hVal + "æ™‚"; }
        return "";
    }

    function renderTrendChart(labels, scores, tooltips, title) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        if (trendChartInstance) trendChartInstance.destroy();
        document.getElementById('trendTitle').innerHTML = `æ™‚ç©ºé‹å‹¢æ³¢å½¢åœ– <span style="font-size:0.7em; color:var(--cyan);">(${title})</span>`;
        const gradient = ctx.createLinearGradient(0, 0, 0, 250);
        gradient.addColorStop(0, 'rgba(212, 175, 55, 0.5)');
        gradient.addColorStop(1, 'rgba(212, 175, 55, 0)');
        
        const targetStr = document.getElementById('tYear').value;
        const targetMonth = parseInt(document.getElementById('tMonth').value);
        const targetDay = parseInt(document.getElementById('tDay').value);
        const scope = document.getElementById('targetScope').value;

        const pointBackgroundColors = labels.map((l, i) => {
            let isTarget = false;
            let labelStr = Array.isArray(l) ? l.join("") : l; 
            if (scope === 'year') isTarget = labelStr.includes(targetStr);
            else if (scope === 'month') isTarget = labelStr.includes(`è¾²${targetMonth.toString().padStart(2,'0')}`);
            else if (scope === 'day') isTarget = labelStr.includes(`åˆ${targetDay}`);
            return isTarget ? '#ff4d4d' : '#fff';
        });
        
        const pointBorderColors = pointBackgroundColors.map(c => c === '#ff4d4d' ? '#fff' : '#d4af37');
        const pointRadii = pointBackgroundColors.map(c => c === '#ff4d4d' ? 8 : 4);
        
        trendChartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: [{ label: 'é‹å‹¢èƒ½é‡', data: scores, borderColor: '#d4af37', backgroundColor: gradient, borderWidth: 3, pointBackgroundColor: pointBackgroundColors, pointBorderColor: pointBorderColors, pointRadius: pointRadii, pointBorderWidth: 2, fill: true, tension: 0.4 }] },
            options: { 
                maintainAspectRatio: false, 
                scales: { y: { beginAtZero: true, max: 100, min: 0, grid: {color:'#333'}, ticks: {color:'#888'} }, x: { grid: {color:'#333'}, ticks: {color:'#e0e0e0', font:{size:10}} } }, 
                plugins: { 
                    legend: { display: false },
                    tooltip: { 
                        callbacks: { 
                            title: function(tooltipItems) {
                                let label = tooltipItems[0].label;
                                if(Array.isArray(label)) label = label.join(" ");
                                return label;
                            },
                            label: function(context) {
                                const aspectName = lastActiveAspect;
                                const index = context.dataIndex;
                                const baseScore = globalTrendData.datasets[aspectName][index];
                                const adjustment = (globalTrendData.adjustments[aspectName] || [])[index] || 0;
                                const finalScore = context.raw;
                                const sign = adjustment > 0 ? '+' : '';
                                return `ç¸½åˆ† ${finalScore} = åŸºç¤ ${baseScore} ${adjustment !== 0 ? `(æ˜Ÿå®¿${sign}${adjustment})` : ''}`;
                            },
                            afterLabel: function(ctx) { return tooltips[ctx.dataIndex]; } 
                        }, 
                        backgroundColor: 'rgba(0,0,0,0.9)', titleColor: '#d4af37', bodyFont:{size:13}
                    } 
                } 
            }
        });
    }

    function updateTrendChart(aspectName) {
        if (!globalTrendData || !globalTrendData.datasets[aspectName]) return;
        lastActiveAspect = aspectName;
        if (!aspectClickCounts[aspectName]) aspectClickCounts[aspectName] = 0;
        aspectClickCounts[aspectName]++;

        const isAdjusted = document.getElementById('gradeCheckbox').checked;
        const baseScores = globalTrendData.datasets[aspectName];
        const adjustments = (globalTrendData.adjustments && globalTrendData.adjustments[aspectName]) ? globalTrendData.adjustments[aspectName] : new Array(baseScores.length).fill(0);

        const finalScores = baseScores.map((score, i) => {
            if (!isAdjusted) return score;
            let val = score + adjustments[i];
            return Math.max(5, Math.min(95, val));
        });

        renderTrendChart(globalTrendData.axis_labels, finalScores, globalTrendData.tooltips[aspectName], aspectName + (isAdjusted ? " + åŠ æ¬Š" : ""));
        document.querySelectorAll('.aspect-row').forEach(row => row.classList.remove('active-aspect'));
        const activeRow = document.getElementById(`row-${aspectName}`);
        if(activeRow) activeRow.classList.add('active-aspect');
    }

    function fillLists(result, h) {
        let hHtml = `<div class="hierarchy-step"><span class="step-label">å¤§é‹</span><span class="step-value">${h.big_luck.zhi}å®® ${h.big_luck.name}</span></div><div class="hierarchy-step"><span class="step-label">æµå¹´</span><span class="step-value">${h.year.zhi}å®® ${h.year.name}</span></div>`;
        if(h.month) hHtml += `<div class="hierarchy-step"><span class="step-label">æµæœˆ</span><span class="step-value">${h.month.zhi}å®® ${h.month.name}</span></div>`;
        setHTML('hierarchyArea', hHtml);

        let aHtml = '';
        const targetLabel = getTargetLabel();
        const scope = document.getElementById('targetScope').value;
        const targetMonth = parseInt(document.getElementById('tMonth').value);
        const targetDay = parseInt(document.getElementById('tDay').value);
        const targetStr = document.getElementById('tYear').value;

        // å°‹æ‰¾å°æ‡‰çš„ Data Index (å«é›™æ›†é‚è¼¯)
        let dataIndex = -1;
        if(globalTrendData) {
            dataIndex = globalTrendData.axis_labels.findIndex(l => {
                let labelStr = Array.isArray(l) ? l.join("") : l;
                if (scope === 'year') return labelStr.includes(targetStr);
                else if (scope === 'month') return labelStr.includes(`è¾²${targetMonth.toString().padStart(2,'0')}`);
                else if (scope === 'day') return labelStr.includes(`åˆ${targetDay}`);
                return false;
            });
            // è‹¥æ‰¾ä¸åˆ°å‰‡é è¨­ä¸­é–“
            if (dataIndex === -1) dataIndex = Math.floor(globalTrendData.axis_labels.length / 2);
        }

        result.aspects.forEach(a => {
            let score = 50, baseScore = 50, adjScore = 0, trendHtml = '<span class="trend-icon flat">-</span>';
            
            if (dataIndex !== -1 && globalTrendData.datasets[a.name]) {
                const baseScores = globalTrendData.datasets[a.name];
                const adjustments = globalTrendData.adjustments[a.name] || [];
                const isAdjusted = document.getElementById('gradeCheckbox').checked;

                baseScore = baseScores[dataIndex];
                adjScore = adjustments[dataIndex] || 0;
                let rawScore = baseScore;
                if (isAdjusted) rawScore += adjScore;
                score = Math.max(5, Math.min(95, rawScore));

                if (dataIndex < baseScores.length - 1) {
                    let rawNext = baseScores[dataIndex + 1];
                    if (isAdjusted) rawNext += (adjustments[dataIndex + 1] || 0);
                    let nextScore = Math.max(5, Math.min(95, rawNext));
                    let diff = nextScore - score;
                    if (diff > 25) trendHtml = '<span class="trend-icon up" title="é‹å‹¢é£†å‡">â†—â†—â†—</span>';
                    else if (diff > 15) trendHtml = '<span class="trend-icon up" title="é‹å‹¢å¤§æ¼²">â†—â†—</span>';
                    else if (diff > 5) trendHtml = '<span class="trend-icon up" title="é‹å‹¢å¾®å‡">â†—</span>';
                    else if (diff < -25) trendHtml = '<span class="trend-icon down" title="é‹å‹¢å´©è·Œ">â†˜â†˜â†˜</span>';
                    else if (diff < -15) trendHtml = '<span class="trend-icon down" title="é‹å‹¢å¤§è·Œ">â†˜â†˜</span>';
                    else if (diff < -5) trendHtml = '<span class="trend-icon down" title="é‹å‹¢å¾®è·Œ">â†˜</span>';
                }
            }

            let barColor = '#888';
            if (score >= 80) barColor = 'var(--status-best)'; 
            else if (score >= 65) barColor = 'var(--status-good)';
            else if (score >= 40) barColor = 'var(--status-growth)';
            else barColor = 'var(--status-bad)';

            const isAdjusted = document.getElementById('gradeCheckbox').checked;
            let compHtml = '';
            if (isAdjusted && adjScore !== 0) {
                const sign = adjScore > 0 ? '+' : '';
                const styleClass = adjScore > 0 ? 'score-bonus' : 'score-penalty';
                compHtml = `<span class="score-composition">(${baseScore}<span class="${styleClass}">${sign}${adjScore}</span>)</span>`;
            }

            aHtml += `
            <div id="row-${a.name}" class="aspect-row clickable" onclick="updateTrendChart('${a.name}')">
                <div style="width: 110px; flex-shrink:0;">
                    <div style="display:flex; align-items:center;">
                        <span style="color:var(--cyan); font-weight:bold; font-size:1em;">${a.name}</span>
                        ${trendHtml}
                    </div>
                    <div style="font-size:0.75em; color:#888; margin-top:2px;">${a.zhi} | <b style="color:#ddd;">${a.star}</b></div>
                </div>
                <div style="flex:1; display:flex; flex-direction:column; justify-content:center; padding:0 5px;">
                    <div style="display:flex; align-items:center; margin-bottom:3px;">
                        <div style="width:70px; text-align:right; margin-right:6px; white-space:nowrap;">
                            <span style="font-size:0.9em; color:${barColor}; font-weight:bold;">${score}</span>
                            ${compHtml}
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width:${score}%; background:${barColor}; box-shadow: 0 0 8px ${barColor};"></div>
                        </div>
                    </div>
                    <div class="aspect-advice" style="font-size:0.8em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; opacity:0.8;">
                        ${getStrategicAdvice(a.name, a.relation, a.star)}
                    </div>
                </div>
                <div style="display:flex; align-items:center; gap:5px; width:85px; justify-content:flex-end;">
                    <div class="aspect-tag" style="background:${getStatusColor(a.relation)}; font-size:0.7em; padding:2px 4px; min-width:40px;">${a.relation}</div>
                    <button class="mini-ai-btn" onclick="event.stopPropagation(); lastActiveAspect='${a.name}'; callAIWithMode('script');">ğŸ¤–</button>
                </div>
            </div>`;
        });
        setHTML('aspectsList', aHtml);
        setText('aiPrompt', result.ai_prompt);
        if(result.trend_data) { globalTrendData = result.trend_data; updateTrendChart('ç¸½å‘½é‹'); }
    }

    // CRM ç›¸é—œåŠŸèƒ½
    function openSaveModal() { document.getElementById('saveModal').style.display = 'flex'; }
    function closeSaveModal() { document.getElementById('saveModal').style.display = 'none'; }
    function toggleTag(el) { el.classList.toggle('selected'); }

    async function confirmSave() {
        const name = document.getElementById('crmName').value || "æœªå‘½å";
        const phone = document.getElementById('crmPhone').value;
        const note = document.getElementById('crmNote').value;
        const tags = [];
        document.querySelectorAll('.tag-chip.selected').forEach(el => tags.push(el.innerText));

        let maxClickedAspect = "ç„¡", maxCount = 0;
        for (const [key, count] of Object.entries(aspectClickCounts)) {
            if (count > maxCount) { maxCount = count; maxClickedAspect = key; }
        }
        
        const aiLog = {
            advice: document.getElementById('aiResponseArea').innerText.substring(0, 200) + "...", 
            most_focused: `${maxClickedAspect} (${maxCount}æ¬¡)`,
            last_focused: lastActiveAspect
        };

        const data = {
            solar_date: document.getElementById('solarDate').value,
            gender: parseInt(document.getElementById('gender').value),
            hour: document.getElementById('hour').value,
            target_year: parseInt(document.getElementById('tYear').value),
            client_name: name, phone: phone, tags: tags, note: note, ai_log: aiLog
        };

        const btn = document.querySelector('.modal-footer .active');
        const originalText = btn.innerText;
        btn.innerText = "å„²å­˜ä¸­...";
        try {
            const res = await fetch('/api/save_record', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
            });
            const result = await res.json();
            if(result.status === 'success') {
                alert(`âœ… ${name} çš„æª”æ¡ˆå·²å»ºç«‹ï¼\nç³»çµ±å·²è‡ªå‹•ç´€éŒ„å…¶æœ€é—œæ³¨ï¼š${aiLog.most_focused}`);
                closeSaveModal(); loadHistory();
            } else { alert("âŒ å„²å­˜å¤±æ•—ï¼š" + result.message); }
        } catch(e) { alert("é€£ç·šéŒ¯èª¤ï¼š" + e.message); } finally { btn.innerText = originalText; }
    }

    async function loadHistory() {
        const listDiv = document.getElementById('historyList');
        listDiv.innerHTML = "è¼‰å…¥ä¸­...";
        try {
            const res = await fetch('/api/get_history'); 
            const history = await res.json();
            let html = '<ul style="padding-left:10px; margin:0; list-style:none;">';
            history.forEach(item => {
                const jsonStr = JSON.stringify(item).replace(/"/g, '&quot;');
                let tagsHtml = item.tags ? item.tags.map(t => `<span style="background:#333; padding:1px 4px; font-size:0.7em; border-radius:3px; margin-right:3px;">${t}</span>`).join('') : '';
                html += `
                <li style="margin-bottom:12px; cursor:pointer; border-bottom:1px solid #333; padding-bottom:8px;" onclick="restoreFromHistory(${jsonStr})">
                    <div style="display:flex; justify-content:space-between;">
                        <b style="color:var(--gold); font-size:1.1em;">${item.client_name}</b>
                        <span style="color:#666; font-size:0.8em;">${item.created_at.split(' ')[0]}</span>
                    </div>
                    <div style="color:#aaa; font-size:0.9em; margin:2px 0;">${item.note || "ç„¡å‚™è¨»"}</div>
                    <div style="margin-top:4px;">${tagsHtml}</div>
                </li>`;
            });
            html += '</ul>';
            listDiv.innerHTML = history.length > 0 ? html : "å°šç„¡ç´€éŒ„";
        } catch(e) { listDiv.innerHTML = "è®€å–å¤±æ•—"; }
    }

    function restoreFromHistory(item) {
        document.getElementById('solarDate').value = item.solar_date;
        document.getElementById('gender').value = item.gender;
        document.getElementById('hour').value = item.hour;
        document.getElementById('tYear').value = item.target_year;
        alert(`å·²è¼‰å…¥ï¼š${item.client_name} çš„è³‡æ–™ï¼Œå³å°‡é–‹å§‹æ¨æ¼”...`);
        calculate();
    }

    function renderFullView(result) {
        initMap();
        const h = result.hierarchy;
        const pillars = [ { k:'å¹´', c:'var(--p-year)', z:result.base_chart.å¹´æŸ±.zhi, n:result.base_chart.å¹´æŸ±.name }, { k:'æœˆ', c:'var(--p-month)', z:result.base_chart.æœˆæŸ±.zhi, n:result.base_chart.æœˆæŸ±.name }, { k:'æ—¥', c:'var(--p-day)', z:result.base_chart.æ—¥æŸ±.zhi, n:result.base_chart.æ—¥æŸ±.name }, { k:'å‘½', c:'var(--p-hour)', z:result.base_chart.æ™‚æŸ±.zhi, n:result.base_chart.æ™‚æŸ±.name } ];
        let pillarsHtml = '';
        pillars.forEach(p => { addBadgeToCell(p.z, p.k, p.c, true); pillarsHtml += `<div class="pillar-box active" style="border-color:${p.c};"><div style="color:${p.c}; font-weight:bold;">${p.n}</div><div style="font-size:0.8em;">${p.z}</div></div>`; });
        setHTML('pillarsArea', pillarsHtml);
        if(h.big_luck) addBadgeToCell(h.big_luck.zhi, 'å¤§é‹', 'var(--p-luck)', true);
        if(h.year) addBadgeToCell(h.year.zhi, 'æµå¹´', 'var(--p-year)', true);
        const targetScope = document.getElementById('targetScope').value;
        if(['month','day','hour'].includes(targetScope) && h.month) addBadgeToCell(h.month.zhi, 'æµæœˆ', 'var(--p-month)', true);
        if(['day','hour'].includes(targetScope) && h.day) addBadgeToCell(h.day.zhi, 'æµæ—¥', 'var(--p-day)', true);
        if(targetScope==='hour' && h.hour) addBadgeToCell(h.hour.zhi, 'æµæ™‚', 'var(--p-hour)', true);
        
        result.aspects.forEach(a => {
            const cell = document.getElementById('cell-'+a.zhi);
            if(cell && !cell.querySelector('.cell-aspect-name')) {
                cell.innerHTML += `<div class="cell-aspect-name show-content">${a.name}</div><div class="cell-relation-tag" style="background:${getStatusColor(a.relation)}; color:#1a2634;">${a.relation}</div>`;
                if(a.is_alert) cell.classList.add('alert');
            }
        });
        fillLists(result, h);
    }

    function togglePause() { globalIsPaused = !globalIsPaused; }
    function skipToComplete() { if(globalLastResult) { globalSkipAnimation=true; renderFullView(globalLastResult); } }
    function replayAnimation() { if(globalLastResult) startAnimationSequence(globalLastResult); }
    function addBadgeToCell(zhi, text, color, instant) { const cell = document.getElementById('cell-'+zhi); if(cell) { cell.classList.add('active'); const c = cell.querySelector('.pillar-badges-container'); if(c && !Array.from(c.children).some(e=>e.innerText===text)) { const b = document.createElement('span'); b.className='pillar-badge'; b.style.background=color; b.innerText=text; c.appendChild(b); if(instant) b.classList.add('show'); else setTimeout(()=>b.classList.add('show'),50); } } }
    function runRoulette(targetZhi, isMale) { return new Promise(resolve => { let rounds=0, maxRounds=1, speed=80; const targetIndex = ROULETTE_PATH.indexOf(targetZhi); const step = isMale ? 1 : -1; function nextStep() { if(globalSkipAnimation) { resolve(); return; } if(globalIsPaused) { setTimeout(nextStep, 100); return; } const prev = document.getElementById('cell-'+ROULETTE_PATH[currentLightIndex]); if(prev) prev.classList.remove('roulette-active'); currentLightIndex = (currentLightIndex + step + 12) % 12; const curr = document.getElementById('cell-'+ROULETTE_PATH[currentLightIndex]); if(curr) curr.classList.add('roulette-active'); if(rounds>=maxRounds && currentLightIndex===targetIndex) { if(curr) curr.classList.add('flash-stop'); setTimeout(()=>{ if(curr){curr.classList.remove('roulette-active'); curr.classList.remove('flash-stop');} resolve(); }, 1500); return; } if(currentLightIndex===0) rounds++; if(rounds>=maxRounds) speed+=40; setTimeout(nextStep, speed); } nextStep(); }); }

    async function startAnimationSequence(result) {
        document.getElementById('loadingOverlay').style.display='none'; document.getElementById('animControls').style.display='flex';
        globalSkipAnimation=false; globalIsPaused=false; initMap(); setHTML('pillarsArea','');
        const isMale = (parseInt(document.getElementById('gender').value)===1);
        setText('lunarInfo', `| è™›æ­² ${result.age} | ${result.lunar_info}`);
        setText('targetDisplayInfo', result.target_display);
        const p = result.base_chart;
        const list = [{z:p.å¹´æŸ±.zhi, n:p.å¹´æŸ±.name, c:'var(--p-year)', k:'å¹´'}, {z:p.æœˆæŸ±.zhi, n:p.æœˆæŸ±.name, c:'var(--p-month)', k:'æœˆ'}, {z:p.æ—¥æŸ±.zhi, n:p.æ—¥æŸ±.name, c:'var(--p-day)', k:'æ—¥'}, {z:p.æ™‚æŸ±.zhi, n:p.æ™‚æŸ±.name, c:'var(--p-hour)', k:'å‘½'}];
        for(let item of list) { if(globalSkipAnimation) break; await runRoulette(item.z, isMale); addBadgeToCell(item.z, item.k, item.c); document.getElementById('pillarsArea').innerHTML += `<div class="pillar-box active" style="border-color:${item.c}"><div style="color:${item.c}">${item.n}</div><div>${item.z}</div></div>`; }
        renderFullView(result);
    }

    async function calculate() {
        document.getElementById('loadingOverlay').style.display='flex';
        const data = { gender: parseInt(document.getElementById('gender').value), solar_date: document.getElementById('solarDate').value, hour: document.getElementById('hour').value, target_calendar: document.querySelector('input[name="calendarType"]:checked').value, target_scope: document.getElementById('targetScope').value, target_year: parseInt(document.getElementById('tYear').value)||2026, target_month: parseInt(document.getElementById('tMonth').value)||1, target_day: parseInt(document.getElementById('tDay').value)||1, target_hour: document.getElementById('tHour').value };
        try { const res = await fetch('/api/calculate', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)}); if(!res.ok) throw new Error((await res.json()).detail); globalLastResult = await res.json(); startAnimationSequence(globalLastResult); } catch(e) { alert("âŒ æ’ç›¤å¤±æ•—ï¼š\n"+e.message); document.getElementById('loadingOverlay').style.display='none'; }
    }

    async function callAIWithMode(mode) {
        const aspectName = lastActiveAspect || 'ç¸½å‘½é‹'; 
        const targetLabel = getTargetLabel();
        const dataIndex = globalTrendData.axis_labels.indexOf(targetLabel);
        
        if (!globalTrendData || dataIndex === -1) { alert("è«‹å…ˆå®Œæˆæ’ç›¤ï¼"); return; }

        let strongest = { name: '', score: -1, star: '' };
        let weakest = { name: '', score: 999, star: '' };
        let currentAspectData = { score: 0, relation: '', star: '' };

        for (const key in globalTrendData.datasets) {
            const score = globalTrendData.datasets[key][dataIndex];
            const tooltipRaw = globalTrendData.tooltips[key][dataIndex] || ""; 
            const starName = tooltipRaw.split('å')[1]?.split(' ')[0] || "æœªçŸ¥";
            const relationName = tooltipRaw.split('(')[1]?.split(')')[0] || "æœªçŸ¥";
            if (key === aspectName) currentAspectData = { score, relation: relationName, star: starName };
            if (score > strongest.score) strongest = { name: key, score, star: starName };
            if (score < weakest.score) weakest = { name: key, score, star: starName };
        }

        let maxClickedAspect = aspectName, maxCount = 0, totalClicks = 0;
        for (const [key, count] of Object.entries(aspectClickCounts)) { totalClicks += count; if (count > maxCount) { maxCount = count; maxClickedAspect = key; } }
        let behaviorInsight = "";
        if (totalClicks >= 3 && maxClickedAspect !== aspectName) {
            behaviorInsight = `âš ï¸ æ½›åœ¨ç„¦æ…®åµæ¸¬ï¼šæ¡ˆä¸»ç›®å‰åœç•™åœ¨ã€${aspectName}ã€‘ï¼Œä½†æ•¸æ“šé¡¯ç¤ºä»–æŸ¥çœ‹ã€${maxClickedAspect}ã€‘æ¬¡æ•¸æœ€å¤šï¼ˆ${maxCount}æ¬¡ï¼‰ã€‚è«‹åˆ†æé€™å…©è€…çš„é€£å‹•é—œä¿‚ï¼ˆä¾‹å¦‚ï¼šæ˜¯å¦å› ${maxClickedAspect}çš„å•é¡Œå°è‡´äº†${aspectName}çš„å›°å¢ƒï¼Ÿï¼‰ã€‚`;
        }

        let specificPrompt = "", loadingText = "";
        if (mode === 'general') {
            loadingText = `ğŸ”® æˆ°ç•¥é¡§å•æ­£åœ¨é€²è¡Œã€${aspectName}ã€‘å…¨ç›¤äº¤å‰æ¯”å°...`;
            specificPrompt = `è«‹é€²è¡Œå…¨ç›¤æˆ°ç•¥æ¨æ¼”ã€‚é‡é»åˆ†æã€${aspectName}ã€‘ç›®å‰çš„è™•å¢ƒ (${currentAspectData.score}åˆ†, ${currentAspectData.relation})ã€‚ä¸¦æŒ‡å‡ºã€${weakest.name}ã€‘(${weakest.score}åˆ†) æ˜¯å¦ç‚ºæ½›åœ¨é¢¨éšªï¼Œä»¥åŠå¦‚ä½•åˆ©ç”¨ã€${strongest.name}ã€‘(${strongest.score}åˆ†) ä¾†å€ŸåŠ›ä½¿åŠ›ã€‚${behaviorInsight} è¼¸å‡ºæ ¼å¼ï¼šã€å±€å‹¢ç¸½è¦½ã€‘ã€ã€é—œéµæˆ°è¡“(3é»)ã€‘ã€ã€é€£é–åæ‡‰é è­¦ã€‘ã€ã€æˆåŠŸç‡é ä¼°ã€‘ã€‚`;
        } else if (mode === 'weakest') {
            loadingText = `ğŸ’” æ­£åœ¨æƒæå…¨ç›¤æœ€å¼±ç’°ç¯€èˆ‡ç—…ç¶...`;
            specificPrompt = `è«‹å°ˆæ³¨åˆ†ææ¡ˆä¸»çš„ã€è‡´å‘½å¼±é»/ç—…ç¶ã€‘ã€‚å…¨ç›¤æœ€å¼±çš„å®®ä½æ˜¯ã€${weakest.name}ã€‘ï¼Œåˆ†æ•¸åƒ… ${weakest.score} åˆ†ï¼Œå ${weakest.star}ã€‚1. è«‹è§£é‡‹ç‚ºä»€éº¼ ${weakest.name} æœƒå´©ç›¤ï¼Ÿ(çµåˆæ˜Ÿå®¿ç‰¹æ€§) 2. é€™å€‹å¼±é»æœƒå¦‚ä½•æ‹–ç´¯æ¡ˆä¸»æœ€åœ¨æ„çš„ã€${aspectName}ã€‘ï¼Ÿ3. è«‹çµ¦å‡ºã€Œæ­¢è¡€ç™‚å‚·ã€çš„å…·é«”æ–¹æ¡ˆï¼Œå¦‚ä½•å°‡å‚·å®³é™åˆ°æœ€ä½ï¼Ÿè¼¸å‡ºæ ¼å¼ï¼šã€ç—…ç¶è¨ºæ–·ã€‘ã€ã€é€£å¸¶å‚·å®³åˆ†æã€‘ã€ã€æ­¢è¡€æ€¥æ•‘æ–¹æ¡ˆã€‘ã€‚`;
        } else if (mode === 'timing') {
            loadingText = `ğŸ“… æ­£åœ¨ç‚ºã€${aspectName}ã€‘è¨ˆç®—æœ€ä½³é€²æ”»çª—å£...`;
            const scores = globalTrendData.datasets[aspectName];
            const labels = globalTrendData.axis_labels;
            let maxVal = -1, maxIdx = -1, minVal = 999, minIdx = -1;
            scores.forEach((s, i) => { if (s > maxVal) { maxVal = s; maxIdx = i; } if (s < minVal) { minVal = s; minIdx = i; } });
            specificPrompt = `æ¡ˆä¸»æƒ³çŸ¥é“ã€${aspectName}ã€‘çš„è¡Œå‹•æ™‚æ©Ÿã€‚æ ¹æ“šæ³¢å½¢åœ–æ•¸æ“šï¼š- æœ€ä½³æ™‚æ©Ÿ (é€²æ”»)ï¼šåœ¨ã€${labels[maxIdx]}ã€‘ï¼Œèƒ½é‡é«˜é” ${maxVal} åˆ†ã€‚- æœ€å·®æ™‚æ©Ÿ (é¿éšª)ï¼šåœ¨ã€${labels[minIdx]}ã€‘ï¼Œèƒ½é‡è·Œè‡³ ${minVal} åˆ†ã€‚è«‹çµ¦å‡ºæ™‚é–“æˆ°ç•¥ï¼š1. åœ¨æœ€ä½³æ™‚æ©Ÿé©åˆåšä»€éº¼å¤§äº‹ï¼Ÿ2. åœ¨æœ€å·®æ™‚æ©Ÿæ‡‰è©²å¦‚ä½•é¿éšªï¼Ÿ3. é‡å°ç›®å‰çš„ç›®æ¨™æ™‚é–“é» (${targetLabel})ï¼Œæ˜¯è©²é€²é‚„æ˜¯è©²é€€ï¼Ÿè¼¸å‡ºæ ¼å¼ï¼šã€é»ƒé‡‘é€²æ”»æœŸã€‘ã€ã€ç´…è‰²è­¦æˆ’æœŸã€‘ã€ã€ç•¶ä¸‹è¡Œå‹•å»ºè­°ã€‘ã€‚`;
        } else if (mode === 'script') {
            loadingText = `ğŸ—£ï¸ æ­£åœ¨ç‚ºæ‚¨ç”Ÿæˆé‡å°ã€${aspectName}ã€‘çš„è«‡åˆ¤åŠ‡æœ¬...`;
            specificPrompt = `æ¡ˆä¸»éœ€è¦é‡å°ã€${aspectName}ã€‘çš„å¯¦æˆ°è©±è¡“/åŠ‡æœ¬ã€‚ç•¶å‰æƒ…å¢ƒï¼šåˆ†æ•¸ ${currentAspectData.score} åˆ†ï¼Œé—œä¿‚ç‚º ${currentAspectData.relation}ï¼Œå°æ–¹/ç’°å¢ƒå¸¶æœ‰ ${currentAspectData.star} çš„ç‰¹æ€§ã€‚è«‹è¨­è¨ˆ 3 çµ„å°è©±åŠ‡æœ¬æˆ–è‡ªæˆ‘å°è©±å¿ƒæ³•ï¼š1. **ã€é€²æ”»å‹åŠ‡æœ¬ã€‘**ï¼šå¦‚æœè¦çˆ­å–è³‡æºæˆ–è«‡åˆ¤ï¼Œè©²æ€éº¼èªªï¼Ÿ(åˆ©ç”¨ ${currentAspectData.star} çš„å¼±é») 2. **ã€é˜²å®ˆå‹åŠ‡æœ¬ã€‘**ï¼šå¦‚æœé¢è‡¨è³ªç–‘æˆ–å£“åŠ›ï¼Œè©²å¦‚ä½•åœ“æ»‘å›æ‡‰ï¼Ÿ3. **ã€å¿ƒç†å»ºè¨­ã€‘**ï¼šä¸€å¥è©±çš„åº§å³éŠ˜ï¼Œç”¨ä¾†ç©©å®šè»å¿ƒã€‚`;
        }

        const aiBody = document.getElementById('aiBody');
        if(aiBody.classList.contains('collapsed')) toggleCard('aiBody');
        setHTML('aiResponseArea', loadingText);

        const finalPrompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šã€Šé”æ‘©ä¸€æŒç¶“ã€‹çš„æˆ°ç•¥é¡§å•ã€‚ä¾æ“šè³‡æ–™ï¼š${specificPrompt}`;
        try {
            const res = await fetch('/api/ask_ai', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({prompt:finalPrompt})});
            const d = await res.json();
            setHTML('aiResponseArea', d.reply.replace(/\n/g, '<br>') || d.error);
        } catch(e) { setHTML('aiResponseArea', 'é€£ç·šå¤±æ•—ï¼š'+e.message); }
    }
    
    initMap(); updateFormUI();
</script>
</body>
</html>
