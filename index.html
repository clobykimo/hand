<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”æ‘©ä¸€æŒç¶“ï¼ç”Ÿå‘½è—åœ–å°èˆªç³»çµ± (V9.9.27)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --bg-color: #121820; --panel-bg: #1e2732; --gold: #d4af37;
            --bronze: #8c7853; --cyan: #4fd1c5; --danger: #ff4d4d;
            --text-main: #e0e0e0; --text-sub: #a0a0a0; --gpt-color: #10a37f;
            --p-year: #d4af37; --p-month: #4fd1c5; --p-day: #ff9f43; --p-hour: #a3a3ff; --p-luck: #2ecc71;
            --status-best: #ffd700; --status-good: #ADD8E6; --status-growth: #90EE90; --status-bad: #ff4d4d;
        }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: "Microsoft JhengHei", serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        h1 { color: var(--gold); letter-spacing: 5px; margin-bottom: 20px; text-shadow: 0 0 10px rgba(212,175,55,0.4); }
        .dashboard { display: grid; grid-template-columns: 380px 1fr; gap: 25px; width: 100%; max-width: 1400px; }
        .control-panel, .card { background: var(--panel-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--bronze); margin-bottom: 20px; }
        .control-panel { height: fit-content; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: sticky; top: 20px; }
        label { display: block; margin-bottom: 5px; color: var(--cyan); font-size: 0.9em; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 15px; background: #151b24; border: 1px solid #4a5568; color: white; border-radius: 4px; box-sizing: border-box; font-size: 1rem; }
        button.btn-main { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--bronze), var(--gold)); border: none; font-weight: bold; font-size: 1.2em; border-radius: 4px; cursor: pointer; color: #1a2634; margin-top: 15px; box-shadow: 0 4px 15px rgba(212,175,55,0.3); }
        button.btn-main:hover { filter: brightness(1.15); transform: translateY(-2px); }
        .ctrl-btn { background: #333; color: #ddd; border: 1px solid #555; padding: 4px 12px; border-radius: 4px; cursor: pointer; margin-left: 8px; }
        .ctrl-btn.active { background: var(--gold); color: #1a2634; }
        .ctrl-btn.finish { border-color: var(--cyan); color: var(--cyan); }
        .card-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; transition: opacity 0.2s; }
        .card-header:hover { opacity: 0.8; }
        .arrow-icon { transition: transform 0.3s ease; font-size: 0.8em; color: var(--cyan); }
        .arrow-icon.collapsed { transform: rotate(-90deg); }
        .card-body { overflow: hidden; transition: max-height 0.4s cubic-bezier(0, 1, 0, 1), opacity 0.4s ease-in-out, margin-top 0.4s; max-height: 2000px; opacity: 1; margin-top: 15px; }
        .card-body.collapsed { max-height: 0; opacity: 0; margin-top: 0; }
        
        /* Map Styles */
        .twelve-palaces-map { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 130px); gap: 12px; padding: 15px; margin-top: 0; background: rgba(0,0,0,0.2); border: 1px solid #444; border-radius: 8px; grid-template-areas: "si wu wei shen" "chen . . you" "mao . . xu" "yin chou zi hai"; }
        .grid-cell { position: relative; background: #2a3544; border: 1px solid #3f4a5a; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; }
        .grid-cell.active { border-color: var(--gold); background: #3a4555; }
        .grid-cell.target { box-shadow: 0 0 25px var(--cyan) !important; border-color: #fff !important; }
        .grid-cell.roulette-active { background: #fff !important; border-color: var(--gold); transform: scale(1.05); z-index: 100; }
        .grid-cell.roulette-active .cell-star { color: #000 !important; }
        .cell-zhi { position: absolute; top: 5px; left: 8px; font-size: 1em; color: #555; font-weight: bold; }
        .cell-star { font-size: 1.7em; font-weight: bold; color: #ddd; z-index: 1; }
        .cell-aspect-name { font-size: 0.95em; color: var(--cyan); font-weight: bold; border-top: 1px solid rgba(255,255,255,0.1); width: 85%; text-align: center; margin-top: 4px; }
        .cell-realm { font-size: 0.7em; color: #555; position:absolute; bottom: 3px; right: 5px; }
        .cell-relation-tag { position: absolute; top: 5px; right: 5px; font-size: 0.75em; padding: 2px 6px; border-radius: 3px; font-weight: bold; color: #1a2634; }
        .pillar-badges-container { position: absolute; top: 25px; left: 4px; display: flex; flex-direction: column; gap: 3px; }
        .pillar-badge { font-size: 0.65em; padding: 1px 5px; border-radius: 3px; color: #1a2634; font-weight: bold; opacity:0; }
        .pillar-badge.show { opacity: 1; }
        
        /* Dashboard Components */
        .aspect-row { border-bottom: 1px solid #333; padding: 14px 8px; display: flex; align-items: center; justify-content: space-between; gap: 10px; transition: background 0.2s; }
        .aspect-row.clickable { cursor: pointer; border-left: 3px solid transparent; }
        .aspect-row.clickable:hover { background: rgba(212, 175, 55, 0.1); border-left: 3px solid var(--gold); }
        .aspect-row.active-aspect { background: rgba(79, 209, 197, 0.15); border-left: 3px solid var(--cyan); }
        .aspect-tag { padding: 4px 10px; border-radius: 4px; font-size: 0.9em; text-align: center; min-width: 50px; color: #1a2634; font-weight:bold; }
        .checkbox-wrapper { margin-bottom: 10px; display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--gold); font-weight: bold; user-select: none; }
        .checkbox-wrapper input { width: 18px; height: 18px; cursor: pointer; margin: 0; }
        
        .ai-controls { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .ai-shortcut-btn { flex: 1; background: #2d3748; border: 1px solid #4a5568; color: #cbd5e0; padding: 8px 5px; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .ai-shortcut-btn:hover { background: #4a5568; color: white; border-color: var(--gpt-color); transform: translateY(-2px); }
        .mini-ai-btn { background: transparent; border: 1px solid var(--gpt-color); color: var(--gpt-color); border-radius: 4px; width: 26px; height: 26px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: 8px; transition: all 0.2s; }
        .mini-ai-btn:hover { background: var(--gpt-color); color: white; transform: scale(1.1); box-shadow: 0 0 10px rgba(16, 163, 127, 0.4); }
        
        .progress-container { flex: 1; height: 6px; background: #333; border-radius: 3px; margin: 0 8px; overflow: hidden; position: relative; }
        .progress-bar { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
        .trend-icon { font-weight: bold; margin-left: 5px; font-size: 1.1em; }
        .trend-icon.up { color: #ff4d4d; animation: pulse 2s infinite; }
        .trend-icon.down { color: #4fd1c5; }
        .trend-icon.flat { color: #666; font-size: 0.8em; }
        .score-composition { font-size: 0.7em; color: #888; margin-left: 4px; font-weight: normal; }
        .score-bonus { color: #ffd700; }
        .score-penalty { color: #ff4d4d; }

        /* [V9.9.23] å…¨èƒ½çµæ¡ˆç¥å™¨æ¨£å¼ */
        #exportContainer {
            position: absolute; left: -9999px; top: 0;
            width: 1200px; /* A4å¯¬åº¦æ„Ÿ */
            background: #101015; color: #e0e0e0;
            padding: 40px;
            border: 4px double var(--gold);
            font-family: "Microsoft JhengHei", serif;
            box-sizing: border-box;
        }
        .export-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .export-header { 
            border-bottom: 2px solid var(--gold); padding-bottom: 20px; margin-bottom: 30px; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .export-title { font-size: 2.5em; color: var(--gold); font-weight: bold; letter-spacing: 5px; text-shadow: 0 0 10px rgba(212,175,55,0.3); }
        .export-info { text-align: right; color: #aaa; font-size: 1.1em; line-height: 1.5; }
        .export-section-title { color: var(--cyan); border-left: 5px solid var(--gold); padding-left: 15px; margin-bottom: 15px; font-size: 1.5em; font-weight: bold; }
        .export-chart-img { width: 100%; border-radius: 8px; border: 1px solid #444; background: #1e2732; }
        
        .export-list-item { 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 8px 0; border-bottom: 1px solid #333; font-size: 1.1em; 
        }
        .export-footer { 
            text-align: center; margin-top: 40px; padding-top: 20px; 
            border-top: 1px solid #333; color: var(--bronze); font-size: 1.2em; 
            letter-spacing: 2px; font-weight: bold;
        }
        .highlight-box {
            background: rgba(212, 175, 55, 0.1); border: 1px solid var(--gold);
            padding: 20px; border-radius: 8px; margin-top: 20px;
        }

        .switch-container { display: flex; align-items: center; gap: 8px; margin-left: auto; margin-right: 10px; }
        .switch-label { font-size: 0.8em; color: #888; font-weight: bold; }
        .switch { position: relative; display: inline-block; width: 36px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 18px; border: 1px solid #555; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 2px; bottom: 2px; background-color: #888; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--gold); border-color: var(--gold); }
        input:checked + .slider:before { transform: translateX(18px); background-color: #1a2634; }
        .switch:hover .slider { border-color: #888; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center; }
        .modal-content { background-color: #1e2732; border: 1px solid var(--gold); padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 0 20px rgba(0,0,0,0.8); }
        .modal h3 { color: var(--gold); margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .tag-container { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px; }
        .tag-chip { font-size: 0.8em; padding: 2px 8px; border-radius: 10px; background: #333; cursor: pointer; border: 1px solid #555; user-select: none; color: #ddd; }
        .tag-chip.selected { background: var(--cyan); color: #000; border-color: var(--cyan); }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

        @media (max-width: 950px) { .dashboard { grid-template-columns: 1fr; } .control-panel { position: static; } }
        #loadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #333; border-top: 4px solid var(--gold); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .show-content { opacity: 1 !important; }
        .input-group { display: none; }
        .input-group.show { display: block; }
        .four-pillars { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .pillar-box { background: #252f3a; padding: 10px; text-align: center; border: 1px solid #444; border-radius: 6px; opacity: 0.3; }
        .pillar-box.active { opacity: 1; border-color: var(--gold); }
        .center-decoration { grid-area: 2 / 2 / 4 / 4; display: flex; justify-content: center; align-items: center; opacity: 0.3; pointer-events: none; border: 2px dashed var(--bronze); border-radius: 50%; margin: 15px; }
        .ai-btn { background: var(--gpt-color); color: white; border: none; padding: 6px 20px; border-radius: 4px; cursor: pointer; margin-left: 10px; font-weight:bold; }
    </style>
</head>
<body>
<div id="loadingOverlay"><div class="spinner"></div></div>
<h1>é”æ‘©ä¸€æŒç¶“ï¼ç”Ÿå‘½è—åœ–å°èˆªç³»çµ±</h1>
<div class="dashboard">
    <div class="control-panel">
        <h3 style="color:var(--cyan); border-bottom:1px solid #444;">1. è¨­å®šæ¡ˆä¸»æœ¬å‘½</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div><label>æ€§åˆ¥</label><select id="gender"><option value="1">ç”· (é †è¡Œ)</option><option value="0">å¥³ (é€†è¡Œ)</option></select></div>
            <div>
                <label>å‡ºç”Ÿæ™‚è¾°</label>
                <select id="hour">
                    <option value="å­">å­æ™‚ (23:00-01:00)</option><option value="ä¸‘">ä¸‘æ™‚ (01:00-03:00)</option><option value="å¯…">å¯…æ™‚ (03:00-05:00)</option>
                    <option value="å¯">å¯æ™‚ (05:00-07:00)</option><option value="è¾°">è¾°æ™‚ (07:00-09:00)</option><option value="å·³">å·³æ™‚ (09:00-11:00)</option>
                    <option value="åˆ">åˆæ™‚ (11:00-13:00)</option><option value="æœª">æœªæ™‚ (13:00-15:00)</option><option value="ç”³">ç”³æ™‚ (15:00-17:00)</option>
                    <option value="é…‰">é…‰æ™‚ (17:00-19:00)</option><option value="æˆŒ">æˆŒæ™‚ (19:00-21:00)</option><option value="äº¥">äº¥æ™‚ (21:00-23:00)</option>
                </select>
            </div>
        </div>
        <label>åœ‹æ›†å‡ºç”Ÿæ—¥æœŸ</label><input type="date" id="solarDate" value="1985-03-27">
        <h3 style="color:var(--gold); border-bottom:1px solid #444; margin-top:20px;">2. è¨­å®šæ¨ç®—ç›®æ¨™</h3>
        <div style="display:flex; gap:20px; margin-bottom:10px;">
            <label style="color:white; cursor:pointer;"><input type="radio" name="calendarType" value="lunar" checked onchange="updateFormUI()"> è¾²æ›†</label>
            <label style="color:white; cursor:pointer;"><input type="radio" name="calendarType" value="solar" onchange="updateFormUI()"> è¥¿å…ƒæ›†</label>
        </div>
        <label>æ¨æ¼”å±¤ç´š</label>
        <select id="targetScope" onchange="updateFormUI()">
            <option value="year">æµå¹´ (åªçœ‹å¹´)</option><option value="month">æµæœˆ (å¹´+æœˆ)</option>
            <option value="day">æµæ—¥ (å¹´+æœˆ+æ—¥)</option><option value="hour">æµæ™‚ (å¹´+æœˆ+æ—¥+æ™‚)</option>
        </select>
        
        <div id="yearInput" class="input-group show"><label id="lblYear">è¾²æ›†å¹´ä»½</label><input type="number" id="tYear" value="2026"></div>
        <div id="monthInput" class="input-group"><label id="lblMonth">è¾²æ›†æœˆä»½</label><input type="number" id="tMonth" value="1" min="1" max="12"></div>
        <div id="dayInput" class="input-group"><label id="lblDay">è¾²æ›†æ—¥æœŸ</label><input type="number" id="tDay" value="1" min="1" max="31"></div>
        
        <div id="hourInput" class="input-group">
            <label>æ™‚è¾°</label>
            <select id="tHour">
                <option value="å­">å­æ™‚ (23:00-01:00)</option><option value="ä¸‘">ä¸‘æ™‚ (01:00-03:00)</option><option value="å¯…">å¯…æ™‚ (03:00-05:00)</option>
                <option value="å¯">å¯æ™‚ (05:00-07:00)</option><option value="è¾°">è¾°æ™‚ (07:00-09:00)</option><option value="å·³">å·³æ™‚ (09:00-11:00)</option>
                <option value="åˆ">åˆæ™‚ (11:00-13:00)</option><option value="æœª">æœªæ™‚ (13:00-15:00)</option><option value="ç”³">ç”³æ™‚ (15:00-17:00)</option>
                <option value="é…‰">é…‰æ™‚ (17:00-19:00)</option><option value="æˆŒ">æˆŒæ™‚ (19:00-21:00)</option><option value="äº¥">äº¥æ™‚ (21:00-23:00)</option>
            </select>
        </div>
        <button class="btn-main" onclick="calculate()">é–‹å•Ÿé‹å‹¢å°èˆª</button>
        
        <button class="btn-main" style="background: linear-gradient(135deg, #1a2634, #2d3748); border: 1px solid var(--gold); margin-top:15px; color:var(--gold);" onclick="exportToImage()">
            ğŸ“¸ ä¸‹è¼‰é‹å‹¢åˆ†æå¡ (JPG)
        </button>

        <button class="btn-main" style="background: #2d3748; border: 1px solid #4a5568; margin-top:10px; color:var(--cyan);" onclick="window.location.href='/crm'">
            ğŸ“‚ é€²å…¥å®¢æˆ¶æˆ°æƒ…å®¤ (CRM)
        </button>
        <button class="ctrl-btn active" style="width:100%; margin-top:10px; padding:10px; margin-left:0;" onclick="openSaveModal()">ğŸ’¾ å„²å­˜æœ¬æ¬¡è«®è©¢ç´€éŒ„</button>
        <button class="ctrl-btn" style="width:100%; margin-top:10px; padding:10px; margin-left:0; background:#4a5568; border-color:#718096;" onclick="openAuditModal()">ğŸ“Š æ ¸å°åˆ†æ•¸æ˜ç´° (Debug)</button>
    </div>

    <div class="info-panel" id="resultArea">
        <div class="card" style="border-left:5px solid var(--gold); overflow:hidden;">
            <h3 class="card-header" style="color:var(--gold);">
                <div style="display:flex; align-items:center; width:100%">
                    <div style="white-space:nowrap;">å‘½ç›¤å…¨æ¯åœ– <span id="lunarInfo" style="font-size:0.8em; color:#a0a0a0;"></span></div>
                    <div style="display:flex; align-items:center; margin-left:auto;">
                        <div class="switch-container">
                            <span class="switch-label">å‹•ç•«</span>
                            <label class="switch">
                                <input type="checkbox" id="animToggle" onchange="toggleAnim(this)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="animControls" style="display:none; font-size:0.8em;">
                            <button class="ctrl-btn" id="pauseBtn" onclick="togglePause(); event.stopPropagation();">â¯</button>
                            <button class="ctrl-btn finish" onclick="skipToComplete(); event.stopPropagation();">â©</button>
                            <button class="ctrl-btn" onclick="replayAnimation(); event.stopPropagation();">ğŸ”„</button>
                        </div>
                    </div>
                </div>
            </h3>
            <div class="twelve-palaces-map" id="mainMap">
                <div class="grid-cell" id="cell-å·³"><div class="pillar-badges-container"></div><span class="cell-zhi">å·³</span><span class="cell-star">å¤©æ–‡</span><span class="cell-realm">ä»™é“</span></div>
                <div class="grid-cell" id="cell-åˆ"><div class="pillar-badges-container"></div><span class="cell-zhi">åˆ</span><span class="cell-star">å¤©ç¦</span><span class="cell-realm">ä½›é“</span></div>
                <div class="grid-cell" id="cell-æœª"><div class="pillar-badges-container"></div><span class="cell-zhi">æœª</span><span class="cell-star">å¤©é©›</span><span class="cell-realm">é¬¼é“</span></div>
                <div class="grid-cell" id="cell-ç”³"><div class="pillar-badges-container"></div><span class="cell-zhi">ç”³</span><span class="cell-star">å¤©å­¤</span><span class="cell-realm">äººé“</span></div>
                <div class="grid-cell" id="cell-è¾°"><div class="pillar-badges-container"></div><span class="cell-zhi">è¾°</span><span class="cell-star">å¤©å¥¸</span><span class="cell-realm">ä¿®ç¾…</span></div>
                <div class="center-decoration"><span style="font-size:3em; color:var(--gold);">â˜¯</span></div>
                <div class="grid-cell" id="cell-é…‰"><div class="pillar-badges-container"></div><span class="cell-zhi">é…‰</span><span class="cell-star">å¤©åˆƒ</span><span class="cell-realm">ç•œé“</span></div>
                <div class="grid-cell" id="cell-å¯"><div class="pillar-badges-container"></div><span class="cell-zhi">å¯</span><span class="cell-star">å¤©ç ´</span><span class="cell-realm">ç•œé“</span></div>
                <div class="grid-cell" id="cell-æˆŒ"><div class="pillar-badges-container"></div><span class="cell-zhi">æˆŒ</span><span class="cell-star">å¤©è—</span><span class="cell-realm">ä¿®ç¾…</span></div>
                <div class="grid-cell" id="cell-å¯…"><div class="pillar-badges-container"></div><span class="cell-zhi">å¯…</span><span class="cell-star">å¤©æ¬Š</span><span class="cell-realm">äººé“</span></div>
                <div class="grid-cell" id="cell-ä¸‘"><div class="pillar-badges-container"></div><span class="cell-zhi">ä¸‘</span><span class="cell-star">å¤©å„</span><span class="cell-realm">é¬¼é“</span></div>
                <div class="grid-cell" id="cell-å­"><div class="pillar-badges-container"></div><span class="cell-zhi">å­</span><span class="cell-star">å¤©è²´</span><span class="cell-realm">ä½›é“</span></div>
                <div class="grid-cell" id="cell-äº¥"><div class="pillar-badges-container"></div><span class="cell-zhi">äº¥</span><span class="cell-star">å¤©å£½</span><span class="cell-realm">ä»™é“</span></div>
            </div>
        </div>

        <div class="card">
            <h3 class="card-header" onclick="toggleCard('pillarsBody')">æœ¬å‘½æ ¹åŸº <span class="arrow-icon collapsed">â–¼</span></h3>
            <div id="pillarsBody" class="card-body collapsed"><div class="four-pillars" id="pillarsArea"></div></div>
        </div>

        <div class="card" style="border-left:5px solid var(--cyan);">
            <h3 class="card-header" onclick="toggleCard('hierarchyBody')">
                æ™‚ç©ºæˆ°ç•¥å®šä½ <span id="targetDisplayInfo" style="font-size:0.7em; color:#888; font-weight:normal;"></span> 
                <span class="arrow-icon collapsed">â–¼</span>
            </h3>
            <div id="hierarchyBody" class="card-body collapsed"><div id="hierarchyArea"></div></div>
        </div>
        
        <div class="card" style="border-left: 5px solid var(--gold);">
            <h3 class="card-header" onclick="toggleCard('trendBody')">
                <span id="trendTitle">é‹å‹¢èƒ½é‡èµ°å‹¢åœ– <span style="font-size:0.7em; color:#888;">(é è¨­: ç¸½å‘½é‹)</span></span>
                <span class="arrow-icon">â–¼</span>
            </h3>
            <div id="trendBody" class="card-body">
                <div style="margin-bottom:10px; display:flex; justify-content:flex-end; gap:15px;">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="gradeCheckbox" onchange="updateTrendChart(lastActiveAspect)">
                        â˜‘ åäºŒå®®ä¸‰å“æ ¼
                    </label>
                    <label class="checkbox-wrapper" style="color:var(--cyan);">
                        <input type="checkbox" id="renheCheckbox" onchange="updateTrendChart(lastActiveAspect)">
                        â˜‘ æ ¹åŸº (äººå’Œ)
                    </label>
                </div>
                <div style="height: 250px; width: 100%;"><canvas id="trendChart"></canvas></div>
            </div>
        </div>

        <div class="card">
            <h3 class="card-header" onclick="toggleCard('aspectsBody')">
                åäºŒå®®ä½é‹ç¨‹è©³è§£ <span style="font-size:0.7em; color:var(--cyan);">(é»æ“Šé …ç›®åˆ‡æ›æ³¢å½¢)</span>
                <span class="arrow-icon">â–¼</span>
            </h3>
            <div id="aspectsBody" class="card-body"><div id="aspectsList"></div></div>
        </div>

        <div class="card" style="background:#161625; border-color:var(--gpt-color);">
            <h3 class="card-header" onclick="toggleCard('aiBody')" style="color:var(--gpt-color);">
                ğŸ¤– AI é‹å‹¢è§£è®€å¸« <button class="ai-btn" onclick="event.stopPropagation(); callAIWithMode('general');">ğŸ”® ç¶œåˆåˆ†æ</button>
                <span class="arrow-icon collapsed">â–¼</span>
            </h3>
            <div id="aiBody" class="card-body collapsed">
                <div class="ai-controls">
                    <button class="ai-shortcut-btn" onclick="callAIWithMode('weakest')">ğŸ’” æ‰¾ç—…ç¶</button>
                    <button class="ai-shortcut-btn" onclick="callAIWithMode('timing')">ğŸ“… å®šæ™‚æ©Ÿ</button>
                    <button class="ai-shortcut-btn" onclick="callAIWithMode('script')">ğŸ—£ï¸ æ±‚è©±è¡“</button>
                </div>
                <div id="aiPrompt" style="display:none;"></div>
                <div id="aiResponseArea" style="min-height:100px; padding:10px; color:#ddd;">(è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•ï¼Œå•Ÿå‹•é‹å‹¢åˆ†æ...)</div>
            </div>
        </div>
    </div>
</div>

<div id="exportContainer">
    <div class="export-header">
        <div class="export-title">é”æ‘©ä¸€æŒç¶“ï¼ç”Ÿå‘½è—åœ–å°èˆª</div>
        <div class="export-info" id="exportInfo"></div>
    </div>
    
    <div class="export-grid">
        <div>
            <div class="export-section-title">æœ¬å‘½å…¨æ¯åœ– (åäºŒå®®)</div>
            <div id="exportMapContainer" style="transform: scale(0.9); transform-origin: top left;"></div>
        </div>
        <div>
            <div class="export-section-title">åäºŒå®®ä½é‹ç¨‹åˆ†æ</div>
            <div id="exportAspectList"></div>
        </div>
    </div>

    <div class="export-section-title">é‹å‹¢èƒ½é‡èµ°å‹¢åœ–</div>
    <div class="export-chart-area">
        <h4 style="color:var(--gold); text-align:center; margin:0 0 10px 0;" id="exportChartTitle"></h4>
        <img id="exportChartImg" style="width:100%; border-radius:4px;">
    </div>

    <div class="highlight-box">
        <h4 style="color:var(--gold); margin:0 0 10px 0;">ğŸ”® é‹å‹¢é‡é»æç¤º</h4>
        <div id="exportHighlights" style="font-size:1.1em; color:#ddd; line-height:1.6;"></div>
    </div>

    <div class="export-footer">
        å¾å³°è€å¸« é‹å‹¢æŒ‡å° | é”æ‘©ç”Ÿå‘½è—åœ–å°èˆªç³»çµ± V9.0
    </div>
</div>

<div id="saveModal" class="modal">
    <div class="modal-content">
        <h3>ğŸ’¾ å»ºç«‹å®¢æˆ¶æª”æ¡ˆ</h3>
        <div class="form-group"><label>å®¢æˆ¶å§“å</label><input type="text" id="crmName" placeholder="ä¾‹å¦‚ï¼šé™³å¤§ç™¼"></div>
        <div class="form-group"><label>è¯çµ¡é›»è©± / Line</label><input type="text" id="crmPhone" placeholder="09xx-xxx-xxx"></div>
        <div class="form-group">
            <label>å®¢æˆ¶æ¨™ç±¤</label>
            <div class="tag-container" id="tagList">
                <span class="tag-chip" onclick="toggleTag(this)">VIP</span><span class="tag-chip" onclick="toggleTag(this)">ä¼æ¥­è«®è©¢</span>
                <span class="tag-chip" onclick="toggleTag(this)">
