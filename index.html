<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”æ‘©ä¸€æŒç¶“ï¼å…¨æ™‚ç©ºæˆ°ç•¥ä¸­å°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root { --bg-color: #121820; --panel-bg: #1e2732; --gold: #d4af37; --cyan: #4fd1c5; --danger: #ff4d4d; --text-main: #e0e0e0; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: "Microsoft JhengHei", serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        h1 { color: var(--gold); letter-spacing: 5px; margin-bottom: 20px; }
        .dashboard { display: grid; grid-template-columns: 380px 1fr; gap: 25px; width: 100%; max-width: 1400px; }
        .control-panel, .card { background: var(--panel-bg); padding: 20px; border-radius: 8px; border: 1px solid #8c7853; margin-bottom: 20px; }
        .control-panel { position: sticky; top: 20px; height: fit-content; }
        label { display: block; margin-bottom: 5px; color: var(--cyan); font-size: 0.9em; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 15px; background: #151b24; border: 1px solid #4a5568; color: white; border-radius: 4px; }
        button.btn-main { width: 100%; padding: 14px; background: linear-gradient(135deg, #8c7853, var(--gold)); border: none; font-weight: bold; font-size: 1.2em; border-radius: 4px; cursor: pointer; color: #1a2634; }
        .card-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: var(--gold); font-weight: bold; margin-bottom: 10px; }
        .card-body { transition: all 0.3s; overflow: hidden; }
        .card-body.collapsed { max-height: 0; opacity: 0; margin: 0; padding: 0; }
        
        .twelve-palaces-map { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 130px); gap: 10px; grid-template-areas: "si wu wei shen" "chen . . you" "mao . . xu" "yin chou zi hai"; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; }
        .grid-cell { position: relative; background: #2a3544; border: 1px solid #3f4a5a; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; }
        .grid-cell.active { border-color: var(--gold); background: #3a4555; }
        .grid-cell.roulette-active { background: #fff !important; border-color: var(--gold); transform: scale(1.05); z-index: 100; }
        .grid-cell.roulette-active .cell-star { color: #000 !important; }
        .cell-zhi { position: absolute; top: 5px; left: 8px; font-size: 1em; color: #555; }
        .cell-star { font-size: 1.7em; font-weight: bold; color: #ddd; z-index: 1; }
        .cell-aspect-name { font-size: 0.95em; color: var(--cyan); border-top: 1px solid rgba(255,255,255,0.1); width: 85%; text-align: center; margin-top: 4px; }
        .pillar-badges-container { position: absolute; top: 25px; left: 4px; display: flex; flex-direction: column; gap: 3px; }
        .pillar-badge { font-size: 0.65em; padding: 1px 5px; border-radius: 3px; color: #1a2634; font-weight: bold; opacity:0; }
        .pillar-badge.show { opacity: 1; }
        
        .aspect-row { border-bottom: 1px solid #333; padding: 10px 5px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .aspect-row:hover, .aspect-row.active-aspect { background: rgba(212, 175, 55, 0.1); border-left: 3px solid var(--gold); }
        .progress-container { flex: 1; height: 6px; background: #333; border-radius: 3px; margin: 0 10px; }
        .progress-bar { height: 100%; border-radius: 3px; transition: width 0.5s; }
        
        .switch-container { display: flex; align-items: center; gap: 8px; margin-left: auto; }
        .switch { position: relative; display: inline-block; width: 36px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 18px; border: 1px solid #555; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 2px; bottom: 2px; background-color: #888; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--gold); }
        input:checked + .slider:before { transform: translateX(18px); background-color: #1a2634; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        .modal-content { background-color: #1e2732; border: 1px solid var(--gold); padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; }
        #loadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #333; border-top: 4px solid var(--gold); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .center-decoration { grid-area: 2 / 2 / 4 / 4; display: flex; justify-content: center; align-items: center; border: 2px dashed var(--bronze); border-radius: 50%; margin: 15px; }
    </style>
</head>
<body>
<div id="loadingOverlay"><div class="spinner"></div></div>
<h1>é”æ‘©ä¸€æŒç¶“ï¼å…¨æ™‚ç©ºæˆ°ç•¥ä¸­å°</h1>
<div class="dashboard">
    <div class="control-panel">
        <h3 style="color:var(--cyan); border-bottom:1px solid #444;">1. æœ¬å‘½è¨­å®š</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div><label>æ€§åˆ¥</label><select id="gender"><option value="1">ç”· (é †è¡Œ)</option><option value="0">å¥³ (é€†è¡Œ)</option></select></div>
            <div><label>æ™‚è¾°</label><select id="hour"><option value="å­">å­</option><option value="ä¸‘">ä¸‘</option><option value="å¯…">å¯…</option><option value="å¯">å¯</option><option value="è¾°">è¾°</option><option value="å·³">å·³</option><option value="åˆ">åˆ</option><option value="æœª">æœª</option><option value="ç”³">ç”³</option><option value="é…‰">é…‰</option><option value="æˆŒ">æˆŒ</option><option value="äº¥">äº¥</option></select></div>
        </div>
        <label>åœ‹æ›†ç”Ÿæ—¥</label><input type="date" id="solarDate" value="1985-03-27">
        
        <h3 style="color:var(--gold); border-bottom:1px solid #444; margin-top:20px;">2. æˆ°ç•¥ç›®æ¨™</h3>
        <div style="display:flex; gap:20px; margin-bottom:10px;">
            <label><input type="radio" name="calendarType" value="lunar" checked onchange="updateFormUI()"> è¾²æ›†</label>
            <label><input type="radio" name="calendarType" value="solar" onchange="updateFormUI()"> è¥¿å…ƒ</label>
        </div>
        <select id="targetScope" onchange="updateFormUI()"><option value="year">æµå¹´</option><option value="month">æµæœˆ</option><option value="day">æµæ—¥</option><option value="hour">æµæ™‚</option></select>
        <div id="yearInput" class="input-group show"><label id="lblYear">è¾²æ›†å¹´ä»½</label><input type="number" id="tYear" value="2026"></div>
        <div id="monthInput" class="input-group"><label id="lblMonth">è¾²æ›†æœˆä»½</label><input type="number" id="tMonth" value="1"></div>
        <div id="dayInput" class="input-group"><label id="lblDay">è¾²æ›†æ—¥æœŸ</label><input type="number" id="tDay" value="1"></div>
        <div id="hourInput" class="input-group"><label>æ™‚è¾°</label><select id="tHour"><option value="å­">å­</option><option value="ä¸‘">ä¸‘</option><option value="å¯…">å¯…</option><option value="å¯">å¯</option><option value="è¾°">è¾°</option><option value="å·³">å·³</option><option value="åˆ">åˆ</option><option value="æœª">æœª</option><option value="ç”³">ç”³</option><option value="é…‰">é…‰</option><option value="æˆŒ">æˆŒ</option><option value="äº¥">äº¥</option></select></div>
        
        <button class="btn-main" onclick="calculate()">å•Ÿå‹•å…¨æ™‚ç©ºæ¨æ¼”</button>
        <button class="btn-main" style="background:#2d3748; margin-top:15px; color:var(--cyan);" onclick="window.location.href='/crm'">ğŸ“‚ é€²å…¥å®¢æˆ¶æˆ°æƒ…å®¤ (CRM)</button>
        <button class="btn-main" style="background:#333; margin-top:10px; font-size:0.9em;" onclick="openSaveModal()">ğŸ’¾ å¿«é€Ÿå­˜æª”</button>
    </div>

    <div class="info-panel" id="resultArea">
        <div class="card" style="border-left:5px solid var(--gold);">
            <div class="card-header">
                <div>æˆ°ç•¥å„€è¡¨æ¿ <span id="lunarInfo" style="font-size:0.8em; color:#888;"></span></div>
                <div class="switch-container">
                    <span style="font-size:0.8em; color:#888;">å‹•ç•«</span>
                    <label class="switch"><input type="checkbox" id="animToggle" onchange="isAnimEnabled=this.checked"><span class="slider"></span></label>
                </div>
            </div>
            <div class="twelve-palaces-map">
                <div class="grid-cell" id="cell-å·³"><div class="pillar-badges-container"></div><span class="cell-zhi">å·³</span><span class="cell-star">å¤©æ–‡</span></div>
                <div class="grid-cell" id="cell-åˆ"><div class="pillar-badges-container"></div><span class="cell-zhi">åˆ</span><span class="cell-star">å¤©ç¦</span></div>
                <div class="grid-cell" id="cell-æœª"><div class="pillar-badges-container"></div><span class="cell-zhi">æœª</span><span class="cell-star">å¤©é©›</span></div>
                <div class="grid-cell" id="cell-ç”³"><div class="pillar-badges-container"></div><span class="cell-zhi">ç”³</span><span class="cell-star">å¤©å­¤</span></div>
                <div class="grid-cell" id="cell-è¾°"><div class="pillar-badges-container"></div><span class="cell-zhi">è¾°</span><span class="cell-star">å¤©å¥¸</span></div>
                <div class="center-decoration"><span style="font-size:3em; color:var(--gold);">â˜¯</span></div>
                <div class="grid-cell" id="cell-é…‰"><div class="pillar-badges-container"></div><span class="cell-zhi">é…‰</span><span class="cell-star">å¤©åˆƒ</span></div>
                <div class="grid-cell" id="cell-å¯"><div class="pillar-badges-container"></div><span class="cell-zhi">å¯</span><span class="cell-star">å¤©ç ´</span></div>
                <div class="grid-cell" id="cell-æˆŒ"><div class="pillar-badges-container"></div><span class="cell-zhi">æˆŒ</span><span class="cell-star">å¤©è—</span></div>
                <div class="grid-cell" id="cell-å¯…"><div class="pillar-badges-container"></div><span class="cell-zhi">å¯…</span><span class="cell-star">å¤©æ¬Š</span></div>
                <div class="grid-cell" id="cell-ä¸‘"><div class="pillar-badges-container"></div><span class="cell-zhi">ä¸‘</span><span class="cell-star">å¤©å„</span></div>
                <div class="grid-cell" id="cell-å­"><div class="pillar-badges-container"></div><span class="cell-zhi">å­</span><span class="cell-star">å¤©è²´</span></div>
                <div class="grid-cell" id="cell-äº¥"><div class="pillar-badges-container"></div><span class="cell-zhi">äº¥</span><span class="cell-star">å¤©å£½</span></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header" onclick="toggleCard('pillarsBody')">æœ¬å‘½æ ¹åŸº â–¼</div>
            <div id="pillarsBody" class="card-body collapsed"><div class="four-pillars" id="pillarsArea"></div></div>
        </div>

        <div class="card" style="border-left:5px solid var(--cyan);">
            <div class="card-header" onclick="toggleCard('hierarchyBody')">æ™‚ç©ºæˆ°ç•¥å®šä½ <span id="targetDisplayInfo" style="font-size:0.8em; font-weight:normal; color:#888;"></span> â–¼</div>
            <div id="hierarchyBody" class="card-body collapsed"><div id="hierarchyArea"></div></div>
        </div>
        
        <div class="card" style="border-left:5px solid var(--gold);">
            <div class="card-header">æ™‚ç©ºé‹å‹¢æ³¢å½¢åœ– <span style="font-size:0.7em; color:#888;">(é è¨­: ç¸½å‘½é‹)</span></div>
            <div class="card-body">
                <div style="text-align:right; margin-bottom:10px;"><label style="display:inline-flex; align-items:center; gap:5px; cursor:pointer;"><input type="checkbox" id="gradeCheckbox" onchange="updateTrendChart(lastActiveAspect)"> å•Ÿç”¨åŠ æ¬Š</label></div>
                <div style="height: 250px;"><canvas id="trendChart"></canvas></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">åäºŒé‹ç¨‹æˆ°ç•¥æŒ‡å°</div>
            <div class="card-body"><div id="aspectsList"></div></div>
        </div>

        <div class="card" style="background:#161625; border-color:var(--gpt-color);">
            <div class="card-header" onclick="toggleCard('aiBody')" style="color:var(--gpt-color);">ğŸ¤– AI æˆ°ç•¥é¡§å• â–¼</div>
            <div id="aiBody" class="card-body collapsed">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button class="ai-btn" onclick="callAIWithMode('general')" style="flex:1;">ğŸ”® ç¶œåˆ</button>
                    <button class="ai-btn" onclick="callAIWithMode('weakest')" style="flex:1;">ğŸ’” ç—…ç¶</button>
                    <button class="ai-btn" onclick="callAIWithMode('timing')" style="flex:1;">ğŸ“… æ™‚æ©Ÿ</button>
                </div>
                <div id="aiResponseArea" style="min-height:100px; color:#ddd;">(é»æ“Šä¸Šæ–¹æŒ‰éˆ•å•Ÿå‹•...)</div>
            </div>
        </div>
    </div>
</div>

<div id="saveModal" class="modal">
    <div class="modal-content">
        <h3>å»ºç«‹æª”æ¡ˆ</h3>
        <div style="margin-bottom:10px;"><label>å§“å</label><input type="text" id="crmName"></div>
        <div style="margin-bottom:10px;"><label>é›»è©±</label><input type="text" id="crmPhone"></div>
        <div style="margin-bottom:10px;"><label>ç­†è¨˜</label><textarea id="crmNote"></textarea></div>
        <div style="margin-bottom:10px;"><label>AIå»ºè­°</label><textarea id="crmAiContent"></textarea></div>
        <div style="text-align:right; margin-top:20px;">
            <button class="btn-main" style="background:#555; width:auto;" onclick="closeSaveModal()">å–æ¶ˆ</button>
            <button class="btn-main" style="width:auto;" onclick="confirmSave()">å„²å­˜</button>
        </div>
    </div>
</div>

<script>
    const DEFAULT_STARS = {'å­':{name:'å¤©è²´'},'ä¸‘':{name:'å¤©å„'},'å¯…':{name:'å¤©æ¬Š'},'å¯':{name:'å¤©ç ´'},'è¾°':{name:'å¤©å¥¸'},'å·³':{name:'å¤©æ–‡'},'åˆ':{name:'å¤©ç¦'},'æœª':{name:'å¤©é©›'},'ç”³':{name:'å¤©å­¤'},'é…‰':{name:'å¤©åˆƒ'},'æˆŒ':{name:'å¤©è—'},'äº¥':{name:'å¤©å£½'}};
    const STAR_TRAITS = {'å¤©è²´':{keyword:'è²´äºº'},'å¤©å„':{keyword:'å‹ç¢Œ'},'å¤©æ¬Š':{keyword:'æ¬ŠåŠ›'},'å¤©ç ´':{keyword:'æ¶ˆè€—'},'å¤©å¥¸':{keyword:'æ©Ÿæ™º'},'å¤©æ–‡':{keyword:'æ™ºæ…§'},'å¤©ç¦':{keyword:'ç¦æ°£'},'å¤©é©›':{keyword:'å¥”æ³¢'},'å¤©å­¤':{keyword:'å­¤ç¨'},'å¤©åˆƒ':{keyword:'å‰›å¼·'},'å¤©è—':{keyword:'æ‰è—'},'å¤©å£½':{keyword:'é•·å£½'}};
    const ROULETTE_PATH = ['å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥', 'å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°'];
    let currentLightIndex=0, globalLastResult=null, globalIsPaused=false, globalSkipAnimation=false, trendChartInstance=null, globalTrendData=null, lastActiveAspect='ç¸½å‘½é‹', isAnimEnabled=false;

    function setHTML(id, html) { const el = document.getElementById(id); if(el) el.innerHTML = html; }
    function setText(id, text) { const el = document.getElementById(id); if(el) el.innerText = text; }
    function toggleCard(bodyId) { const b = document.getElementById(bodyId); b.classList.toggle('collapsed'); }
    function getStatusColor(relation) { if(relation.includes('ç”Ÿ')||relation.includes('æ—º')) return 'var(--status-best)'; if(relation.includes('å‰‹')) return 'var(--status-bad)'; return '#888'; }
    function updateFormUI() { 
        const isSolar = document.querySelector('input[name="calendarType"]:checked').value === 'solar';
        setText('lblYear', isSolar ? 'è¥¿å…ƒå¹´ä»½' : 'è¾²æ›†å¹´ä»½');
        const s = document.getElementById('targetScope').value;
        document.getElementById('monthInput').style.display = s!=='year'?'block':'none';
        document.getElementById('dayInput').style.display = (s==='day'||s==='hour')?'block':'none';
        document.getElementById('hourInput').style.display = s==='hour'?'block':'none';
    }
    
    function initMap() { for(let z in DEFAULT_STARS) { const c=document.getElementById('cell-'+z); if(c) c.innerHTML = `<div class="pillar-badges-container"></div><span class="cell-zhi">${z}</span><span class="cell-star">${DEFAULT_STARS[z].name}</span>`; } }

    async function calculate() {
        document.getElementById('loadingOverlay').style.display='flex';
        const data = { gender: parseInt(document.getElementById('gender').value), solar_date: document.getElementById('solarDate').value, hour: document.getElementById('hour').value, target_calendar: document.querySelector('input[name="calendarType"]:checked').value, target_scope: document.getElementById('targetScope').value, target_year: parseInt(document.getElementById('tYear').value)||2026, target_month: parseInt(document.getElementById('tMonth').value)||1, target_day: parseInt(document.getElementById('tDay').value)||1, target_hour: document.getElementById('tHour').value };
        try { 
            const res = await fetch('/api/calculate', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)}); 
            globalLastResult = await res.json(); 
            startAnimationSequence(globalLastResult); 
        } catch(e) { alert("éŒ¯èª¤: "+e.message); document.getElementById('loadingOverlay').style.display='none'; }
    }

    async function startAnimationSequence(result) {
        document.getElementById('loadingOverlay').style.display='none';
        initMap(); setHTML('pillarsArea','');
        setText('lunarInfo', result.lunar_info); setText('targetDisplayInfo', result.target_display);
        
        const p = result.base_chart;
        const list = [{z:p.å¹´æŸ±.zhi,n:p.å¹´æŸ±.name,c:'var(--p-year)',k:'å¹´'}, {z:p.æœˆæŸ±.zhi,n:p.æœˆæŸ±.name,c:'var(--p-month)',k:'æœˆ'}, {z:p.æ—¥æŸ±.zhi,n:p.æ—¥æŸ±.name,c:'var(--p-day)',k:'æ—¥'}, {z:p.æ™‚æŸ±.zhi,n:p.æ™‚æŸ±.name,c:'var(--p-hour)',k:'å‘½'}];
        const isMale = (parseInt(document.getElementById('gender').value)===1);
        
        for(let item of list) {
            if(isAnimEnabled) await runRoulette(item.z, isMale);
            addBadge(item.z, item.k, item.c);
            document.getElementById('pillarsArea').innerHTML += `<div class="pillar-box active" style="border-color:${item.c}"><div style="color:${item.c}">${item.n}</div><div>${item.z}</div></div>`;
        }
        renderFullView(result);
    }

    function runRoulette(target, isMale) { return new Promise(r => { let i=0, max=50, idx=currentLightIndex; const tIdx=ROULETTE_PATH.indexOf(target); const step=isMale?1:-1; function next() { if(i++>max && idx===tIdx) return r(); idx=(idx+step+12)%12; document.querySelectorAll('.roulette-active').forEach(e=>e.classList.remove('roulette-active')); document.getElementById('cell-'+ROULETTE_PATH[idx]).classList.add('roulette-active'); currentLightIndex=idx; setTimeout(next, 50); } next(); }); }
    function addBadge(z, t, c) { const el=document.getElementById('cell-'+z).querySelector('.pillar-badges-container'); if(el) el.innerHTML+=`<span class="pillar-badge show" style="background:${c}">${t}</span>`; }

    function renderFullView(result) {
        const h = result.hierarchy;
        addBadge(h.big_luck.zhi, 'å¤§é‹', 'var(--p-luck)');
        addBadge(h.year.zhi, 'æµå¹´', 'var(--p-year)');
        if(h.month && document.getElementById('targetScope').value!=='year') addBadge(h.month.zhi, 'æµæœˆ', 'var(--p-month)');
        
        result.aspects.forEach(a => {
            const c = document.getElementById('cell-'+a.zhi);
            if(c) c.innerHTML += `<div class="cell-aspect-name">${a.name}</div><div style="position:absolute;top:5px;right:5px;font-size:0.7em;background:${getStatusColor(a.relation)}">${a.relation}</div>`;
        });
        
        if(result.trend_data) { globalTrendData = result.trend_data; updateTrendChart('ç¸½å‘½é‹'); fillLists(result); }
    }

    function fillLists(result) {
        let html = '';
        let idx = -1;
        // å˜—è©¦æ‰¾åˆ°å°æ‡‰å¹´ä»½çš„ç´¢å¼•
        if (globalTrendData.axis_labels) {
            const tYear = String(document.getElementById('tYear').value);
            idx = globalTrendData.axis_labels.findIndex(l => String(l).includes(tYear));
            if (idx === -1) idx = Math.floor(globalTrendData.axis_labels.length / 2);
        }

        result.aspects.forEach(a => {
            let score = 50;
            if (idx !== -1 && globalTrendData.datasets[a.name]) {
                score = globalTrendData.datasets[a.name][idx] + (document.getElementById('gradeCheckbox').checked ? (globalTrendData.adjustments[a.name][idx]||0) : 0);
                score = Math.max(5, Math.min(95, score));
            }
            html += `<div class="aspect-row" onclick="updateTrendChart('${a.name}')">
                <div style="width:100px; font-weight:bold; color:var(--cyan);">${a.name}</div>
                <div style="flex:1;"><div class="progress-container"><div class="progress-bar" style="width:${score}%; background:${score>=60?'var(--status-good)':'var(--status-bad)'}"></div></div></div>
                <div style="width:40px; text-align:right;">${score}</div>
            </div>`;
        });
        setHTML('aspectsList', html);
    }

    function renderTrendChart(labels, scores) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        if(trendChartInstance) trendChartInstance.destroy();
        trendChartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: [{ label: 'èƒ½é‡', data: scores, borderColor: '#d4af37', borderWidth: 2, tension: 0.4 }] },
            options: { maintainAspectRatio: false, scales: { y: { min:0, max:100, grid:{color:'#333'} }, x:{ grid:{color:'#333'} } }, plugins:{legend:{display:false}} }
        });
    }

    function updateTrendChart(name) {
        lastActiveAspect = name;
        if(!globalTrendData || !globalTrendData.datasets[name]) return;
        const base = globalTrendData.datasets[name];
        const adj = globalTrendData.adjustments[name];
        const isAdj = document.getElementById('gradeCheckbox').checked;
        const final = base.map((v, i) => Math.max(5, Math.min(95, v + (isAdj ? (adj[i]||0) : 0))));
        renderTrendChart(globalTrendData.axis_labels, final);
        
        // æ›´æ–°åˆ—è¡¨é«˜äº®
        document.querySelectorAll('.aspect-row').forEach(e => {
            if(e.innerText.includes(name)) e.style.background = 'rgba(212,175,55,0.2)';
            else e.style.background = 'transparent';
        });
    }

    // CRM / AI
    function openSaveModal() { document.getElementById('saveModal').style.display='flex'; }
    function closeSaveModal() { document.getElementById('saveModal').style.display='none'; }
    async function confirmSave() {
        const d = { solar_date: document.getElementById('solarDate').value, gender: parseInt(document.getElementById('gender').value), hour: document.getElementById('hour').value, target_year: parseInt(document.getElementById('tYear').value), client_name: document.getElementById('crmName').value, phone: document.getElementById('crmPhone').value, note: document.getElementById('crmNote').value, ai_log: {saved_content: document.getElementById('crmAiContent').value} };
        await fetch('/api/save_record', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)});
        alert("å·²å„²å­˜"); closeSaveModal();
    }
    
    async function callAIWithMode(mode) {
        if(!globalTrendData) return alert("è«‹å…ˆæ’ç›¤");
        const p = `åˆ†æ${lastActiveAspect},æ¨¡å¼${mode}`;
        document.getElementById('aiResponseArea').innerText = "AIæ€è€ƒä¸­...";
        const res = await fetch('/api/ask_ai', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({prompt:p})});
        const d = await res.json();
        document.getElementById('aiResponseArea').innerText = d.reply;
    }

    updateFormUI(); initMap();
    window.onload = function() {
        const s = localStorage.getItem('damo_restore_data');
        if(s) {
            const i = JSON.parse(s);
            document.getElementById('solarDate').value = i.solar_date;
            document.getElementById('gender').value = i.gender;
            document.getElementById('hour').value = i.hour;
            document.getElementById('tYear').value = i.target_year || 2026;
            updateFormUI();
            setTimeout(calculate, 200);
            localStorage.removeItem('damo_restore_data');
        }
    }
</script>
</body>
</html>
