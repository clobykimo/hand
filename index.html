<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”æ‘©ä¸€æŒç¶“ï¼ç”Ÿå‘½è—åœ–å°èˆªç³»çµ± (V10.5 æ·±åº¦æ‰¹æ–‡ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --bg-color: #121820; --panel-bg: #1e2732; --gold: #d4af37;
            --bronze: #8c7853; --cyan: #4fd1c5; --danger: #ff4d4d;
            --text-main: #e0e0e0; --text-sub: #a0a0a0; --gpt-color: #10a37f;
            --p-year: #d4af37; --p-month: #4fd1c5; --p-day: #ff9f43; --p-hour: #a3a3ff; --p-luck: #2ecc71;
            --status-best: #ffd700; --status-good: #ADD8E6; --status-growth: #90EE90; --status-bad: #ff4d4d;
        }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: "Microsoft JhengHei", serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; position: relative; }
        
        h1 { color: var(--gold); letter-spacing: 5px; margin-bottom: 20px; text-shadow: 0 0 10px rgba(212,175,55,0.4); text-align: center; }
        .header-controls { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; }
        .btn-crm { 
            background: rgba(79, 209, 197, 0.15); border: 1px solid var(--cyan); color: var(--cyan); 
            padding: 8px 15px; border-radius: 20px; font-size: 0.9em; cursor: pointer; text-decoration: none; display: flex; align-items: center; gap: 5px; 
            transition: all 0.3s;
        }
        .btn-crm:hover { background: var(--cyan); color: #000; transform: translateY(-2px); }

        .dashboard { display: grid; grid-template-columns: 380px 1fr; gap: 25px; width: 100%; max-width: 1400px; }
        .control-panel, .card { background: var(--panel-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--bronze); margin-bottom: 20px; }
        .control-panel { height: fit-content; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: sticky; top: 20px; }
        
        label { display: block; margin-bottom: 5px; color: var(--cyan); font-size: 0.9em; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 10px; background: #151b24; border: 1px solid #4a5568; color: white; border-radius: 4px; box-sizing: border-box; font-size: 1rem; }
        
        .radio-group { display: flex; gap: 15px; align-items: center; background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 4px; border: 1px solid #444; margin-bottom: 10px; }
        .radio-label { display: flex; align-items: center; gap: 5px; cursor: pointer; color: #ddd; font-size: 0.95em; margin: 0; }
        .radio-label input { width: auto; margin: 0; cursor: pointer; }

        button.btn-main { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--bronze), var(--gold)); border: none; font-weight: bold; font-size: 1.2em; border-radius: 4px; cursor: pointer; color: #1a2634; margin-top: 5px; box-shadow: 0 4px 15px rgba(212,175,55,0.3); }
        button.btn-main:hover { filter: brightness(1.15); transform: translateY(-2px); }

        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-icon { 
            display: flex; align-items: center; justify-content: center; gap: 5px;
            padding: 10px; font-size: 0.9em; border-radius: 4px; border: 1px solid #444; cursor: pointer; transition: all 0.2s; font-weight: bold;
        }
        .btn-save { background: #2d3748; color: var(--gold); border-color: var(--gold); }
        .btn-save:hover { background: var(--gold); color: #000; }
        .btn-down { background: #1a202c; color: #ddd; border-color: #4a5568; }
        .btn-down:hover { border-color: var(--cyan); color: var(--cyan); }
        .btn-audit { grid-column: span 2; background: transparent; border: 1px dashed #555; color: #666; font-size: 0.85em; padding: 6px; }
        .btn-audit:hover { color: #888; border-color: #888; }

        .ctrl-btn { background: #333; color: #ddd; border: 1px solid #555; padding: 4px 12px; border-radius: 4px; cursor: pointer; margin-left: 8px; }
        .ctrl-btn.active { background: var(--gold); color: #1a2634; }
        .ctrl-btn.finish { border-color: var(--cyan); color: var(--cyan); }
        .card-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; transition: opacity 0.2s; min-height: 30px; }
        .card-header:hover { opacity: 0.8; }
        .arrow-icon { transition: transform 0.3s ease; font-size: 0.8em; color: var(--cyan); }
        .arrow-icon.collapsed { transform: rotate(-90deg); }
        .card-body { overflow: hidden; transition: max-height 0.4s cubic-bezier(0, 1, 0, 1), opacity 0.4s ease-in-out, margin-top 0.4s; max-height: 2000px; opacity: 1; margin-top: 15px; }
        .card-body.collapsed { max-height: 0; opacity: 0; margin-top: 0; }
        
        .twelve-palaces-map { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 130px); gap: 12px; padding: 15px; margin-top: 0; background: rgba(0,0,0,0.2); border: 1px solid #444; border-radius: 8px; grid-template-areas: "si wu wei shen" "chen . . you" "mao . . xu" "yin chou zi hai"; }
        .grid-cell { position: relative; background: #2a3544; border: 1px solid #3f4a5a; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; }
        .grid-cell.active { border-color: var(--gold); background: #3a4555; }
        .grid-cell.target { box-shadow: 0 0 25px var(--cyan) !important; border-color: #fff !important; }
        .grid-cell.roulette-active { background: #fff !important; border-color: var(--gold); transform: scale(1.05); z-index: 100; }
        .grid-cell.roulette-active .cell-star { color: #000 !important; }
        .cell-zhi { position: absolute; top: 5px; left: 8px; font-size: 1em; color: #555; font-weight: bold; }
        .cell-star { font-size: 1.7em; font-weight: bold; color: #ddd; z-index: 1; }
        .cell-aspect-name { font-size: 0.95em; color: var(--cyan); font-weight: bold; border-top: 1px solid rgba(255,255,255,0.1); width: 85%; text-align: center; margin-top: 4px; }
        .cell-realm { font-size: 0.7em; color: #555; position:absolute; bottom: 3px; right: 5px; }
        .cell-relation-tag { position: absolute; top: 5px; right: 5px; font-size: 0.75em; padding: 2px 6px; border-radius: 3px; font-weight: bold; color: #1a2634; }
        .pillar-badges-container { position: absolute; top: 25px; left: 4px; display: flex; flex-direction: column; gap: 3px; }
        .pillar-badge { font-size: 0.65em; padding: 1px 5px; border-radius: 3px; color: #1a2634; font-weight: bold; opacity:0; }
        .pillar-badge.show { opacity: 1; }
        
        .hud-container { display: flex; align-items: center; gap: 8px; margin-left: auto; margin-right: 15px; }
        .hud-capsule { display: flex; align-items: center; background: rgba(0, 0, 0, 0.4); border-radius: 4px; border: 1px solid #333; overflow: hidden; font-family: "Microsoft JhengHei", monospace; font-size: 0.85em; }
        .hud-capsule.solar { border-color: rgba(79, 209, 197, 0.3); }
        .hud-capsule.lunar { border-color: rgba(163, 163, 255, 0.3); }
        .hud-label { padding: 2px 6px; font-weight: bold; font-size: 0.8em; color: #1a2634; }
        .hud-label.solar-bg { background: var(--cyan); }
        .hud-label.lunar-bg { background: #a3a3ff; }
        .hud-value { padding: 2px 8px; color: #eee; font-weight: bold; letter-spacing: 0.5px; }
        .hud-transfer-icon { color: var(--gold); font-size: 1.1em; font-weight: bold; opacity: 0.8; }

        .four-pillars { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .pillar-card { background: #252f3a; border: 1px solid #4a5568; border-radius: 6px; padding: 10px; text-align: center; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .pillar-card:hover { transform: translateY(-3px); border-color: var(--gold); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .pillar-card.active { border-color: var(--gold); opacity: 1; }
        .pillar-header { font-size: 0.8em; color: #888; margin-bottom: 5px; font-weight: bold; }
        .pillar-star { font-size: 1.2em; font-weight: bold; color: #eee; margin-bottom: 5px; }
        .pillar-slogan { font-size: 0.75em; color: var(--cyan); opacity: 0.8; line-height: 1.3; min-height: 2.6em; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .click-hint { position: absolute; bottom: 2px; right: 2px; font-size: 0.6em; color: #555; opacity: 0; transition: opacity 0.3s; }
        .pillar-card:hover .click-hint { opacity: 1; }

        .pattern-area { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; justify-content: center; }
        .pattern-badge { 
            background: linear-gradient(135deg, #1a202c, #2d3748); 
            border: 1px solid var(--gold); color: var(--gold);
            padding: 5px 12px; border-radius: 20px; font-size: 0.85em; font-weight: bold;
            display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .chat-window { background: #0f1319; border: 1px solid #333; border-radius: 8px; height: 300px; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; margin-bottom: 10px; }
        .chat-message { max-width: 85%; padding: 10px 14px; border-radius: 12px; line-height: 1.5; font-size: 0.95em; position: relative; word-wrap: break-word; }
        .chat-message.user { align-self: flex-end; background: linear-gradient(135deg, var(--bronze), var(--gold)); color: #1a2634; border-bottom-right-radius: 2px; font-weight: bold; }
        .chat-message.ai { align-self: flex-start; background: #2d3748; color: #e0e0e0; border: 1px solid #4a5568; border-bottom-left-radius: 2px; }
        .typing-indicator::after { content: '...'; animation: typing 1.5s infinite; }
        @keyframes typing { 0%{content:'.'} 33%{content:'..'} 66%{content:'...'} }
        .chat-input-area { display: flex; gap: 10px; }
        .chat-input { flex: 1; background: #151b24; border: 1px solid #4a5568; color: white; padding: 10px; border-radius: 4px; }

        .aspect-row { border-bottom: 1px solid #333; padding: 14px 8px; display: flex; align-items: center; justify-content: space-between; gap: 10px; transition: background 0.2s; }
        .aspect-row.clickable { cursor: pointer; border-left: 3px solid transparent; }
        .aspect-row.clickable:hover { background: rgba(212, 175, 55, 0.1); border-left: 3px solid var(--gold); }
        .aspect-row.active-aspect { background: rgba(79, 209, 197, 0.15); border-left: 3px solid var(--cyan); }
        .aspect-tag { padding: 4px 10px; border-radius: 4px; font-size: 0.9em; text-align: center; min-width: 50px; color: #1a2634; font-weight:bold; }
        .checkbox-wrapper { margin-bottom: 10px; display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--gold); font-weight: bold; user-select: none; }
        .checkbox-wrapper input { width: 18px; height: 18px; cursor: pointer; margin: 0; }
        
        .ai-controls { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .ai-shortcut-btn { flex: 1; background: #2d3748; border: 1px solid #4a5568; color: #cbd5e0; padding: 8px 5px; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .ai-shortcut-btn:hover { background: #4a5568; color: white; border-color: var(--gpt-color); transform: translateY(-2px); }
        .mini-ai-btn { background: transparent; border: 1px solid var(--gpt-color); color: var(--gpt-color); border-radius: 4px; width: 26px; height: 26px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: 8px; transition: all 0.2s; }
        .mini-ai-btn:hover { background: var(--gpt-color); color: white; transform: scale(1.1); box-shadow: 0 0 10px rgba(16, 163, 127, 0.4); }
        
        .progress-container { flex: 1; height: 6px; background: #333; border-radius: 3px; margin: 0 8px; overflow: hidden; position: relative; }
        .progress-bar { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
        .trend-icon { font-weight: bold; margin-left: 5px; font-size: 1.1em; }
        .trend-icon.up { color: #ff4d4d; animation: pulse 2s infinite; }
        .trend-icon.down { color: #4fd1c5; }
        .trend-icon.flat { color: #666; font-size: 0.8em; }
        .score-composition { font-size: 0.7em; color: #888; margin-left: 4px; font-weight: normal; }
        .score-bonus { color: #ffd700; }
        .score-penalty { color: #ff4d4d; }

        .switch-container { display: flex; align-items: center; gap: 8px; margin-left: auto; margin-right: 10px; }
        .switch-label { font-size: 0.8em; color: #888; font-weight: bold; }
        .switch { position: relative; display: inline-block; width: 36px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 18px; border: 1px solid #555; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 2px; bottom: 2px; background-color: #888; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--gold); border-color: var(--gold); }
        input:checked + .slider:before { transform: translateX(18px); background-color: #1a2634; }
        .switch:hover .slider { border-color: #888; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center; }
        .modal-content { background-color: #1e2732; border: 1px solid var(--gold); padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 0 20px rgba(0,0,0,0.8); }
        .modal h3 { color: var(--gold); margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .tag-container { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px; }
        .tag-chip { font-size: 0.8em; padding: 2px 8px; border-radius: 10px; background: #333; cursor: pointer; border: 1px solid #555; user-select: none; color: #ddd; }
        .tag-chip.selected { background: var(--cyan); color: #000; border-color: var(--cyan); }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

        @media (max-width: 950px) { 
            .dashboard { grid-template-columns: 1fr; } 
            .control-panel { position: static; } 
            .header-controls { position: static; margin-bottom: 15px; }
        }
        #loadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #333; border-top: 4px solid var(--gold); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        .show-content { opacity: 1 !important; }
        .input-group { display: none; }
        .input-group.show { display: block; }
        .four-pillars { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .center-decoration { grid-area: 2 / 2 / 4 / 4; display: flex; justify-content: center; align-items: center; opacity: 0.3; pointer-events: none; border: 2px dashed var(--bronze); border-radius: 50%; margin: 15px; }
        .ai-btn { background: var(--gpt-color); color: white; border: none; padding: 6px 20px; border-radius: 4px; cursor: pointer; margin-left: 10px; font-weight:bold; }

        #exportContainer {
            position: fixed; left: -9999px; top: 0; width: 1200px; background: #101015; color: #e0e0e0;
            padding: 40px; border: 10px double var(--gold); font-family: "Microsoft JhengHei", serif;
            box-sizing: border-box; display: flex; flex-direction: column; gap: 25px;
        }
        .export-header { border-bottom: 2px solid var(--gold); padding-bottom: 20px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .export-title { font-size: 2.5em; color: var(--gold); font-weight: bold; letter-spacing: 5px; text-shadow: 0 0 10px rgba(212,175,55,0.3); }
        .export-info { text-align: right; color: #aaa; font-size: 1.1em; line-height: 1.5; }
        .export-body-grid { display: grid; grid-template-columns: 450px 1fr; gap: 30px; }
        .export-section-title { color: var(--cyan); border-left: 5px solid var(--gold); padding-left: 15px; margin-bottom: 10px; font-size: 1.4em; font-weight: bold; margin-top: 10px;}
        .export-chart-img { width: 100%; border-radius: 8px; border: 1px solid #444; background: #1e2732; padding: 10px; }
        .export-list-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333; font-size: 1.1em; }
        .export-pillar-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .export-pillar-item { background: #1e2732; border: 1px solid #444; border-radius: 6px; padding: 10px; text-align: center; }
        .export-p-head { font-size: 0.9em; color: #888; font-weight: bold; }
        .export-p-star { font-size: 1.4em; font-weight: bold; color: #eee; margin: 5px 0; }
        .export-p-slogan { font-size: 0.8em; color: var(--cyan); line-height: 1.3; }
        .highlight-box { background: rgba(212, 175, 55, 0.05); border: 1px solid var(--gold); padding: 20px; border-radius: 8px; margin-top: 10px; }
        .highlight-content { font-size: 1.1em; line-height: 1.8; color: #ddd; }
        .export-footer { text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #333; color: var(--bronze); font-size: 1.2em; letter-spacing: 2px; font-weight: bold; }
    </style>
</head>
<body>
<div id="loadingOverlay"><div class="spinner"></div></div>

<h1>é”æ‘©ä¸€æŒç¶“ï¼ç”Ÿå‘½è—åœ–å°èˆªç³»çµ±</h1>

<div class="header-controls">
    <button class="btn-crm" onclick="window.location.href='/crm'">
        ğŸ“‚ é€²å…¥å®¢æˆ¶æˆ°æƒ…å®¤ (CRM)
    </button>
</div>

<div class="dashboard">
    <div class="control-panel">
        <h3 style="color:var(--cyan); border-bottom:1px solid #444;">1. è¨­å®šæ¡ˆä¸»æœ¬å‘½</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div><label>æ€§åˆ¥</label><select id="gender"><option value="1">ç”· (é †è¡Œ)</option><option value="0">å¥³ (é€†è¡Œ)</option></select></div>
            <div>
                <label>å‡ºç”Ÿæ™‚è¾°</label>
                <select id="hour">
                    <option value="å­">å­æ™‚ (23:00-01:00)</option><option value="ä¸‘">ä¸‘æ™‚ (01:00-03:00)</option><option value="å¯…">å¯…æ™‚ (03:00-05:00)</option>
                    <option value="å¯">å¯æ™‚ (05:00-07:00)</option><option value="è¾°">è¾°æ™‚ (07:00-09:00)</option><option value="å·³">å·³æ™‚ (09:00-11:00)</option>
                    <option value="åˆ">åˆæ™‚ (11:00-13:00)</option><option value="æœª">æœªæ™‚ (13:00-15:00)</option><option value="ç”³">ç”³æ™‚ (15:00-17:00)</option>
                    <option value="é…‰">é…‰æ™‚ (17:00-19:00)</option><option value="æˆŒ">æˆŒæ™‚ (19:00-21:00)</option><option value="äº¥">äº¥æ™‚ (21:00-23:00)</option>
                </select>
            </div>
        </div>
        <label>åœ‹æ›†å‡ºç”Ÿæ—¥æœŸ</label><input type="date" id="solarDate" value="1985-03-27">
        
        <h3 style="color:var(--gold); border-bottom:1px solid #444; margin-top:15px; margin-bottom:10px; font-size:1em;">2. è¨­å®šæ¨ç®—ç›®æ¨™</h3>
        
        <div class="radio-group">
            <label class="radio-label"><input type="radio" name="calendarType" value="lunar" checked onchange="updateFormUI()"> è¾²æ›†</label>
            <label class="radio-label"><input type="radio" name="calendarType" value="solar" onchange="updateFormUI()"> è¥¿å…ƒæ›†</label>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <select id="targetScope" onchange="updateFormUI()" style="flex:1; margin-bottom:0;">
                <option value="year">æµå¹´ (åªçœ‹å¹´)</option><option value="month">æµæœˆ (å¹´+æœˆ)</option>
                <option value="day">æµæ—¥ (å¹´+æœˆ+æ—¥)</option><option value="hour">æµæ™‚ (å¹´+æœˆ+æ—¥+æ™‚)</option>
            </select>
        </div>
        
        <div id="yearInput" class="input-group show" style="margin-bottom:10px;"><input type="number" id="tYear" value="2026" placeholder="å¹´ä»½" style="margin-bottom:0;"></div>
        <div id="monthInput" class="input-group" style="margin-bottom:10px;"><input type="number" id="tMonth" value="1" min="1" max="12" placeholder="æœˆä»½" style="margin-bottom:0;"></div>
        <div id="dayInput" class="input-group" style="margin-bottom:10px;"><input type="number" id="tDay" value="1" min="1" max="31" placeholder="æ—¥æœŸ" style="margin-bottom:0;"></div>
        <div id="hourInput" class="input-group" style="margin-bottom:10px;">
            <select id="tHour" style="margin-bottom:0;">
                <option value="å­">å­æ™‚ (23:00-01:00)</option><option value="ä¸‘">ä¸‘æ™‚ (01:00-03:00)</option><option value="å¯…">å¯…æ™‚ (03:00-05:00)</option>
                <option value="å¯">å¯æ™‚ (05:00-07:00)</option><option value="è¾°">è¾°æ™‚ (07:00-09:00)</option><option value="å·³">å·³æ™‚ (09:00-11:00)</option>
                <option value="åˆ">åˆæ™‚ (11:00-13:00)</option><option value="æœª">æœªæ™‚ (13:00-15:00)</option><option value="ç”³">ç”³æ™‚ (15:00-17:00)</option>
                <option value="é…‰">é…‰æ™‚ (17:00-19:00)</option><option value="æˆŒ">æˆŒæ™‚ (19:00-21:00)</option><option value="äº¥">äº¥æ™‚ (21:00-23:00)</option>
            </select>
        </div>

        <button class="btn-main" onclick="calculate()" style="margin-top:10px;">ğŸš€ é–‹å•Ÿé‹å‹¢å°èˆª</button>
        
        <div class="action-grid">
            <button class="btn-icon btn-save" onclick="openSaveModal()">
                ğŸ’¾ å„²å­˜ç´€éŒ„
            </button>
            <button class="btn-icon btn-down" onclick="exportToImage()">
                ğŸ“¸ ä¸‹è¼‰å ±å‘Š
            </button>
            <button class="btn-icon btn-audit" onclick="openAuditModal()">
                ğŸ“Š æ ¸å°åˆ†æ•¸æ˜ç´° (Debug)
            </button>
        </div>
    </div>

    <div class="info-panel" id="resultArea">
        
        <div class="card" style="border-left:5px solid var(--gold); overflow:hidden;">
            <h3 class="card-header" style="color:var(--gold);">
                <div style="display:flex; align-items:center; width:100%">
                    <div style="white-space:nowrap;">å‘½ç›¤å…¨æ¯åœ– <span id="lunarInfo" style="font-size:0.8em; color:#a0a0a0;"></span></div>
                    <div style="display:flex; align-items:center; margin-left:auto;">
                        <div class="switch-container">
                            <span class="switch-label">å‹•ç•«</span>
                            <label class="switch">
                                <input type="checkbox" id="animToggle" onchange="toggleAnim(this)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="animControls" style="display:none; font-size:0.8em;">
                            <button class="ctrl-btn" id="pauseBtn" onclick="togglePause(); event.stopPropagation();">â¯</button>
                            <button class="ctrl-btn finish" onclick="skipToComplete(); event.stopPropagation();">â©</button>
                            <button class="ctrl-btn" onclick="replayAnimation(); event.stopPropagation();">ğŸ”„</button>
                        </div>
                    </div>
                </div>
            </h3>
            <div class="twelve-palaces-map" id="mainMap">
                <div class="grid-cell" id="cell-å·³"><div class="pillar-badges-container"></div><span class="cell-zhi">å·³</span><span class="cell-star">å¤©æ–‡</span><span class="cell-realm">ä»™é“</span></div>
                <div class="grid-cell" id="cell-åˆ"><div class="pillar-badges-container"></div><span class="cell-zhi">åˆ</span><span class="cell-star">å¤©ç¦</span><span class="cell-realm">ä½›é“</span></div>
                <div class="grid-cell" id="cell-æœª"><div class="pillar-badges-container"></div><span class="cell-zhi">æœª</span><span class="cell-star">å¤©é©›</span><span class="cell-realm">é¬¼é“</span></div>
                <div class="grid-cell" id="cell-ç”³"><div class="pillar-badges-container"></div><span class="cell-zhi">ç”³</span><span class="cell-star">å¤©å­¤</span><span class="cell-realm">äººé“</span></div>
                <div class="grid-cell" id="cell-è¾°"><div class="pillar-badges-container"></div><span class="cell-zhi">è¾°</span><span class="cell-star">å¤©å¥¸</span><span class="cell-realm">ä¿®ç¾…</span></div>
                <div class="center-decoration"><span style="font-size:3em; color:var(--gold);">â˜¯</span></div>
                <div class="grid-cell" id="cell-é…‰"><div class="pillar-badges-container"></div><span class="cell-zhi">é…‰</span><span class="cell-star">å¤©åˆƒ</span><span class="cell-realm">ç•œé“</span></div>
                <div class="grid-cell" id="cell-å¯"><div class="pillar-badges-container"></div><span class="cell-zhi">å¯</span><span class="cell-star">å¤©ç ´</span><span class="cell-realm">ç•œé“</span></div>
                <div class="grid-cell" id="cell-æˆŒ"><div class="pillar-badges-container"></div><span class="cell-zhi">æˆŒ</span><span class="cell-star">å¤©è—</span><span class="cell-realm">ä¿®ç¾…</span></div>
                <div class="grid-cell" id="cell-å¯…"><div class="pillar-badges-container"></div><span class="cell-zhi">å¯…</span><span class="cell-star">å¤©æ¬Š</span><span class="cell-realm">äººé“</span></div>
                <div class="grid-cell" id="cell-ä¸‘"><div class="pillar-badges-container"></div><span class="cell-zhi">ä¸‘</span><span class="cell-star">å¤©å„</span><span class="cell-realm">é¬¼é“</span></div>
                <div class="grid-cell" id="cell-å­"><div class="pillar-badges-container"></div><span class="cell-zhi">å­</span><span class="cell-star">å¤©è²´</span><span class="cell-realm">ä½›é“</span></div>
                <div class="grid-cell" id="cell-äº¥"><div class="pillar-badges-container"></div><span class="cell-zhi">äº¥</span><span class="cell-star">å¤©å£½</span><span class="cell-realm">ä»™é“</span></div>
            </div>
        </div>

        <div class="card">
            <h3 class="card-header" onclick="toggleCard('pillarsBody')">æœ¬å‘½æ ¹åŸº <span style="font-size:0.7em; color:var(--cyan); margin-left:10px;">(é»æ“Šå¡ç‰‡æŸ¥çœ‹è©³è§£)</span> <span class="arrow-icon collapsed" style="margin-left:auto;">â–¼</span></h3>
            <div id="pillarsBody" class="card-body collapsed">
                <div class="four-pillars" id="pillarsArea"></div>
                <div id="specialPatternsArea" class="pattern-area"></div>
            </div>
        </div>

        <div class="card" style="border-left:5px solid var(--cyan);">
            <h3 class="card-header" onclick="toggleCard('hierarchyBody')">
                æ™‚ç©ºæˆ°ç•¥å®šä½ 
                <span class="arrow-icon collapsed" style="margin-left:auto;">â–¼</span>
            </h3>
            <div id="hierarchyBody" class="card-body collapsed"><div id="hierarchyArea"></div></div>
        </div>
        
        <div class="card" style="border-left: 5px solid var(--gold);">
            <h3 class="card-header" onclick="toggleCard('trendBody')">
                <div id="trendHeaderContainer" style="display:flex; align-items:center; width:100%; justify-content: space-between;">
                    <span style="white-space:nowrap;">é‹å‹¢èƒ½é‡èµ°å‹¢åœ– <span style="font-size:0.7em; color:#888;">(åˆå§‹åŒ–ä¸­...)</span></span>
                    <span class="arrow-icon" style="margin-left:10px;">â–¼</span>
                </div>
            </h3>

            <div id="trendBody" class="card-body">
                <div style="margin-bottom:10px; display:flex; justify-content:flex-end; gap:15px;">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="gradeCheckbox" onchange="updateTrendChart(lastActiveAspect)">
                        â˜‘ åäºŒå®®ä¸‰å“æ ¼
                    </label>
                    <label class="checkbox-wrapper" style="color:var(--cyan);">
                        <input type="checkbox" id="renheCheckbox" onchange="updateTrendChart(lastActiveAspect)">
                        â˜‘ æ ¹åŸº (äººå’Œ)
                    </label>
                </div>
                <div style="height: 250px; width: 100%;"><canvas id="trendChart"></canvas></div>
            </div>
        </div>

        <div class="card">
            <h3 class="card-header" onclick="toggleCard('aspectsBody')">
                åäºŒå®®ä½é‹ç¨‹è©³è§£ <span style="font-size:0.7em; color:var(--cyan);">(é»æ“Šé …ç›®åˆ‡æ›æ³¢å½¢)</span>
                <span class="arrow-icon">â–¼</span>
            </h3>
            <div id="aspectsBody" class="card-body"><div id="aspectsList"></div></div>
        </div>

        <div class="card" style="background:#161625; border-color:var(--gpt-color);">
            <h3 class="card-header" onclick="toggleCard('aiBody')" style="color:var(--gpt-color);">
                ğŸ“œ é”æ‘©æ™ºå›Šï¼æˆ°ç•¥åƒè¬€ <span style="font-size:0.7em; color:#888;">(V10.3)</span>
                <span class="arrow-icon collapsed" style="margin-left:auto;">â–¼</span>
            </h3>
            <div id="aiBody" class="card-body collapsed">
                <div class="ai-controls">
                    <button class="ai-shortcut-btn" onclick="sendToAI('è«‹å¹«æˆ‘æ‰¾å‡ºé€™å¼µç›¤æœ€è‡´å‘½çš„å¼±é»(åˆ†æ•¸æœ€ä½)ï¼Œä¸¦çµ¦å‡ºæˆ°ç•¥å»ºè­°ã€‚')">ğŸ—¡ï¸ ç›´æ“Šç—›é»</button>
                    <button class="ai-shortcut-btn" onclick="sendToAI('è«‹åˆ†æç›®å‰çš„æˆ°ç•¥æ™‚æ©Ÿï¼Œç¾åœ¨é©åˆé€²æ”»é‚„æ˜¯é˜²å®ˆï¼Ÿ')">âš–ï¸ å¯©è¦–æ™‚å±€</button>
                    <button class="ai-shortcut-btn" onclick="sendToAI('é‡å°ç›®å‰çš„é‹å‹¢ï¼Œè«‹çµ¦æˆ‘ä¸€æ®µå»ºè­°å®¢æˆ¶çš„è©±è¡“ï¼Œèªæ°£è¦å§”å©‰ä½†å …å®šã€‚')">ğŸ—£ï¸ è«®è©¢è©±è¡“</button>
                </div>
                <div class="chat-window" id="chatWindow">
                    <div class="chat-message ai">å¾å³°è€å¸«æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ‚¨çš„ã€é”æ‘©æ™ºå›Šã€‘ã€‚å‘½ç›¤å·²å‚™å¦¥ï¼Œè«‹è³œæ•™æˆ–é»é¸ä¸Šæ–¹åŠŸèƒ½é€²è¡Œæ¨æ¼”ã€‚</div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="userChatInput" class="chat-input" placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ..." onkeypress="if(event.key==='Enter') manualSend()">
                    <button class="btn-main" style="width:80px; margin-top:0; padding:5px; background:var(--gpt-color); color:white;" onclick="manualSend()">ç™¼é€</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="pillarModal" class="modal">
    <div class="modal-content" style="max-width: 500px; border-color: var(--cyan);">
        <h3 style="color:var(--cyan); border-bottom:1px solid #444; margin-bottom:15px; display:flex; justify-content:space-between;">
            <span id="modalPillarTitle">å¹´æŸ±è§£æ</span>
            <span style="font-size:0.7em; color:#888;" id="modalPillarZhi">å­ (å¤©è²´)</span>
        </h3>
        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:6px; margin-bottom:20px;">
            <div id="modalPillarSlogan" style="color:var(--gold); font-weight:bold; margin-bottom:10px; border-bottom:1px dashed #555; padding-bottom:5px;"></div>
            <div id="modalPillarPoem" style="color:#a3a3ff; font-family:'Kaiti', 'Microsoft JhengHei', serif; font-size:1.05em; line-height:1.4; margin-bottom:12px; padding:8px; background:rgba(0,0,0,0.2); border-left:3px solid #a3a3ff; font-style:italic;"></div>
            <div id="modalPillarDesc" style="color:#eee; line-height:1.6; font-size:1.1em;"></div>
        </div>
        <div class="modal-footer" style="justify-content: space-between;">
            <button class="btn-main" style="width:auto; margin:0; background:var(--gpt-color); font-size:0.9em; padding:8px 15px;" onclick="analyzePillarWithAI()">ğŸ“œ æ­è«‹æ™ºå›Šï¼æ·±åº¦è§£ç›¤</button>
            <button class="ctrl-btn" onclick="document.getElementById('pillarModal').style.display='none'">é—œé–‰</button>
        </div>
    </div>
</div>

<div id="exportContainer">
    <div class="export-header">
        <div class="export-title">é”æ‘©ä¸€æŒç¶“ï¼ç”Ÿå‘½è—åœ–å°èˆª</div>
        <div class="export-info" id="exportInfo"></div>
    </div>
    <div class="export-body-grid">
        <div>
            <div class="export-section-title">æœ¬å‘½å…¨æ¯åœ– (åäºŒå®®)</div>
            <div id="exportMapContainer" style="transform: scale(0.95); transform-origin: top left; margin-bottom:15px;"></div>
            <div class="export-section-title">æœ¬å‘½æ ¹åŸº (å››æŸ±)</div>
            <div id="exportPillarsContainer" class="export-pillar-grid"></div>
        </div>
        <div>
            <div class="export-section-title">åäºŒå®®ä½é‹ç¨‹åˆ†æ</div>
            <div id="exportAspectList"></div>
        </div>
    </div>
    <div>
        <div class="export-section-title">é‹å‹¢èƒ½é‡èµ°å‹¢åœ–</div>
        <h4 style="color:var(--gold); text-align:center; margin:0 0 10px 0;" id="exportChartTitle"></h4>
        <img id="exportChartImg" class="export-chart-img">
        <div class="highlight-box">
            <h4 style="color:var(--gold); margin:0 0 10px 0;">ğŸ”® é‹å‹¢é‡é»æç¤º</h4>
            <div id="exportHighlights" class="highlight-content"></div>
        </div>
    </div>
    <div class="export-footer">å¾å³°è€å¸« é‹å‹¢æŒ‡å° | é”æ‘©ç”Ÿå‘½è—åœ–å°èˆªç³»çµ± V10.5</div>
</div>

<div id="saveModal" class="modal">
    <div class="modal-content">
        <h3>ğŸ’¾ å»ºç«‹å®¢æˆ¶æª”æ¡ˆ</h3>
        <div class="form-group"><label>å®¢æˆ¶å§“å</label><input type="text" id="crmName" placeholder="ä¾‹å¦‚ï¼šé™³å¤§ç™¼"></div>
        <div class="form-group"><label>è¯çµ¡é›»è©± / Line</label><input type="text" id="crmPhone" placeholder="09xx-xxx-xxx"></div>
        <div class="form-group"><label>å®¢æˆ¶æ¨™ç±¤</label><div class="tag-container" id="tagList"><span class="tag-chip" onclick="toggleTag(this)">VIP</span><span class="tag-chip" onclick="toggleTag(this)">ä¼æ¥­è«®è©¢</span><span class="tag-chip" onclick="toggleTag(this)">æ„Ÿæƒ…å›°æ“¾</span><span class="tag-chip" onclick="toggleTag(this)">å·²ä»˜æ¬¾</span><span class="tag-chip" onclick="toggleTag(this)">éœ€è¿½è¹¤</span></div></div>
        <div class="form-group"><label>è«®è©¢ç­†è¨˜</label><textarea id="crmNote" rows="2" placeholder="ç´€éŒ„é‡é»..."></textarea></div>
        <div class="form-group"><label style="color:var(--gpt-color);">ğŸ¤– AI å»ºè­°æ‘˜è¦ (è‡ªå‹•å¸¶å…¥)</label><textarea id="crmAiContent" rows="4" style="border-color:var(--gpt-color); color:#cfd8dc; font-size:0.9em;"></textarea></div>
        <div class="modal-footer"><button class="ctrl-btn" onclick="closeSaveModal()">å–æ¶ˆ</button><button class="ctrl-btn active" onclick="confirmSave()">ç¢ºèªå„²å­˜</button></div>
    </div>
</div>
<div id="auditModal" class="modal"><div class="modal-content" style="max-width: 900px; width: 95%;"></div></div>

<script>
    // 1. [V10.7] é”æ‘©ç¦ªæ©Ÿï¼æˆ°ç•¥æ‰¹æ–‡åº« (ä½›å­¸/å¤ç±è¦–è§’)
    const PALACE_STRATEGY = {
        "ç¸½å‘½é‹": {
            "ç”Ÿæˆ‘": "æ‰¹æ–‡: çŒ¶å¦‚å¤©é™ç”˜éœ–ï¼Œå‰ä¸–ç´¯ç©ä¹‹å–„æ¥­æˆç†Ÿï¼Œå¾—è²´äººè­·æŒï¼Œè«¸äº‹é †é‚ã€‚",
            "æ¯”æ—º": "æ‰¹æ–‡: åŒæ°£ç›¸æ±‚ï¼Œå–„å‹é›²é›†ï¼Œå¦‚å…¥èŠè˜­ä¹‹å®¤ï¼Œäººéš›å’Œè«§ï¼Œç¦æ…§é›™ä¿®ã€‚",
            "æˆ‘ç”Ÿ": "æ‰¹æ–‡: æ…ˆæ‚²å–œæ¨ï¼Œå»£çµå–„ç·£ï¼Œç‡ƒç‡’è‡ªå·±ç…§äº®åˆ¥äººï¼Œé›–å‹å¿ƒä½†ç©ç´¯ç„¡é‡åŠŸå¾·ã€‚",
            "æˆ‘å‰‹": "æ‰¹æ–‡: æ­·äº‹ç·´å¿ƒï¼Œå¦‚è“®èŠ±å‡ºæ·¤æ³¥ï¼Œéœ€åœ¨é€†å¢ƒä¸­ç²¾é€²ï¼Œè½‰ç…©æƒ±ç‚ºè©æã€‚",
            "å‰‹æˆ‘": "æ‰¹æ–‡: æ¥­åŠ›ç¾å‰ï¼Œå†¤è¦ªå‚µä¸»å¹²æ“¾ï¼Œé‹å‹¢å—é˜»ï¼Œå®œæ‡ºæ‚”æ¶ˆæ¥­ï¼Œä½èª¿æ½›ä¼ã€‚"
        },
        "å½¢è±¡": {
            "ç”Ÿæˆ‘": "æ‰¹æ–‡: æ³•ç›¸èŠåš´ï¼Œè‡ªå¸¶å…‰ç’°ï¼Œä»–äººè¦‹ä¹‹å¦‚æ²æ˜¥é¢¨ï¼Œæ˜“å¾—å¤§çœ¾æ„›æˆ´ã€‚",
            "æ¯”æ—º": "æ‰¹æ–‡: å¹³æ˜“è¿‘äººï¼Œç„¡åˆ†åˆ¥å¿ƒï¼Œèˆ‡çœ¾ç”Ÿå»£çµå–„ç·£ï¼Œå¤–åœ¨å½¢è±¡è¦ªåˆ‡å’Œè—¹ã€‚",
            "æˆ‘ç”Ÿ": "æ‰¹æ–‡: æ¨‚æ–¼å¥‰ç»ï¼Œå› å¸ƒæ–½è€Œé¡¯å¾—é«˜è²´ï¼Œé›–å¥”æ³¢å‹ç¢Œï¼Œå»è´å¾—çœŸå¯¦å£ç¢‘ã€‚",
            "æˆ‘å‰‹": "æ‰¹æ–‡: é¢¨æ ¼ç¨ç‰¹ï¼Œä¸ç•ä¸–ä¿—çœ¼å…‰ï¼Œå¦‚ç¨è¡Œä¿ èˆ¬å±•ç¾è‡ªæˆ‘ï¼Œé›–æœ‰çˆ­è­°ä½†é¡¯å€‹æ€§ã€‚",
            "å‰‹æˆ‘": "æ‰¹æ–‡: æ˜“æ‹›èª¤è§£ï¼Œå¦‚æ˜ç è’™å¡µï¼Œé­äººæ¯€è¬—æˆ–å«‰å¦’ï¼Œéœ€è¬¹è¨€æ…è¡Œä»¥é¿å£æ¥­ã€‚"
        },
        "å¹¸ç¦": {
            "ç”Ÿæˆ‘": "æ‰¹æ–‡: ç¥–å¾·æµèŠ³ï¼Œç¦å ±æ·±åšï¼Œå…§å¿ƒå¸¸ä¿å–œæ¨‚ï¼Œæ‰€æ±‚çš†èƒ½å¦‚é¡˜ï¼Œå®‰æ¨‚è‡ªåœ¨ã€‚",
            "æ¯”æ—º": "æ‰¹æ–‡: çŸ¥è¶³å¸¸æ¨‚ï¼Œéš¨é‡è€Œå®‰ï¼Œå®¶åº­å’Œåˆç„¡è«ï¼Œå¿ƒéˆå¯Œè¶³ä¸å‡å¤–æ±‚ã€‚",
            "æˆ‘ç”Ÿ": "æ‰¹æ–‡: æ–½æ¯”å—æ›´æœ‰ç¦ï¼Œå°‡å¹¸ç¦å¯„è¨—æ–¼ç…§é¡§ä»–äººï¼Œé›–å‹å¿ƒå‹åŠ›ï¼Œå¿ƒéˆå»æ»¿è¶³ã€‚",
            "æˆ‘å‰‹": "æ‰¹æ–‡: è¿½æ±‚å®Œç¾ï¼Œæ˜“ç”ŸåŸ·è‘—ï¼Œå¦‚æ¸´é¹¿é€ç„°ï¼Œå¿ƒéš¨å¢ƒè½‰ï¼Œé›£å¾—ç‰‡åˆ»æ¸…é–’ã€‚",
            "å‰‹æˆ‘": "æ‰¹æ–‡: å…§å¿ƒä¸å®‰ï¼Œç…©æƒ±ç†¾ç››ï¼Œå¦‚è™•èŠæ£˜æ—ä¸­ï¼Œæ˜“ç”Ÿç„¡åç„¦æ…®ï¼Œéœ€ä¿®å®šåŠ›ã€‚"
        },
        "äº‹æ¥­": {
            "ç”Ÿæˆ‘": "æ‰¹æ–‡: é †æ°´æ¨èˆŸï¼Œå¾—ä¸Šå¸ææ‹”æˆ–æ”¿ç­–æ‰¶æŒï¼Œè³‡æºå…·è¶³ï¼Œå¦‚é­šå¾—æ°´ã€‚",
            "æ¯”æ—º": "æ‰¹æ–‡: çœ¾å¿—æˆåŸï¼Œå¾—åŒä¿®é“å‹ç›¸åŠ©ï¼Œåœ˜éšŠåˆä½œç„¡é–“ï¼Œäº‹æ¥­ç©©å¥ç™¼å±•ã€‚",
            "æˆ‘ç”Ÿ": "æ‰¹æ–‡: æ™®æ¸¡çœ¾ç”Ÿï¼Œä»¥å°ˆæ¥­æŠ€è¡“æœå‹™ä»–äººï¼Œå¤šå‹å¤šå¾—ï¼Œé çœŸæ‰å¯¦å­¸ç«‹è¶³ã€‚",
            "æˆ‘å‰‹": "æ‰¹æ–‡: é–‹ç–†é—¢åœŸï¼Œå¦‚å°‡è»ä¸Šæˆ°å ´ï¼Œéœ€å¤§ç ´å¤§ç«‹ï¼Œåœ¨é©šæ¿¤é§­æµªä¸­æˆå°±éœ¸æ¥­ã€‚",
            "å‰‹æˆ‘": "æ‰¹æ–‡: é€†å¢ä¸Šç·£ï¼Œç’°å¢ƒéšªæƒ¡ï¼Œå°äººé˜»ç¤™å¤šï¼Œè¦–ç‚ºè€ƒé©—å¿ƒå¿—ä¹‹ç£¨é›£ï¼Œå®œå®ˆæˆã€‚"
        },
        "è®Šå‹•": {
            "ç”Ÿæˆ‘": "æ‰¹æ–‡: é©›é¦¬é€¢è²´ï¼Œè¶Šå‹•è¶Šå‰ï¼Œå¤–å‡ºå¾—é‡å–„çŸ¥è­˜ï¼Œç•°åœ°ç™¼å±•å¦‚æœ‰ç¥åŠ©ã€‚",
            "æ¯”æ—º": "æ‰¹æ–‡: å‹•éœçš†å®œï¼Œéš¨ç·£è‡ªåœ¨ï¼Œé©æ‡‰åŠ›å¼·ï¼Œç„¡è«–èº«è™•ä½•åœ°çš†èƒ½å®‰èº«ç«‹å‘½ã€‚",
            "æˆ‘ç”Ÿ": "æ‰¹æ–‡: ç‚ºæ³•å¿˜è»€ï¼Œä¸»å‹•å¥”æ³¢ä»¥å°‹æ±‚çªç ´ï¼Œé›†æ€å»£ç›Šï¼Œè®Šå‹•ä¸­é–‹å‰µæ–°å±€ã€‚",
            "æˆ‘å‰‹": "æ‰¹æ–‡: è¢«è¿«é·å¾™ï¼Œå‹ç¢Œå¥”æ³¢ï¼Œå¦‚æµ®èéš¨æ³¢ï¼Œéœ€åœ¨è®Šå‹•ä¸­æ±‚ç”Ÿå­˜ï¼ŒèˆŸè»Šå‹é “ã€‚",
            "å‰‹æˆ‘": "æ‰¹æ–‡: æµé›¢å¤±æ‰€ï¼Œå‹•ç›ªä¸å®‰ï¼Œå‰è·¯èŒ«èŒ«ï¼Œä¸å®œè¼•èˆ‰å¦„å‹•ï¼Œé˜²äº¤é€šæ„å¤–ã€‚"
        },
        "å¥åº·": {
            "ç”Ÿæˆ‘": "æ‰¹æ–‡: å…ƒæ°£é£½æ»¿ï¼Œå¾—å¤©ç¨åšï¼Œé«”è³ªå¼·å¥ï¼Œç—…é­”ä¸ä¾µï¼Œé€¢å‡¶åŒ–å‰ã€‚",
            "æ¯”æ—º": "æ‰¹æ–‡: èº«å¿ƒå¹³è¡¡ï¼Œé™°é™½èª¿å’Œï¼Œä¿é¤Šå¾—å®œï¼Œç²¾æ°£ç¥è¶³ï¼Œç„¡ç—…ç„¡ç½ã€‚",
            "æˆ‘ç”Ÿ": "æ‰¹æ–‡: è€—æå…ƒæ°£ï¼Œå› æ“å‹éåº¦è€Œé«”è™›ï¼Œéœ€æ³¨æ„ä¼‘é¤Šï¼Œé¿å…ç©å‹æˆç–¾ã€‚",
            "æˆ‘å‰‹": "æ‰¹æ–‡: å½¢ç¥åˆ†é›¢ï¼Œèº«é«”ç·Šç¹ƒï¼Œæ˜“æœ‰å¤–å‚·æˆ–æ„å¤–ï¼Œéœ€æ³¨æ„å®‰å…¨ï¼Œæˆ’ä¹‹åœ¨é¬¥ã€‚",
            "å‰‹æˆ‘": "æ‰¹æ–‡: å››å¤§ä¸èª¿ï¼Œæ¥­éšœç—…ç¾å‰ï¼Œå®¿ç–¾å¾©ç™¼ï¼Œéœ€æ‡ºæ‚”ä¸¦é…åˆé†«è—¥èª¿ç†ã€‚"
        },
        "æ„›æƒ…": {
            "ç”Ÿæˆ‘": "æ‰¹æ–‡: å–„ç·£æˆç†Ÿï¼Œä¼´ä¾¶å¦‚è­·æ³•ç¥èˆ¬å®ˆè­·ï¼Œæ©æ„›å’Œè«§ï¼Œå¦‚è† ä¼¼æ¼†ã€‚",
            "æ¯”æ—º": "æ‰¹æ–‡: è©æçœ·å±¬ï¼Œå¿—åŒé“åˆï¼Œç›¸è™•å¦‚å‹ï¼Œäº’æ•¬äº’è«’ï¼Œå¹³æ·¡ä¸­è¦‹çœŸæƒ…ã€‚",
            "æˆ‘ç”Ÿ": "æ‰¹æ–‡: æ…ˆæ‚²ç‚ºæ‡·ï¼Œä¸»å‹•ä»˜å‡ºä¸æ±‚å›å ±ï¼Œé›–æœ‰çŠ§ç‰²ï¼Œä½†ç”¨æƒ…è‡³æ·±ã€‚",
            "æˆ‘å‰‹": "æ‰¹æ–‡: æ„›æ¨äº¤ç¹”ï¼Œä½”æœ‰æ…¾å¼·ï¼Œå¦‚è—¤çºæ¨¹ï¼Œæ˜“ç”ŸåŸ·è‘—èˆ‡çˆ­åŸ·ï¼Œéœ€å­¸æœƒæ”¾æ‰‹ã€‚",
            "å‰‹æˆ‘": "æ‰¹æ–‡: å†¤å®¶è·¯çª„ï¼Œè²Œåˆç¥é›¢ï¼Œäº’ç›¸æŠ˜ç£¨ï¼Œæ­¤ç‚ºå‰ä¸–ç›¸æ¬ ï¼Œéœ€é‚„å‚µäº†æ¥­ã€‚"
        },
        "é ˜å°": {
            "ç”Ÿæˆ‘": "æ‰¹æ–‡: å¾·é«˜æœ›é‡ï¼Œä»¥å¾·æœäººï¼Œéƒ¨å±¬æ­æ•¬é †å¾ï¼Œçœ¾æœ›æ‰€æ­¸ï¼Œä¸€å‘¼ç™¾æ‡‰ã€‚",
            "æ¯”æ—º": "æ‰¹æ–‡: å¹³ç­‰äº’æƒ ï¼Œèˆ‡éƒ¨å±¬å¦‚å…„å¼Ÿæ‰‹è¶³ï¼Œåœ˜éšŠå’Œè«§ï¼Œå…±åŒé€²é€€ã€‚",
            "æˆ‘ç”Ÿ": "æ‰¹æ–‡: å¾ªå¾ªå–„èª˜ï¼Œè¦ªåŠ›è¦ªç‚ºæ•™å°ä¸‹å±¬ï¼Œé›–å‹å¿ƒå‹åŠ›ï¼Œä½†èƒ½åŸ¹è‚²è‹±æ‰ã€‚",
            "æˆ‘å‰‹": "æ‰¹æ–‡: é›·å²é¢¨è¡Œï¼Œåš´æ ¼ç®¡ç†ï¼Œä»¥å¨å‹¢æ”çœ¾ï¼Œéƒ¨å±¬æ•¬ç•ï¼Œä»¤å‡ºå¿…è¡Œã€‚",
            "å‰‹æˆ‘": "æ‰¹æ–‡: å¨ä¿¡æƒåœ°ï¼Œéƒ¨å±¬åå›ï¼Œæ¬ŠåŠ›è¢«æ¶ç©ºï¼Œå­¤æŒé›£é³´ï¼Œé ˜å°ç„¡æ–¹ã€‚"
        },
        "è¦ªä¿¡": {
            "ç”Ÿæˆ‘": "æ‰¹æ–‡: å¿ å¿ƒè­·ä¸»ï¼Œå¾—åŠ›åŠ©æ‰‹å¦‚å·¦å³æ‰‹ï¼Œç‚ºä½ åˆ†æ†‚è§£å‹ï¼Œå¯æ”¾å¿ƒè¨—ä»˜ã€‚",
            "æ¯”æ—º": "æ‰¹æ–‡: è‚è†½ç›¸ç…§ï¼Œäº’ä¿¡äº’åŠ©ï¼Œåˆä½œç„¡é–“ï¼Œæƒ…ç¾©ç›¸æŒºï¼Œå¦‚é‡‘å‰›èˆ¬å …å›ºã€‚",
            "æˆ‘ç”Ÿ": "æ‰¹æ–‡: è²»å¿ƒæ ½åŸ¹ï¼Œçµ¦äºˆæ©Ÿæœƒï¼Œéœ€æ™‚é–“é¤Šæˆï¼Œè¦–ç‚ºåšåŠŸå¾·ï¼Œæ™šå¹´æ–¹å¾—å›å ±ã€‚",
            "æˆ‘å‰‹": "æ‰¹æ–‡: åˆ©ç›Šäº¤æ›ï¼Œç”¨äººå”¯æ‰ï¼Œåš´åŠ è€ƒæ ¸ï¼Œéœ€é˜²ç¯„èƒŒå›ï¼Œä¸å¯å…¨ç›¤æ‰˜å‡ºã€‚",
            "å‰‹æˆ‘": "æ‰¹æ–‡: å¼•ç‹¼å…¥å®¤ï¼Œè¦ªä¿¡ç„¡èƒ½ç”šè‡³æ‰¯å¾Œè…¿ï¼Œç”¨äººéœ€è¬¹æ…ï¼Œé˜²å…§ç¥é€šå¤–é¬¼ã€‚"
        },
        "æ ¹åŸº": {
            "ç”Ÿæˆ‘": "æ‰¹æ–‡: ç¥–è”­åº‡ä½‘ï¼Œå®¶åº•æ®·å¯¦ï¼Œå…ˆå¤©è³‡ç³§å…·è¶³ï¼Œè´åœ¨èµ·è·‘é»ï¼Œç¹¼æ‰¿å®¶æ¥­ã€‚",
            "æ¯”æ—º": "æ‰¹æ–‡: æ ¹åŸºç©©å›ºï¼Œå®ˆæˆæœ‰é¤˜ï¼Œå®‰å±…æ¨‚æ¥­ï¼Œè¡£é£Ÿç„¡æ†‚ï¼Œç¦æ¾¤ç¶¿é•·ã€‚",
            "æˆ‘ç”Ÿ": "æ‰¹æ–‡: ç™½æ‰‹èµ·å®¶ï¼Œé–‹ææ•£è‘‰ï¼Œç‚ºå¾Œä»£ç©ç¦ï¼Œå‰µæ¥­èˆˆå®¶ï¼Œè¾›è‹¦æ’­ç¨®ã€‚",
            "æˆ‘å‰‹": "æ‰¹æ–‡: é›¢é„‰èƒŒäº•ï¼Œè‡ªç«‹é–€æˆ¶ï¼Œå…­è¦ªç„¡é ï¼Œè¾›è‹¦å»ºç«‹åŸºæ¥­ï¼Œå…ˆè‹¦å¾Œç”˜ã€‚",
            "å‰‹æˆ‘": "æ‰¹æ–‡: å®¶é“ä¸­è½ï¼Œæ ¹åŸºå‹•æ–ï¼Œå®¿æ¥­ç‰½çºï¼Œå®ˆæˆä¸æ˜“ï¼Œéœ€é˜²ç¯„ç ´ç”¢ã€‚"
        },
        "æœ‹å‹": {
            "ç”Ÿæˆ‘": "æ‰¹æ–‡: è²´äººç’°ç¹ï¼Œå–„å‹ç›¸æŒºï¼Œäººè„ˆå³æ˜¯ç¦å ±ï¼Œé‡é›£å‘ˆç¥¥ï¼Œå·¦å³é€¢æºã€‚",
            "æ¯”æ—º": "æ‰¹æ–‡: é«˜æœ‹æ»¿åº§ï¼ŒçŸ¥å·±çœ¾å¤šï¼Œç¤¾äº¤åœˆæ´»èºï¼Œäº’åŠ©äº’åˆ©ï¼Œå»£çµå–„ç·£ã€‚",
            "æˆ‘ç”Ÿ": "æ‰¹æ–‡: æ…·æ…¨è§£å›Šï¼Œç†±æƒ…å¥½å®¢ï¼Œé›–æœ‰äººæ°£ä½†è€—è²¡ï¼Œéœ€é˜²æ¿«å¥½äººï¼Œé‡åŠ›è€Œç‚ºã€‚",
            "æˆ‘å‰‹": "æ‰¹æ–‡: æ…é¸å‹ä¼´ï¼Œå¤šç‚ºåˆ©ç›Šä¹‹äº¤ï¼Œéœ€é‹ç”¨æ™ºæ…§åˆ†è¾¨ï¼Œä¸å¯è¼•ä¿¡ã€‚",
            "å‰‹æˆ‘": "æ‰¹æ–‡: èª¤äº¤æå‹ï¼Œæ˜“å—é€£ç´¯ï¼Œå°äººé™·å®³ï¼Œæ­¤ç‚ºé€†å¢ä¸Šç·£ï¼Œéœ€é é›¢æƒ¡çŸ¥è­˜ã€‚"
        },
        "éŒ¢è²¡": {
            "ç”Ÿæˆ‘": "æ‰¹æ–‡: è²¡æºå»£é€²ï¼Œè³‡ç³§å…·è¶³ï¼Œå¾—å¤©æ™‚åœ°åˆ©ï¼Œè¼•é¬†å¾—è²¡ï¼Œå¯Œè²´å¤©æˆã€‚",
            "æ¯”æ—º": "æ‰¹æ–‡: è³‡é‡‘é€šæš¢ï¼Œæ”¶æ”¯å¹³è¡¡ï¼Œè²¡é‹ç©©å®šï¼Œèšæ²™æˆå¡”ï¼Œå°å¯Œç”±å‹¤ã€‚",
            "æˆ‘ç”Ÿ": "æ‰¹æ–‡: å»£ç¨®ç¦ç”°ï¼ŒæŠ•è³‡æ”¯å‡ºï¼ŒèŠ±éŒ¢ä½ˆå±€ï¼Œå…ˆæ¨å¾Œå¾—ï¼Œé æŠ€è¡“è³ºéŒ¢ã€‚",
            "æˆ‘å‰‹": "æ‰¹æ–‡: è¾›è‹¦æ±‚è²¡ï¼ŒéŒ™éŠ–å¿…è¼ƒï¼Œè²¡å¯Œéšªä¸­æ±‚ï¼Œå‹ç¢Œå¥”æ³¢ï¼Œæ¯ä¸€åˆ†çš†è¡€æ±—ã€‚",
            "å‰‹æˆ‘": "æ‰¹æ–‡: è²¡åº«ç ´æ´ï¼Œè³‡é‡‘å‘¨è½‰ä¸éˆï¼Œé˜²è©é¨™èˆ‡åŠ«å¥ªï¼Œå®œä¿å®ˆç†è²¡ï¼Œä½ˆæ–½æ¶ˆç½ã€‚"
        }
    };

    const DEFAULT_STARS = { 'å­': {name:'å¤©è²´', realm:'ä½›é“'}, 'ä¸‘': {name:'å¤©å„', realm:'é¬¼é“'}, 'å¯…': {name:'å¤©æ¬Š', realm:'äººé“'}, 'å¯': {name:'å¤©ç ´', realm:'ç•œé“'}, 'è¾°': {name:'å¤©å¥¸', realm:'ä¿®ç¾…'}, 'å·³': {name:'å¤©æ–‡', realm:'ä»™é“'}, 'åˆ': {name:'å¤©ç¦', realm:'ä½›é“'}, 'æœª': {name:'å¤©é©›', realm:'é¬¼é“'}, 'ç”³': {name:'å¤©å­¤', realm:'äººé“'}, 'é…‰': {name:'å¤©åˆƒ', realm:'ç•œé“'}, 'æˆŒ': {name:'å¤©è—', realm:'ä¿®ç¾…'}, 'äº¥': {name:'å¤©å£½', realm:'ä»™é“'} };
    const ROULETTE_PATH = ['å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥', 'å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°'];
    
    let currentLightIndex=0, globalLastResult=null, globalIsPaused=false, globalSkipAnimation=false, trendChartInstance=null, globalTrendData=null, lastActiveAspect='ç¸½å‘½é‹', aspectClickCounts={};
    let isAnimEnabled = false;
    let chatHistory = [];
    let currentPillarData = null; 

    function setHTML(id, html) { const el = document.getElementById(id); if(el) el.innerHTML = html; }
    function setText(id, text) { const el = document.getElementById(id); if(el) el.innerText = text; }
    function toggleCard(bodyId) { const body = document.getElementById(bodyId); const arrow = body.previousElementSibling.querySelector('.arrow-icon'); if (body.classList.contains('collapsed')) { body.classList.remove('collapsed'); if(arrow) arrow.classList.remove('collapsed'); } else { body.classList.add('collapsed'); if(arrow) arrow.classList.add('collapsed'); } }
    function getRealmColor(realm) { if(realm.includes('ä½›')) return '#ffd700'; if(realm.includes('ä»™')) return '#4fd1c5'; if(realm.includes('ä¿®ç¾…')) return '#ff9f43'; if(realm.includes('é¬¼')) return '#a0aec0'; if(realm.includes('ç•œ')) return '#8c7853'; return '#e0e0e0'; }
    function getStatusColor(relation) { if(relation==='ç”Ÿæˆ‘'||relation==='æ¯”æ—º') return 'var(--status-best)'; if(relation==='æˆ‘ç”Ÿ') return 'var(--status-good)'; if(relation==='æˆ‘å‰‹') return 'var(--status-growth)'; if(relation==='å‰‹æˆ‘') return 'var(--status-bad)'; return '#888'; }
    
    // [V10.5] æˆ°ç•¥å»ºè­°æŸ¥è©¢å‡½æ•¸
    function getStrategicAdvice(aspect, relation, star) { 
        if (PALACE_STRATEGY[aspect] && PALACE_STRATEGY[aspect][relation]) {
            return PALACE_STRATEGY[aspect][relation];
        }
        return `é‹å‹¢ï¼š${relation} | å»ºè­°ï¼šå–„ç”¨${star}ç‰¹æ€§`; 
    }
    
    function toggleAnim(el) { isAnimEnabled = el.checked; }

    function updateFormUI() {
        const scope = document.getElementById('targetScope').value;
        const solarRadio = document.querySelector('input[name="calendarType"][value="solar"]');
        const lunarRadio = document.querySelector('input[name="calendarType"][value="lunar"]');
        if (scope === 'year') { lunarRadio.checked = true; solarRadio.disabled = true; solarRadio.parentElement.style.opacity = '0.5'; } 
        else { solarRadio.disabled = false; solarRadio.parentElement.style.opacity = '1'; }
        const isSolar = document.querySelector('input[name="calendarType"]:checked').value === 'solar';
        const prefix = isSolar ? 'è¥¿å…ƒ' : 'è¾²æ›†';
        document.getElementById('monthInput').className = (scope !== 'year') ? 'input-group show' : 'input-group';
        document.getElementById('dayInput').className = (scope === 'day' || scope === 'hour') ? 'input-group show' : 'input-group';
        document.getElementById('hourInput').className = (scope === 'hour') ? 'input-group show' : 'input-group';
    }

    function initMap() {
        for(let zhi in DEFAULT_STARS) {
            const cell = document.getElementById('cell-'+zhi);
            if(cell) {
                const info = DEFAULT_STARS[zhi];
                const color = getRealmColor(info.realm);
                cell.innerHTML = `<div class="pillar-badges-container"></div><span class="cell-zhi">${zhi}</span><span class="cell-star" style="color:${color}">${info.name}</span><span class="cell-realm" style="color:${color}; opacity:0.7;">${info.realm}</span>`;
                cell.className = 'grid-cell'; cell.style.boxShadow = 'none';
            }
        }
    }

    async function calculate() {
        document.getElementById('loadingOverlay').style.display='flex';
        const data = { 
            gender: parseInt(document.getElementById('gender').value), solar_date: document.getElementById('solarDate').value, hour: document.getElementById('hour').value, 
            target_calendar: document.querySelector('input[name="calendarType"]:checked').value, target_scope: document.getElementById('targetScope').value, 
            target_year: parseInt(document.getElementById('tYear').value)||2026, target_month: parseInt(document.getElementById('tMonth').value)||1, target_day: parseInt(document.getElementById('tDay').value)||1, target_hour: document.getElementById('tHour').value 
        };
        try { 
            const res = await fetch('/api/calculate', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)}); 
            if(!res.ok) throw new Error((await res.json()).detail); 
            globalLastResult = await res.json(); 
            startAnimationSequence(globalLastResult); 
        } catch(e) { alert("âŒ æ’ç›¤å¤±æ•—ï¼š\n"+e.message); document.getElementById('loadingOverlay').style.display='none'; }
    }

    async function startAnimationSequence(result) {
        document.getElementById('loadingOverlay').style.display='none'; 
        document.getElementById('animControls').style.display = isAnimEnabled ? 'flex' : 'none';
        globalSkipAnimation=false; globalIsPaused=false; initMap(); setHTML('pillarsArea','');
        setText('lunarInfo', `| è™›æ­² ${result.age} | ${result.lunar_info}`);
        
        const p = result.base_chart;
        const list = [
            {z:p.å¹´æŸ±.zhi, n:p.å¹´æŸ±.name, c:'var(--p-year)', k:'å¹´', s:p.å¹´æŸ±.slogan, d:p.å¹´æŸ±.desc, pm:p.å¹´æŸ±.poem, key:'å¹´æŸ±'}, 
            {z:p.æœˆæŸ±.zhi, n:p.æœˆæŸ±.name, c:'var(--p-month)', k:'æœˆ', s:p.æœˆæŸ±.slogan, d:p.æœˆæŸ±.desc, pm:p.æœˆæŸ±.poem, key:'æœˆæŸ±'}, 
            {z:p.æ—¥æŸ±.zhi, n:p.æ—¥æŸ±.name, c:'var(--p-day)', k:'æ—¥', s:p.æ—¥æŸ±.slogan, d:p.æ—¥æŸ±.desc, pm:p.æ—¥æŸ±.poem, key:'æ—¥æŸ±'}, 
            {z:p.æ™‚æŸ±.zhi, n:p.æ™‚æŸ±.name, c:'var(--p-hour)', k:'å‘½', s:p.æ™‚æŸ±.slogan, d:p.æ™‚æŸ±.desc, pm:p.æ™‚æŸ±.poem, key:'æ™‚æŸ±'}
        ];
        const isMale = (parseInt(document.getElementById('gender').value)===1);
        
        for(let item of list) { 
            if(globalSkipAnimation) break; 
            if (isAnimEnabled) await runRoulette(item.z, isMale); 
            addBadgeToCell(item.z, item.k, item.c, !isAnimEnabled); 
            const pillarHtml = `
                <div class="pillar-card active" onclick="showPillarModal('${item.key}', '${item.n}', '${item.z}', '${item.s}', '${item.d}', '${item.pm}')" style="border-color:${item.c}">
                    <div class="pillar-header" style="color:${item.c}">${item.key}</div>
                    <div class="pillar-star">${item.n}</div>
                    <div class="pillar-slogan">${item.s}</div>
                    <div class="click-hint">è©³ç´° â–¶</div>
                </div>`;
            document.getElementById('pillarsArea').innerHTML += pillarHtml; 
        }

        const patternArea = document.getElementById('specialPatternsArea');
        patternArea.innerHTML = "";
        if (result.special_patterns && result.special_patterns.length > 0) {
            result.special_patterns.forEach(pt => {
                patternArea.innerHTML += `<div class="pattern-badge" title="${pt.desc}">${pt.name}</div>`;
            });
        }
        renderFullView(result);
    }

    function showPillarModal(title, star, zhi, slogan, desc, poem) {
        currentPillarData = { title, star, zhi, slogan, desc, poem }; 
        setText('modalPillarTitle', title + "è§£æ"); setText('modalPillarZhi', `${zhi}å®® (${star})`); setText('modalPillarSlogan', slogan);
        setText('modalPillarPoem', poem || "ï¼ˆæ­¤æ˜Ÿå®¿æš«ç„¡è©©è¨£ç´€éŒ„ï¼‰"); setText('modalPillarDesc', desc);
        document.getElementById('pillarModal').style.display = 'flex';
    }

    function analyzePillarWithAI() {
        console.log("æ­£åœ¨å•Ÿå‹• AI åˆ†æç¨‹åº...");
        if (!currentPillarData) { alert("âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ç•¶å‰é¸ä¸­çš„æŸ±ä½è³‡æ–™"); return; }
        if (!globalLastResult || !globalLastResult.base_chart) { alert("âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å‘½ç›¤è³‡æ–™ï¼Œè«‹é‡æ–°æ’ç›¤"); return; }

        try {
            document.getElementById('pillarModal').style.display = 'none'; 
            const aiBody = document.getElementById('aiBody');
            if (aiBody) {
                aiBody.classList.remove('collapsed');
                aiBody.scrollIntoView({behavior: "smooth"});
                if (aiBody.previousElementSibling) {
                    const arrow = aiBody.previousElementSibling.querySelector('.arrow-icon');
                    if (arrow) arrow.classList.remove('collapsed');
                }
            }

            const p = globalLastResult.base_chart;
            const getPillarInfo = (key) => p[key] ? `${p[key].name}(${p[key].zhi})` : "æœªçŸ¥";
            const fullChartContext = `å¹´æŸ±:${getPillarInfo('å¹´æŸ±')}, æœˆæŸ±:${getPillarInfo('æœˆæŸ±')}, æ—¥æŸ±:${getPillarInfo('æ—¥æŸ±')}, æ™‚æŸ±:${getPillarInfo('æ™‚æŸ±')}`;

            const prompt = `è«‹ä»¥å°ˆé€šé”æ‘©ä¸€æŒç¶“åŠå…«å­—å‘½ç†ã€å¾å³°è€å¸«ã€çš„å£å»ï¼Œ
åƒè€ƒæ¡ˆä¸»çš„å®Œæ•´å‘½ç›¤æ¶æ§‹ï¼šã€${fullChartContext}ã€‘ï¼Œ
é‡å°ç›®å‰é»é¸çš„ã€${currentPillarData.title}ã€‘é€²è¡Œæ·±åº¦æˆ°ç•¥é»è©•ã€‚

ã€é»é¸ä½ç½®è³‡è¨Šã€‘ï¼š
- æ˜Ÿå®¿ï¼š${currentPillarData.star} (${currentPillarData.zhi}å®®)
- æ ¸å¿ƒç‰¹è³ªï¼š${currentPillarData.slogan || 'ç„¡'}
- å¤ç±è©©è¨£ï¼š${currentPillarData.poem || 'ç„¡'}
- åŸºç¤å®šç¾©ï¼š${currentPillarData.desc || 'ç„¡'}

ã€å›ç­”è¦æ±‚ã€‘ï¼š
1. è«‹å…ˆã€å¼•ç”¨å¤ç±è©©è¨£ã€‘ã€‚
2. å°‡è©©è¨£ç¿»è­¯ç‚ºã€ç¾ä»£ç™½è©±æˆ°ç•¥å»ºè­°ã€‘ã€‚
3. æŒ‡å‡ºè©²ä½ç½®å°æ¡ˆä¸»å½±éŸ¿çš„ã€å„ªå‹¢èˆ‡åŠ£å‹¢ã€‘ã€‚
4. çµåˆå…¨ç›¤æ°£å ´ï¼Œçµ¦å‡ºä¸€å€‹å…·é«”çš„ã€æ”¹é‹å»ºè­°æˆ–æ³¨æ„äº‹é …ã€‘ã€‚`;

            if (typeof sendToAI === 'function') {
                sendToAI(prompt);
            } else {
                alert("âŒ åš´é‡éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° sendToAI å‡½å¼ã€‚");
            }
        } catch (error) {
            alert("âŒ ç¨‹å¼åŸ·è¡Œç™¼ç”Ÿæ„å¤–éŒ¯èª¤ï¼š\n" + error.message);
            console.error(error);
        }
    }

    function runRoulette(targetZhi, isMale) { return new Promise(resolve => { let rounds=0, maxRounds=1, speed=50; const targetIndex = ROULETTE_PATH.indexOf(targetZhi); const step = isMale ? 1 : -1; function nextStep() { if(globalSkipAnimation) { resolve(); return; } if(globalIsPaused) { setTimeout(nextStep, 100); return; } const prev = document.getElementById('cell-'+ROULETTE_PATH[currentLightIndex]); if(prev) prev.classList.remove('roulette-active'); currentLightIndex = (currentLightIndex + step + 12) % 12; const curr = document.getElementById('cell-'+ROULETTE_PATH[currentLightIndex]); if(curr) curr.classList.add('roulette-active'); if(rounds>=maxRounds && currentLightIndex===targetIndex) { if(curr) curr.classList.add('flash-stop'); setTimeout(()=>{ if(curr){curr.classList.remove('roulette-active'); curr.classList.remove('flash-stop');} resolve(); }, 800); return; } if(currentLightIndex===0) rounds++; if(rounds>=maxRounds) speed+=30; setTimeout(nextStep, speed); } nextStep(); }); }
    function togglePause() { globalIsPaused = !globalIsPaused; }
    function skipToComplete() { if(globalLastResult) { globalSkipAnimation=true; renderFullView(globalLastResult); } }
    function replayAnimation() { if(globalLastResult) startAnimationSequence(globalLastResult); }
    function addBadgeToCell(zhi, text, color, instant) { const cell = document.getElementById('cell-'+zhi); if(cell) { cell.classList.add('active'); const c = cell.querySelector('.pillar-badges-container'); if(c && !Array.from(c.children).some(e=>e.innerText===text)) { const b = document.createElement('span'); b.className='pillar-badge'; b.style.background=color; b.innerText=text; c.appendChild(b); if(instant) b.classList.add('show'); else setTimeout(()=>b.classList.add('show'),50); } } }

    function renderFullView(result) {
        initMap();
        const h = result.hierarchy;
        const pillars = [ { k:'å¹´', c:'var(--p-year)', z:result.base_chart.å¹´æŸ±.zhi, n:result.base_chart.å¹´æŸ±.name }, { k:'æœˆ', c:'var(--p-month)', z:result.base_chart.æœˆæŸ±.zhi, n:result.base_chart.æœˆæŸ±.name }, { k:'æ—¥', c:'var(--p-day)', z:result.base_chart.æ—¥æŸ±.zhi, n:result.base_chart.æ—¥æŸ±.name }, { k:'å‘½', c:'var(--p-hour)', z:result.base_chart.æ™‚æŸ±.zhi, n:result.base_chart.æ™‚æŸ±.name } ];
        pillars.forEach(p => { addBadgeToCell(p.z, p.k, p.c, true); });
        if(h.big_luck) addBadgeToCell(h.big_luck.zhi, 'å¤§é‹', 'var(--p-luck)', true);
        if(h.year) addBadgeToCell(h.year.zhi, 'æµå¹´', 'var(--p-year)', true);
        if(['month','day','hour'].includes(document.getElementById('targetScope').value) && h.month) addBadgeToCell(h.month.zhi, 'æµæœˆ', 'var(--p-month)', true);
        if(['day','hour'].includes(document.getElementById('targetScope').value) && h.day) addBadgeToCell(h.day.zhi, 'æµæ—¥', 'var(--p-day)', true);
        if(document.getElementById('targetScope').value==='hour' && h.hour) addBadgeToCell(h.hour.zhi, 'æµæ™‚', 'var(--p-hour)', true);
        
        result.aspects.forEach(a => {
            const cell = document.getElementById('cell-'+a.zhi);
            if(cell && !cell.querySelector('.cell-aspect-name')) {
                cell.innerHTML += `<div class="cell-aspect-name show-content">${a.name}</div><div class="cell-relation-tag" style="background:${getStatusColor(a.relation)}; color:#1a2634;">${a.relation}</div>`;
                if(a.is_alert) cell.classList.add('alert');
            }
        });
        fillLists(result, h);
    }

    function fillLists(result, h) {
        if (result.trend_data) globalTrendData = result.trend_data;
        let hHtml = `<div class="hierarchy-step"><span class="step-label">å¤§é‹</span><span class="step-value">${result.hierarchy.big_luck.zhi}å®® ${result.hierarchy.big_luck.name}</span></div>`;
        hHtml += `<div class="hierarchy-step"><span class="step-label">æµå¹´</span><span class="step-value">${result.hierarchy.year.zhi}å®® ${result.hierarchy.year.name}</span></div>`;
        if(result.hierarchy.month) hHtml += `<div class="hierarchy-step"><span class="step-label">æµæœˆ</span><span class="step-value">${result.hierarchy.month.zhi}å®® ${result.hierarchy.month.name}</span></div>`;
        setHTML('hierarchyArea', hHtml);

        let aHtml = '';
        let dataIndex = result.trend_data.target_index; 
        if (dataIndex === -1 && globalTrendData.axis_labels.length > 0) dataIndex = Math.floor(globalTrendData.axis_labels.length / 2);

        result.aspects.forEach(a => {
            let score = 50; 
            let trendHtml = '<span class="trend-icon flat" style="color:#666; font-size:0.8em;">â¡</span>'; 
            if (dataIndex !== -1 && globalTrendData && globalTrendData.datasets[a.name]) {
                const baseScores = globalTrendData.datasets[a.name];
                const adjustments = globalTrendData.adjustments[a.name] || [];
                const renheScores = globalTrendData.renhe_scores || [];
                const useGrade = document.getElementById('gradeCheckbox').checked;
                const useRenhe = document.getElementById('renheCheckbox').checked;
                const calculateTotal = (idx) => {
                    let s = baseScores[idx];
                    if (useGrade) s += (adjustments[idx] || 0);
                    if (useRenhe) s += (renheScores[idx] ? renheScores[idx].score : 0);
                    return Math.max(5, Math.min(95, s));
                };
                score = calculateTotal(dataIndex);
                let compareIndex = -1;
                let isLookingForward = true;
                if (dataIndex < baseScores.length - 1) { compareIndex = dataIndex + 1; } else if (dataIndex > 0) { compareIndex = dataIndex - 1; isLookingForward = false; }
                if (compareIndex !== -1) {
                    let nextScore = calculateTotal(compareIndex);
                    let diff = nextScore - score;
                    if (!isLookingForward) diff = score - nextScore;
                    if (diff >= 20) trendHtml = '<span class="trend-icon up" style="color:#ff4d4d; font-weight:900;">â†—â†—â†—</span>';
                    else if (diff >= 10) trendHtml = '<span class="trend-icon up" style="color:#ff6b6b; font-weight:bold;">â†—â†—</span>';
                    else if (diff >= 3) trendHtml = '<span class="trend-icon up" style="color:#ff8787;">â†—</span>';
                    else if (diff <= -20) trendHtml = '<span class="trend-icon down" style="color:#4fd1c5; font-weight:900;">â†˜â†˜â†˜</span>';
                    else if (diff <= -10) trendHtml = '<span class="trend-icon down" style="color:#81e6d9; font-weight:bold;">â†˜â†˜</span>';
                    else if (diff <= -3) trendHtml = '<span class="trend-icon down" style="color:#b2f5ea;">â†˜</span>';
                }
            }
            let barColor = score>=80?'var(--status-best)':(score>=60?'var(--status-good)':'var(--status-bad)');
            let compHtml = '';
            if(dataIndex !== -1 && globalTrendData) {
                let extra = 0;
                if(document.getElementById('gradeCheckbox').checked) extra += (globalTrendData.adjustments[a.name][dataIndex]||0);
                if(document.getElementById('renheCheckbox').checked && globalTrendData.renhe_scores[dataIndex]) extra += (globalTrendData.renhe_scores[dataIndex].score||0);
                if (extra !== 0) compHtml = `<span class="score-composition">(${score-extra}<span class="${extra>0?'score-bonus':'score-penalty'}">${extra>0?'+':''}${extra}</span>)</span>`;
            }
            aHtml += `
            <div id="row-${a.name}" class="aspect-row clickable" onclick="updateTrendChart('${a.name}')">
                <div style="width:115px;">
                    <div style="display:flex;align-items:center;">
                        <span style="color:var(--cyan);font-weight:bold;font-size:1em;">${a.name}</span>
                        <span style="margin-left:6px; font-family:monospace;">${trendHtml}</span>
                    </div>
                    <div style="font-size:0.75em;color:#888; margin-top:2px;">${a.zhi}|<b style="color:#ddd;">${a.star}</b></div>
                </div>
                <div style="flex:1;padding:0 5px;"><div style="display:flex;align-items:center;"><div style="width:70px;text-align:right;font-weight:bold;color:${barColor};">${score} ${compHtml}</div><div class="progress-container"><div class="progress-bar" style="width:${score}%;background:${barColor};"></div></div></div><div class="aspect-advice" style="font-size:0.8em;opacity:0.8;">${getStrategicAdvice(a.name, a.relation, a.star)}</div></div>
                <div style="display:flex;align-items:center;gap:5px;"><div class="aspect-tag" style="background:${getStatusColor(a.relation)};font-size:0.7em;">${a.relation}</div><button class="mini-ai-btn" onclick="event.stopPropagation();lastActiveAspect='${a.name}';callAIWithMode('script')">ğŸ“œ</button></div>
            </div>`;
        });
        setHTML('aspectsList', aHtml);
        if(globalTrendData) updateTrendChart('ç¸½å‘½é‹');
    }

    function renderTrendChart(labels, scores, tooltips, title) {
        const headerContainer = document.getElementById('trendHeaderContainer');
        if (!headerContainer) { console.error("æ‰¾ä¸åˆ° trendHeaderContainer"); return; }

        const hudDisplay = (globalLastResult && globalLastResult.dual_info) ? 'flex' : 'none';
        const solarVal = (globalLastResult && globalLastResult.dual_info) ? globalLastResult.dual_info.solar : '-';
        const lunarVal = (globalLastResult && globalLastResult.dual_info) ? globalLastResult.dual_info.lunar : '-';

        try {
            headerContainer.innerHTML = `
                <span style="white-space:nowrap;">é‹å‹¢èƒ½é‡èµ°å‹¢åœ– <span style="font-size:0.7em; color:var(--cyan);">(${title})</span></span>
                <div id="headerTimeInfo" class="hud-container" style="display:${hudDisplay};">
                    <div class="hud-capsule solar"><span class="hud-label solar-bg">åœ‹</span><span class="hud-value">${solarVal}</span></div>
                    <span class="hud-transfer-icon">â‡„</span>
                    <div class="hud-capsule lunar"><span class="hud-label lunar-bg">è¾²</span><span class="hud-value">${lunarVal}</span></div>
                </div>
                <span class="arrow-icon" style="margin-left:10px;">â–¼</span>
            `;
        } catch (e) { console.error("æ¨™é¡Œæ›´æ–°å¤±æ•—", e); }

        try {
            const canvas = document.getElementById('trendChart');
            if (!canvas) throw new Error("æ‰¾ä¸åˆ° Canvas å…ƒç´ ");
            const ctx = canvas.getContext('2d');
            if (trendChartInstance) trendChartInstance.destroy();

            const gradient = ctx.createLinearGradient(0, 0, 0, 250);
            gradient.addColorStop(0, 'rgba(212, 175, 55, 0.5)'); 
            gradient.addColorStop(1, 'rgba(212, 175, 55, 0)');
            
            const radarPulsePlugin = {
                id: 'radarPulse',
                afterDatasetsDraw(chart, args, options) {
                    const { ctx, data } = chart;
                    const activeIndex = globalTrendData.target_index; 
                    if (activeIndex === -1 || activeIndex === undefined) return;
                    const meta = chart.getDatasetMeta(0);
                    if (!meta.data[activeIndex]) return; 
                    const x = meta.data[activeIndex].x;
                    const y = meta.data[activeIndex].y;
                    ctx.save(); ctx.beginPath(); ctx.arc(x, y, 15, 0, 2 * Math.PI); ctx.fillStyle = 'rgba(255, 77, 77, 0.3)'; ctx.fill(); ctx.restore();
                    ctx.save(); ctx.beginPath(); ctx.arc(x, y, 22, 0, 2 * Math.PI); ctx.strokeStyle = 'rgba(255, 77, 77, 0.6)'; ctx.lineWidth = 1; ctx.setLineDash([2, 4]); ctx.stroke(); ctx.restore();
                }
            };

            const pointColors = labels.map((l, i) => i === globalTrendData.target_index ? '#ff4d4d' : '#fff');
            const pointRadii = labels.map((l, i) => i === globalTrendData.target_index ? 8 : 4);

            trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'é‹å‹¢èƒ½é‡', data: scores, borderColor: '#d4af37', backgroundColor: gradient, borderWidth: 3, pointBackgroundColor: pointColors, pointRadius: pointRadii, pointHoverRadius: 10, fill: true, tension: 0.4 }] },
                options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, min: 0, grid: {color:'#333'}, ticks: {color:'#888'} }, x: { grid: {color:'#333'}, ticks: {color:'#888', autoSkip: false, maxRotation: 0} } }, plugins: { legend: {display:false}, tooltip: { callbacks: { title: i=>Array.isArray(i[0].label)?i[0].label.join(" "):i[0].label, afterLabel: ctx=>tooltips[ctx.dataIndex] }, backgroundColor: 'rgba(0,0,0,0.9)', titleColor: '#d4af37' } } },
                plugins: [radarPulsePlugin] 
            });
        } catch (error) { console.error("Chart.js ç¹ªåœ–å¤±æ•—:", error); headerContainer.innerHTML += ` <span style="color:red; font-size:0.7em;">(âš ï¸ ç¹ªåœ–å¤±æ•—)</span>`; }
    }

    function updateTrendChart(aspectName) {
        if (!globalTrendData) { console.warn("updateTrendChart: globalTrendData ç‚ºç©º"); return; }
        if (!globalTrendData.datasets[aspectName]) { console.warn(`updateTrendChart: æ‰¾ä¸åˆ° ${aspectName} çš„æ•¸æ“š`); return; }

        lastActiveAspect = aspectName;
        if (!aspectClickCounts[aspectName]) aspectClickCounts[aspectName] = 0; aspectClickCounts[aspectName]++;
        
        const useGrade = document.getElementById('gradeCheckbox').checked;
        const useRenhe = document.getElementById('renheCheckbox').checked;
        const baseScores = globalTrendData.datasets[aspectName];
        const adjustments = globalTrendData.adjustments[aspectName] || [];
        const renheScores = globalTrendData.renhe_scores || [];

        const finalScores = baseScores.map((score, i) => {
            let s = score;
            if (useGrade) s += (adjustments[i] || 0);
            if (useRenhe && renheScores[i]) s += (renheScores[i].score || 0);
            return Math.max(5, Math.min(95, s));
        });

        let titleSuffix = "";
        if (useGrade) titleSuffix += " +å®®ä½";
        if (useRenhe) titleSuffix += " +äººå’Œ";

        renderTrendChart(globalTrendData.axis_labels, finalScores, globalTrendData.tooltips[aspectName], aspectName + titleSuffix);
        document.querySelectorAll('.aspect-row').forEach(row => row.classList.remove('active-aspect'));
        const activeRow = document.getElementById(`row-${aspectName}`);
        if(activeRow) activeRow.classList.add('active-aspect');
    }

    async function sendToAI(message) {
        if (!globalLastResult) { alert("è«‹å…ˆé€²è¡Œæ’ç›¤"); return; }
        if (!message) return;
        addChatBubble(message, 'user'); document.getElementById('userChatInput').value = '';
        const loadingId = addChatBubble("æ™ºå›Šæ¨æ¼”ä¸­...", 'ai', true);
        const scoreIndex = globalTrendData.target_index || 0;
        const contextData = { age: globalLastResult.age, target_display: globalLastResult.target_display, special_patterns: globalLastResult.special_patterns || [], aspects: globalLastResult.aspects.map(a => { const score = globalTrendData.datasets[a.name][scoreIndex]; return `${a.name}: ${a.star} (${a.relation}, ${score}åˆ†)`; }) };
        try {
            const res = await fetch('/api/ask_ai', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ message: message, history: chatHistory, context_data: contextData }) });
            const data = await res.json();
            document.getElementById(loadingId).remove();
            addChatBubble(data.reply, 'ai');
            chatHistory.push({"role": "user", "content": message}); chatHistory.push({"role": "assistant", "content": data.reply});
        } catch (e) { document.getElementById(loadingId).innerText = "é€£ç·šéŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚"; }
    }

    function manualSend() { const input = document.getElementById('userChatInput'); sendToAI(input.value); }
    function addChatBubble(text, role, isLoading=false) {
        const win = document.getElementById('chatWindow');
        const div = document.createElement('div');
        div.className = `chat-message ${role} ${isLoading ? 'typing-indicator' : ''}`;
        div.innerText = text; div.id = 'msg-' + Date.now();
        win.appendChild(div); win.scrollTop = win.scrollHeight;
        return div.id;
    }

    async function exportToImage() {
        if (!globalLastResult || !trendChartInstance) { alert("è«‹å…ˆæ’ç›¤"); return; }
        document.getElementById('loadingOverlay').style.display = 'flex';

        const clientName = document.getElementById('crmName').value || 'è²´è³“';
        const targetYear = document.getElementById('tYear').value;
        const scope = document.getElementById('targetScope').value;
        const scopeMap = {'year':'æµå¹´','month':'æµæœˆ','day':'æµæ—¥','hour':'æµæ™‚'};
        const clientInfo = `å§“å: ${clientName} | ç”Ÿè¾°: ${document.getElementById('solarDate').value} ${document.getElementById('hour').value}æ™‚ | æ€§åˆ¥: ${document.getElementById('gender').value==1?'ç”·':'å¥³'} | é æ¸¬: ${targetYear}å¹´`;
        setText('exportInfo', clientInfo);

        const mapHtml = document.getElementById('mainMap').innerHTML;
        const exportMap = document.getElementById('exportMapContainer');
        exportMap.innerHTML = mapHtml;
        exportMap.className = 'twelve-palaces-map';
        exportMap.querySelectorAll('.grid-cell').forEach(cell => { cell.classList.remove('roulette-active'); cell.style.boxShadow = 'none'; });

        const p = globalLastResult.base_chart;
        const pillars = [
            {k:'å¹´æŸ±', n:p.å¹´æŸ±.name, s:p.å¹´æŸ±.slogan, c:'var(--p-year)'},
            {k:'æœˆæŸ±', n:p.æœˆæŸ±.name, s:p.æœˆæŸ±.slogan, c:'var(--p-month)'},
            {k:'æ—¥æŸ±', n:p.æ—¥æŸ±.name, s:p.æ—¥æŸ±.slogan, c:'var(--p-day)'},
            {k:'æ™‚æŸ±', n:p.æ™‚æŸ±.name, s:p.æ™‚æŸ±.slogan, c:'var(--p-hour)'}
        ];
        let pillarsHtml = "";
        pillars.forEach(item => {
            pillarsHtml += `<div class="export-pillar-item" style="border-color:${item.c}">
                <div class="export-p-head" style="color:${item.c}">${item.k}</div>
                <div class="export-p-star">${item.n}</div>
                <div class="export-p-slogan">${item.s}</div>
            </div>`;
        });
        setHTML('exportPillarsContainer', pillarsHtml);

        const listHtml = document.getElementById('aspectsList').innerHTML;
        const exportList = document.getElementById('exportAspectList');
        exportList.innerHTML = listHtml;
        exportList.querySelectorAll('button').forEach(btn => btn.remove());
        exportList.querySelectorAll('.aspect-row').forEach(row => { row.style.borderBottom = '1px solid #444'; row.style.padding = '8px 0'; row.style.background = 'transparent'; });

        setText('exportChartTitle', `ã€${lastActiveAspect}ã€‘é‹å‹¢èƒ½é‡èµ°å‹¢`);
        const chartBase64 = trendChartInstance.toBase64Image();
        document.getElementById('exportChartImg').src = chartBase64;

        if (globalTrendData && globalTrendData.datasets[lastActiveAspect]) {
            const scores = globalTrendData.datasets[lastActiveAspect];
            let maxS = -1, minS = 101, maxYear = "", minYear = "";
            scores.forEach((s, i) => {
                const lbl = Array.isArray(globalTrendData.axis_labels[i]) ? globalTrendData.axis_labels[i][0] : globalTrendData.axis_labels[i];
                if (s > maxS) { maxS = s; maxYear = lbl; }
                if (s < minS) { minS = s; minYear = lbl; }
            });
            
            const highlightsHTML = `
                <ul style="margin:0; padding-left:20px;">
                    <li style="margin-bottom:8px;"><span style="color:#ffd700;">â˜… é‹å‹¢é«˜é»ï¼š</span> ${maxYear} (èƒ½é‡æŒ‡æ•¸: ${maxS}) - é©åˆé€²æ”»ã€æ“´å¼µã€‚</li>
                    <li style="margin-bottom:8px;"><span style="color:#ff4d4d;">âš ï¸ é‹å‹¢ä½é»ï¼š</span> ${minYear} (èƒ½é‡æŒ‡æ•¸: ${minS}) - å»ºè­°å®ˆæˆã€é¿éšªã€‚</li>
                    <li><span style="color:#4fd1c5;">ğŸ’¡ æˆ°ç•¥å»ºè­°ï¼š</span> è«‹åƒè€ƒä¸Šæ–¹æ³¢å½¢åœ–ï¼Œåœ¨ç´…ç‡ˆå€(ä½åˆ†)å‰é å…ˆå„²å‚™ç³§è‰ï¼Œåœ¨é‡‘ç‡ˆå€(é«˜åˆ†)å…¨åŠ›è¡åˆºã€‚</li>
                </ul>
            `;
            setHTML('exportHighlights', highlightsHTML);
        }

        setTimeout(() => {
            const container = document.getElementById('exportContainer');
            html2canvas(container, { scale: 2, backgroundColor: "#101015", useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                const safeDate = document.getElementById('solarDate').value;
                const safeScope = scopeMap[scope] || scope;
                link.download = `é”æ‘©æˆ°ç•¥_${clientName}_${safeDate}_${safeScope}(${targetYear}).jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
                document.getElementById('loadingOverlay').style.display = 'none';
            }).catch(err => {
                console.error("æˆªåœ–å¤±æ•—:", err);
                alert("æˆªåœ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤è¨Šæ¯");
                document.getElementById('loadingOverlay').style.display = 'none';
            });
        }, 800);
    }

    function openSaveModal() { document.getElementById('saveModal').style.display = 'flex'; openAiNote(); }
    function closeSaveModal() { document.getElementById('saveModal').style.display = 'none'; }
    function toggleTag(el) { el.classList.toggle('selected'); }
    function openAiNote() { const t = document.getElementById('aiResponseArea') ? document.getElementById('aiResponseArea').innerText : ''; document.getElementById('crmAiContent').value = (t.includes('è«‹é»æ“Š')?'':t); }
    
    async function confirmSave() {
        const selectedTags = Array.from(document.querySelectorAll('#tagList .tag-chip.selected'))
                                  .map(chip => chip.innerText);

        const data = {
            solar_date: document.getElementById('solarDate').value,
            gender: parseInt(document.getElementById('gender').value),
            hour: document.getElementById('hour').value,
            target_year: parseInt(document.getElementById('tYear').value),
            client_name: document.getElementById('crmName').value,
            phone: document.getElementById('crmPhone').value,
            note: document.getElementById('crmNote').value,
            tags: selectedTags, 
            ai_log: {
                saved_content: document.getElementById('crmAiContent').value,
                click_heatmap: aspectClickCounts || {} 
            }
        };

        try {
            const res = await fetch('/api/save_record', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();
            
            if(result.status === 'success') {
                alert("âœ… è«®è©¢ç´€éŒ„å·²å®Œæ•´å„²å­˜ (å«æ¨™ç±¤èˆ‡ç†±é»)");
                closeSaveModal();
            } else {
                alert("âŒ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬„ä½");
            }
        } catch(e) {
            alert("âŒ ç³»çµ±éŒ¯èª¤ï¼š" + e.message);
            console.error(e);
        }
    }

    async function loadHistory() { window.location.href = '/crm'; }
    function restoreFromHistory(item) { document.getElementById('solarDate').value = item.solar_date; document.getElementById('gender').value = item.gender; document.getElementById('hour').value = item.hour; document.getElementById('tYear').value = item.target_year || 2026; document.getElementById('tMonth').value = 1; document.getElementById('tDay').value = 1; document.getElementById('targetScope').value = 'year'; updateFormUI(); alert(`å·²è¼‰å…¥ï¼š${item.client_name}\n(è‡ªå‹•åˆ‡æ›ç‚ºæµå¹´æ¨¡å¼)`); setTimeout(() => calculate(), 200); }
    async // [V10.6 ä¿®å¾©ç‰ˆ] è®“æŒ‰éˆ•çœŸçš„æœƒèªªè©±
    function callAIWithMode(mode) {
        if (!globalLastResult || !lastActiveAspect) { alert("è«‹å…ˆæ’ç›¤ä¸¦é¸æ“‡å®®ä½"); return; }
        
        // 1. å–å¾—ç•¶å‰å®®ä½çš„é—œä¿‚ (ç”Ÿæˆ‘/å‰‹æˆ‘)
        const aspectData = globalLastResult.aspects.find(a => a.name === lastActiveAspect);
        const relation = aspectData ? aspectData.relation : "æœªçŸ¥";
        const star = aspectData ? aspectData.star : "æœªçŸ¥";
        
        // 2. æ§‹å»ºæˆ°ç•¥æŒ‡ä»¤ (å¼•ç”¨æ–°çš„ç¦ªæ©Ÿæ‰¹æ–‡)
        const prompt = `è«‹ä»¥å¾å³°è€å¸«çš„æˆ°ç•¥é¡§å•èº«åˆ†ï¼Œé‡å°æ¡ˆä¸»çš„ã€${lastActiveAspect}å®®ã€‘é€²è¡Œæ·±åº¦è§£æã€‚
        
        ã€ç•¶å‰åƒæ•¸ã€‘ï¼š
        - æ˜Ÿå®¿ï¼š${star}
        - é—œä¿‚ï¼š${relation} (è«‹è§£é‡‹é€™ä»£è¡¨ä»€éº¼èƒ½é‡äº’å‹•)
        - æ‰¹æ–‡åƒè€ƒï¼š${getStrategicAdvice(lastActiveAspect, relation, star)}
        
        ã€å›ç­”è¦æ±‚ã€‘ï¼š
        1. ç”¨ç™½è©±æ–‡è§£é‡‹é€™å€‹å®®ä½ç›®å‰çš„å‰å‡¶è¶¨å‹¢ã€‚
        2. çµ¦å‡º 3 å€‹å…·é«”çš„è¡Œå‹•å»ºè­°ï¼ˆAction Planï¼‰ã€‚
        3. èªæ°£è¦å°ˆæ¥­ã€è‚¯å®šï¼Œå¸¶æœ‰æˆ°ç•¥æŒ‡å°çš„é«˜åº¦ã€‚`;

        // 3. ç™¼é€çµ¦ AI
        sendToAI(prompt);
    }
    function getInteractionDetails(guestEl, score) { let icon = "", desc = ""; if (score >= 80) { icon = `<span style="color:#888;">å®¢(${guestEl})</span> <span style="color:var(--status-best); font-weight:bold;">æ»‹é¤Šâ</span> <span style="color:#fff;">æˆ‘(ä¸»)</span>`; desc = "é‹æ°£å¥½ï¼šæ­¤å®®ä½çš„äººäº‹ç‰©ä¾†æˆå°±æˆ‘"; } else if (score >= 75) { icon = `<span style="color:#888;">å®¢(${guestEl})</span> <span style="color:var(--status-good); font-weight:bold;">å¹«æ‰¶ï¼</span> <span style="color:#fff;">æˆ‘(ä¸»)</span>`; desc = "é‹æ°£å¹³é †ï¼šæ­¤å®®ä½èˆ‡æˆ‘åŒå¿ƒå”åŠ›"; } else if (score >= 60) { icon = `<span style="color:#fff;">æˆ‘(ä¸»)</span> <span style="color:#aaa;">æ´©æ°£â</span> <span style="color:#888;">å®¢(${guestEl})</span>`; desc = "å¹³é‹(åŠæ ¼)ï¼šæˆ‘åœ¨æ»‹é¤Šé€™å€‹å®®ä½ï¼Œæ‰è¯å±•ç¾"; } else if (score >= 35) { icon = `<span style="color:#fff;">æˆ‘(ä¸»)</span> <span style="color:#d69e2e;">å£“åˆ¶âš”ï¸</span> <span style="color:#888;">å®¢(${guestEl})</span>`; desc = "é©šæ¿¤é§­æµªï¼šæˆ‘è¦å»å¥®é¬¥ã€æŒæ§å±€é¢"; } else { icon = `<span style="color:#888;">å®¢(${guestEl})</span> <span style="color:var(--status-bad);">æŠ˜ç£¨âš”ï¸</span> <span style="color:#fff;">æˆ‘(ä¸»)</span>`; desc = "æœ‰ç½é›£ï¼šæ­¤å®®ä½çš„äººäº‹ç‰©ä¾†æ”»æ“Šæˆ‘"; } return { icon, desc }; }
    function openAuditModal() { if (!globalLastResult || !globalTrendData) { alert("è«‹å…ˆæ’ç›¤"); return; } const modal = document.getElementById('auditModal'); const contentDiv = modal.querySelector('.modal-content'); contentDiv.style.cssText = `background-color: #1e2732; border: 1px solid var(--gold); border-radius: 8px; width: 95%; max-width: 900px; max-height: 85vh; display: flex; flex-direction: column; padding: 0; box-shadow: 0 0 50px rgba(0,0,0,0.9);`; const currentYear = document.getElementById('tYear').value; const headerHTML = `<div style="padding:15px 20px; border-bottom:1px solid #444; display:flex; justify-content:space-between; align-items:center; flex-shrink:0; background:#151b24; border-radius:8px 8px 0 0;"><h3 style="margin:0; color:var(--gold);">ğŸ“Š æˆ°ç•¥ç®—åˆ†ç¨½æ ¸è¡¨ (å¹´ä»½: <span id="auditYear">${currentYear}</span>)</h3><button onclick="document.getElementById('auditModal').style.display='none'" style="background:none; border:none; color:#888; font-size:1.5em; cursor:pointer;">Ã—</button></div>`; const bodyStartHTML = `<div style="padding:20px; overflow-y:auto; flex:1;"><div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:6px; margin-bottom:15px; font-size:0.9em; color:#ccc; line-height:1.6;"><strong style="color:var(--gold);">ğŸ’¡ é”æ‘©ä¸€æŒç¶“ãƒ»æ ¸å¿ƒé‚è¼¯ (ä¸»å®¢å°èª¿ç‰ˆ)</strong><br><ul style="margin:5px 0 0 20px; padding:0; color:#aaa;"><li><strong>ä¸»è§’ (æˆ‘/Host)ï¼š</strong>æµå¹´ç¸½å‘½é‹ (ç•¶å¹´çš„æœ¬å‘½èƒ½é‡)ã€‚</li><li><strong>å®¢äºº (ä»–/Guest)ï¼š</strong>å„å€‹å®®ä½ (äº‹æ¥­ã€å¥åº·ã€è²¡é‹...)ã€‚</li><li><strong>å‰å‡¶åˆ¤æ–·ï¼š</strong>çœ‹ã€Œå®¢äººã€å°ã€Œæˆ‘ã€åšäº†ä»€éº¼ï¼Ÿ(å®¢ç”Ÿæˆ‘=å‰ï¼Œå®¢å‰‹æˆ‘=å‡¶)ã€‚</li><li><strong>åˆ†æ•¸ç¯„åœï¼š</strong>80(ç”Ÿæˆ‘), 75(æ¯”æ—º), 60(æˆ‘ç”Ÿ), 35(æˆ‘å‰‹), 20(å‰‹æˆ‘)ã€‚</li></ul></div><div style="overflow-x:auto;"><table style="width:100%; border-collapse: collapse; font-size:0.9em; color:#ddd;"><thead style="background:#252f3a; color:var(--cyan);"><tr><th style="padding:10px; text-align:left;">å®¢ (å®®ä½)</th><th style="padding:10px; text-align:left;">äº’å‹•é—œä¿‚ (å®¢ vs æˆ‘)</th><th style="padding:10px; text-align:right; color:#bbb;">é‹æ°£(L1)</th><th style="padding:10px; text-align:right; color:#bbb;">å®®ä½(L2)</th><th style="padding:10px; text-align:right; color:#bbb;">äººå’Œ(L3)</th><th style="padding:10px; text-align:right; border-left:1px solid #444; color:var(--gold);">åŸå§‹</th><th style="padding:10px; text-align:right; color:var(--cyan);">æœ€çµ‚</th></tr></thead><tbody id="auditTableBody">`; let rowsHTML = ''; let dataIndex = -1; if (globalTrendData.target_index !== undefined) { dataIndex = globalTrendData.target_index; } else if (globalTrendData.axis_labels.length > 0) { dataIndex = Math.floor(globalTrendData.axis_labels.length/2); } if (dataIndex === -1) { rowsHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">ç„¡æ³•å–å¾—æ­¤å¹´ä»½æ•¸æ“š</td></tr>'; } else { const renheObj = globalTrendData.renhe_scores[dataIndex]; const renheScore = renheObj ? renheObj.score : 0; const renheStar = renheObj ? renheObj.star : "-"; globalLastResult.aspects.forEach(aspect => { const name = aspect.name; const baseScore = globalTrendData.datasets[name][dataIndex]; const gradeAndRoot = globalTrendData.adjustments[name][dataIndex]; const rawSum = baseScore + gradeAndRoot + renheScore; const finalScore = Math.max(5, Math.min(95, rawSum)); const details = getInteractionDetails(aspect.element, baseScore); let gradeColor = gradeAndRoot > 0 ? '#ffd700' : (gradeAndRoot < 0 ? '#ff4d4d' : '#666'); let renheColor = renheScore > 0 ? '#4fd1c5' : (renheScore < 0 ? '#ff4d4d' : '#666'); rowsHTML += `<tr style="border-bottom:1px solid #333;"><td style="padding:10px;"><div style="font-weight:bold; color:var(--cyan);">${name}</div><div style="font-size:0.8em; color:#888;">${aspect.zhi}å®® ${aspect.star}</div></td><td style="padding:10px; font-family:monospace; font-size:0.9em;">${details.icon}<br><span style="color:#aaa; font-size:0.8em;">${details.desc}</span></td><td style="padding:10px; text-align:right; font-family:monospace; color:#bbb; font-size:1.1em;">${baseScore}</td><td style="padding:10px; text-align:right; font-family:monospace; color:${gradeColor}; font-size:0.9em;">${gradeAndRoot>0?'+'+gradeAndRoot:gradeAndRoot}</td><td style="padding:10px; text-align:right; font-family:monospace; color:${renheColor}; font-size:0.9em;">${renheScore>0?'+'+renheScore:renheScore}<br><span style="font-size:0.7em; color:#888;">(${renheStar})</span></td><td style="padding:10px; text-align:right; border-left:1px solid #444; color:#ddd; font-family:monospace; font-size:1.1em;">${rawSum}</td><td style="padding:10px; text-align:right;"><div style="background:${finalScore>=80?'var(--status-best)':(finalScore<=40?'var(--status-bad)':'#444')}; color:#1a2634; padding:2px 8px; border-radius:4px; font-weight:bold;">${finalScore}</div></td></tr>`; }); } const bodyEndHTML = `</tbody></table></div></div>`; contentDiv.innerHTML = headerHTML + bodyStartHTML + rowsHTML + bodyEndHTML; modal.style.display = 'flex'; }

    updateFormUI(); initMap();
    // [V10.7 ä¿®å¾©] å¼·åˆ¶ç›£è½é é¢é¡¯ç¤ºäº‹ä»¶ï¼Œè§£æ±ºå¿«å–å•é¡Œ
    function checkAndRestore() {
        console.log("Checking for restore data...");
        const restoreDataStr = localStorage.getItem('damo_restore_data');
        if (restoreDataStr) {
            try {
                const item = JSON.parse(restoreDataStr);
                console.log("Restoring:", item);
                restoreFromHistory(item);
                localStorage.removeItem('damo_restore_data'); // è®€å–å¾Œæ¸…é™¤ï¼Œé¿å…é‡è¤‡
            } catch(e) {
                console.error("Restore failed:", e);
                localStorage.removeItem('damo_restore_data'); // å£æª”ä¹Ÿæ¸…é™¤
            }
        }
    }

    updateFormUI(); initMap();
    
    // åŒæ™‚ç¶å®š onload å’Œ pageshowï¼Œé›™é‡ä¿éšª
    window.onload = checkAndRestore;
    window.onpageshow = function(event) {
        if (event.persisted) {
            // å¦‚æœæ˜¯å¾å¿«å–è¼‰å…¥ (BFCache)ï¼Œå¼·åˆ¶å†æª¢æŸ¥ä¸€æ¬¡
            checkAndRestore();
        }
    };
</script>
</body>
</html>


